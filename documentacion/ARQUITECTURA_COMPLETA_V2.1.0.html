<!DOCTYPE html>
<html>
<head>
<title>Documentaci√≥n TFG FP DAM - √Ångel Fern√°ndez Vidal</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<meta name="version" content="2.1.0">
<meta name="last-updated" content="2025-11-17">
<meta name="author" content="√Ångel Fern√°ndez Vidal">
<meta name="project" content="TFG FP DAM - Sistema Academia Chat-Driven">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.version-badge {
	background-color: #4CAF50;
	color: white;
	padding: 4px 12px;
	border-radius: 12px;
	font-size: 12px;
	font-weight: bold;
	display: inline-block;
	margin-left: 10px;
}

.update-note {
	background-color: #FFF9C4;
	border-left: 4px solid #FBC02D;
	padding: 12px;
	margin: 16px 0;
	border-radius: 4px;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="documentacion-tfg-fp-dam">Documentaci√≥n TFG FP DAM - √Ångel Fern√°ndez Vidal</h1>
<h2 id="arquitectura-completa---sistema-academia-chat-driven">Sistema Academia Chat-Driven <span class="version-badge">v2.1.0</span></h2>

<div class="update-note">
<strong>üìÖ Actualizaci√≥n v2.1.0 - Noviembre 2025</strong><br/>
Este documento incluye las √∫ltimas mejoras implementadas en el sistema:
<ul>
<li>‚úÖ Modelo de datos actualizado con nuevos campos en Academia e Inscripcion</li>
<li>‚úÖ Arquitectura de Tool Calling iterativo (hasta 10 llamadas)</li>
<li>‚úÖ Nuevos endpoints y par√°metros de query avanzados</li>
<li>‚úÖ Optimizaciones de performance (academia_id en Inscripcion con triggers)</li>
<li>‚úÖ Restricciones de negocio actualizadas (tipo 'Ausencia' v√≠a pasar-lista)</li>
<li>‚úÖ Actualizaci√≥n de tecnolog√≠as (Spring Boot 3.5.5, Java 21, GPT-4o)</li>
</ul>
</div>
<h2 id="%C3%ADndice">√çndice</h2>
<ol>
<li><a href="#1-visi%C3%B3n-general">Visi√≥n General</a></li>
<li><a href="#2-diagrama-de-arquitectura-general-simplificado">Diagrama de Arquitectura General (Simplificado)</a></li>
<li><a href="#3-diagrama-de-seguridad-jwt---token-delegado">Diagrama de Seguridad JWT - Token Delegado</a></li>
<li><a href="#4-modelo-de-datos---base-de-datos-mysql">Modelo de Datos - Base de Datos MySQL</a></li>
<li><a href="#5-contrato-de-respuesta-del-chat">Contrato de Respuesta del Chat</a></li>
<li><a href="#6-tabla-de-endpoints-y-seguridad">Tabla de Endpoints y Seguridad</a></li>
<li><a href="#7-flujo-completo-caso-de-uso-real">Flujo Completo: Caso de Uso Real</a></li>
<li><a href="#8-ventajas-de-la-arquitectura">Ventajas de la Arquitectura</a></li>
<li><a href="#9-tecnolog%C3%ADas-utilizadas">Tecnolog√≠as Utilizadas</a></li>
<li><a href="#10-testing-y-calidad">Testing y Calidad</a></li>
<li><a href="#11-plan-de-despliegue-en-producci%C3%B3n">Plan de Despliegue en Producci√≥n</a></li>
<li><a href="#12-an%C3%A1lisis-econ%C3%B3mico-del-proyecto">An√°lisis Econ√≥mico del Proyecto</a></li>
</ol>
<hr>
<h2 id="1-visi%C3%B3n-general">1. Visi√≥n General</h2>
<p>El sistema <strong>Academia Chat-Driven</strong> es una plataforma educativa que utiliza inteligencia artificial conversacional como √∫nica interfaz de usuario. La arquitectura se basa en tres pilares fundamentales:</p>
<h3 id="componentes-principales">Componentes Principales</h3>
<p><strong>Cliente M√≥vil (Android)</strong></p>
<ul>
<li>Aplicaci√≥n Kotlin con Jetpack Compose</li>
<li>√önica pantalla (ChatScreen) para toda la interacci√≥n</li>
<li>Sistema de navegaci√≥n mediante contexto conversacional</li>
<li>Soporte para modo Mock (desarrollo) y Real (producci√≥n)</li>
</ul>
<p><strong>Backend Chat (Orquestador)</strong></p>
<ul>
<li>Servidor Spring Boot (Java 21) que act√∫a como intermediario</li>
<li>Gesti√≥n de autenticaci√≥n JWT para usuarios</li>
<li>Integraci√≥n con OpenAI GPT-4 para procesamiento de lenguaje natural</li>
<li>Orquestaci√≥n de llamadas a herramientas (tool calling)</li>
<li>Estructuraci√≥n de respuestas seg√∫n contrato Envelope</li>
<li><strong>Reenv√≠a el JWT del usuario a API Workers</strong> (concepto de &quot;token delegado&quot;)</li>
</ul>
<p><strong>API Workers (Python/Flask)</strong></p>
<ul>
<li>API REST con l√≥gica de negocio</li>
<li>Autenticaci√≥n mediante JWT (el mismo del usuario)</li>
<li>Acceso directo a base de datos MySQL</li>
<li>Endpoints para gesti√≥n acad√©mica completa</li>
<li>Validaci√≥n de permisos a nivel de negocio</li>
<li><strong>Despliegue:</strong> AWS Elastic Beanstalk</li>
</ul>
<p><strong>Base de Datos (MySQL 8.0)</strong></p>
<ul>
<li>Modelo relacional normalizado</li>
<li>Sistema de auditor√≠a con timestamps</li>
<li>Seguridad mediante prepared statements</li>
<li><strong>Conexiones:</strong>
<ul>
<li><strong>Desarrollo:</strong> <code>mysql://user:pass@localhost:3307/api_workers</code></li>
<li><strong>Producci√≥n:</strong> AWS RDS MySQL 8.0 (connection string en variable de entorno)</li>
</ul>
</li>
</ul>
<h3 id="concepto-clave-token-delegado">Concepto Clave: Token Delegado</h3>
<p><strong>¬øQu√© es el Token Delegado?</strong></p>
<p>El &quot;token delegado&quot; es el <strong>mismo JWT del usuario</strong> que viaja sin modificaci√≥n desde Android hasta MySQL, pasando por Backend Chat y API Workers. No es un token diferente, sino una <strong>delegaci√≥n de la identidad del usuario</strong> a trav√©s de todas las capas del sistema.</p>
<p><strong>Flujo del Token Delegado:</strong></p>
<pre class="hljs"><code><div>Usuario login ‚Üí JWT generado (API Workers)
  ‚Üì
Android guarda JWT
  ‚Üì
Backend Chat recibe JWT (valida claims)
  ‚Üì
Backend Chat REENV√çA el MISMO JWT a API Workers
  ‚Üì
API Workers valida el MISMO JWT
  ‚Üì
MySQL registra usuarioId del JWT en auditor√≠a
</div></code></pre>
<p><strong>Ventajas del Token Delegado:</strong></p>
<ol>
<li><strong>Trazabilidad Completa:</strong> Cada acci√≥n en cada capa est√° asociada al mismo <code>usuarioId</code></li>
<li><strong>Simplicidad:</strong> Un √∫nico secret compartido entre Backend Chat y API Workers</li>
<li><strong>Multi-tenancy Autom√°tico:</strong> El <code>academiaId</code> del JWT filtra datos en todas las capas</li>
<li><strong>Sin Conversi√≥n de Credenciales:</strong> No hay transformaci√≥n de tokens (menor superficie de ataque)</li>
<li><strong>Logs Correlacionables:</strong> Los logs distribuidos se pueden correlacionar por <code>usuarioId</code></li>
</ol>
<p><strong>Contraste con API-Key (NO usado):</strong></p>
<ul>
<li>API-Key autentica el <strong>servicio</strong> (Backend Chat como cliente)</li>
<li>JWT autentica al <strong>usuario</strong> (persona que usa la app)</li>
<li>En nuestro sistema, ambos backends est√°n bajo el mismo control ‚Üí solo necesitamos JWT</li>
</ul>
<hr>
<h2 id="2-diagrama-de-arquitectura-general-simplificado">2. Diagrama de Arquitectura General (Simplificado)</h2>
<p>Vista de alto nivel con los 4 componentes principales:</p>
<pre><code class="language-mermaid"><div class="mermaid">graph LR
    subgraph "CLIENTE"
        A[Android App<br/>Kotlin + Compose]
    end

    subgraph "ORQUESTADOR"
        B[Backend Chat<br/>Spring Boot + Java 21<br/>+ OpenAI GPT-4]
    end

    subgraph "L√ìGICA DE NEGOCIO"
        C[API Workers<br/>Python + Flask]
    end

    subgraph "DATOS"
        D[(MySQL 8.0<br/>AWS RDS)]
    end

    A -->|JWT usuario| B
    B -->|MISMO JWT<br/>token delegado| C
    C -->|Queries SQL| D

    style A fill:#e8f5e9
    style B fill:#fff3e0
    style C fill:#fce4ec
    style D fill:#f3e5f5
</div></code></pre>
<p><strong>Despliegue en Producci√≥n:</strong></p>
<ul>
<li><strong>Android:</strong> Google Play Store</li>
<li><strong>Backend Chat:</strong> AWS Elastic Beanstalk (Single Instance + Let's Encrypt HTTPS)</li>
<li><strong>API Workers:</strong> AWS Elastic Beanstalk (Python/Flask + MySQL driver)</li>
<li><strong>MySQL:</strong> AWS RDS MySQL 8.0 (Multi-AZ para alta disponibilidad)</li>
</ul>
<p><strong>Protocolos:</strong></p>
<ul>
<li>Android ‚Üî Backend Chat: HTTPS/TLS 1.3 (puerto 443)</li>
<li>Backend Chat ‚Üî OpenAI: HTTPS (API oficial)</li>
<li>Backend Chat ‚Üî API Workers: HTTPS/TLS 1.3</li>
<li>API Workers ‚Üî MySQL: MySQL Protocol sobre TLS</li>
</ul>
<hr>
<h2 id="3-diagrama-de-seguridad-jwt---token-delegado">3. Diagrama de Seguridad JWT - Token Delegado</h2>
<h3 id="arquitectura-de-seguridad-jwt-%C3%BAnico-token-delegado">Arquitectura de Seguridad: JWT √önico (Token Delegado)</h3>
<p><strong>Principio clave:</strong> Un √∫nico JWT viaja de punta a punta (Android ‚Üí Backend Chat ‚Üí API Workers)</p>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    participant U as Usuario
    participant A as Android App
    participant AC as AuthRepository
    participant API as API Workers /auth
    participant Chat as Backend Chat
    participant OpenAI as OpenAI GPT-4
    participant APIRes as API Workers /recursos
    participant DB as MySQL

    rect rgb(230, 245, 255)
        Note over U,DB: FASE 1: AUTENTICACI√ìN Y LOGIN
    end
    
    U->>A: Ingresa email y password
    A->>AC: login(email, password)
    AC->>API: POST /auth/login
    Note right of API: Sin autenticaci√≥n<br/>(endpoint p√∫blico)
    API->>DB: SELECT * FROM Usuario WHERE email = ?
    DB-->>API: Usuario encontrado
    API->>API: Verifica hash de password (bcrypt)
    API->>API: Genera JWT (exp: 15 min)<br/>Claims: { usuarioId, academiaId, role }<br/>Genera Refresh Token (exp: 30 d√≠as)
    API->>DB: INSERT INTO RefreshToken
    API-->>AC: 200 OK<br/>{ jwt, refreshToken, user: { name, role, academiaId } }
    AC->>A: Almacena en SessionStore (DataStore)
    A-->>U: Redirige a ChatScreen

    rect rgb(255, 245, 230)
        Note over U,DB: FASE 2: CHAT CON TOOL CALLING
    end
    
    U->>A: Escribe: "Mu√©strame mis clases de hoy"
    A->>Chat: POST /chat/send<br/>Headers: { Authorization: Bearer JWT_ABC123 }
    Chat->>Chat: Middleware valida JWT<br/>jwt.verify(token, SECRET_KEY)
    Chat->>Chat: Extrae claims del JWT:<br/>{ usuarioId: 12, academiaId: 5, role: "Profesor_academia" }
    Chat->>OpenAI: POST /v1/chat/completions<br/>Body: { messages, tools: served-openapi.json }
    Note right of OpenAI: Primer ciclo:<br/>Analiza intenci√≥n del usuario
    OpenAI-->>Chat: ToolCall Required:<br/>{ name: "GET /sesiones", params: { fecha: "hoy", profesor_id: 12 } }
    
    rect rgb(255, 240, 245)
        Note over Chat,DB: Backend Chat REENV√çA EL MISMO JWT
    end
    
    Chat->>APIRes: GET /sesiones?fecha=2025-10-23&profesor_id=12<br/>Headers: { Authorization: Bearer JWT_ABC123 }
    Note right of APIRes: EL MISMO JWT del usuario<br/>NO hay API-Key
    APIRes->>APIRes: Middleware valida JWT<br/>jwt.verify(token, SECRET_KEY)
    APIRes->>APIRes: Extrae claims: { usuarioId: 12, academiaId: 5 }
    APIRes->>APIRes: Valida permisos seg√∫n role
    APIRes->>DB: SELECT s.*, h.*, c.* FROM Sesion s<br/>JOIN HorarioCurso h ON s.horario_curso_id = h.id<br/>JOIN Curso c ON h.curso_id = c.id<br/>WHERE DATE(s.timestamp_alta) = ?<br/>AND s.curso_profesor_id IN<br/>(SELECT id FROM Curso_Profesores WHERE usuario_id = ?)<br/>AND c.academia_id = 5
    Note right of DB: Filtrado autom√°tico<br/>por academiaId del JWT
    DB-->>APIRes: Resultados (3 sesiones)
    APIRes-->>Chat: 200 OK<br/>{ data: [...sesiones] }
    
    Chat->>OpenAI: POST /v1/chat/completions<br/>Body: { messages: [...previous, tool_result] }
    Note right of OpenAI: Segundo ciclo:<br/>Genera respuesta natural
    OpenAI-->>Chat: { message: "Tus clases de hoy...", function_call: null }
    Chat->>Chat: Estructura respuesta como Envelope:<br/>{ message, data: { type, items }, uiSuggestions, pagination }
    Chat-->>A: 200 OK - Envelope GenericItem
    A->>A: Actualiza UI con StateFlow
    A-->>U: Muestra tarjetas de clases + sugerencias

    rect rgb(240, 255, 240)
        Note over U,DB: FASE 3: RENOVACI√ìN DE TOKEN (JWT expirado)
    end
    
    U->>A: Env√≠a nuevo mensaje (JWT expirado)
    A->>Chat: POST /chat/send<br/>Headers: { Authorization: Bearer EXPIRED_JWT }
    Chat->>Chat: Middleware detecta token expirado
    Chat-->>A: 401 Unauthorized<br/>{ error: "Token expired" }
    A->>AC: AuthRepository.refreshToken()
    AC->>API: POST /auth/refresh<br/>Body: { refreshToken }
    API->>DB: SELECT * FROM RefreshToken WHERE token_hash = ?<br/>AND expires_at > NOW() AND revoked_at IS NULL
    DB-->>API: RefreshToken v√°lido
    API->>API: Genera nuevo JWT (exp: 15 min)<br/>Genera nuevo Refresh Token (rotaci√≥n)
    API->>DB: UPDATE RefreshToken SET revoked_at = NOW(), replaced_by_id = ?<br/>INSERT INTO RefreshToken (nuevo token)
    API-->>AC: 200 OK<br/>{ jwt, refreshToken }
    AC->>A: Actualiza SessionStore
    A->>Chat: Reintenta POST /chat/send con nuevo JWT
    Chat-->>A: 200 OK - Respuesta exitosa
</div></code></pre>
<h3 id="por-qu%C3%A9-no-usamos-api-key">Por Qu√© NO Usamos API-Key</h3>
<p><strong>Ventajas de JWT √önico:</strong></p>
<ol>
<li><strong>Simplicidad:</strong> Una sola clave en todo el sistema</li>
<li><strong>Trazabilidad:</strong> Sabemos qu√© usuario hizo cada acci√≥n en cada capa</li>
<li><strong>Multi-tenancy autom√°tico:</strong> El JWT lleva <code>academiaId</code>, filtra datos autom√°ticamente</li>
<li><strong>Menos superficie de ataque:</strong> No hay que rotar API-Keys</li>
<li><strong>Control total:</strong> Ambos backends est√°n bajo nuestro control</li>
</ol>
<p><strong>Cu√°ndo S√ç usar API-Key:</strong></p>
<ul>
<li>Cuando terceros necesitan acceder a tu API sin usuarios (ej: Moodle, Google Classroom)</li>
<li>Cuando el servicio que llama no tiene acceso al JWT del usuario</li>
<li>Cuando quieres autenticar el <strong>servicio</strong> (no el usuario)</li>
</ul>
<p><strong>En nuestro caso:</strong></p>
<ul>
<li>Backend Chat y API Workers est√°n bajo el mismo control</li>
<li>Backend Chat siempre tiene el JWT del usuario</li>
<li>M√°s simple = m√°s seguro</li>
</ul>
<h3 id="capas-de-seguridad-implementadas">Capas de Seguridad Implementadas</h3>
<p><strong>Capa 1: Transporte</strong></p>
<ul>
<li>HTTPS obligatorio en todas las comunicaciones</li>
<li>TLS 1.3 para cifrado end-to-end</li>
<li>Certificados SSL/TLS v√°lidos</li>
</ul>
<p><strong>Capa 2: Autenticaci√≥n de Usuario (JWT en 3 puntos)</strong></p>
<ul>
<li><strong>Android ‚Üí Backend Chat:</strong> JWT con firma HMAC-SHA256</li>
<li><strong>Backend Chat ‚Üí API Workers:</strong> EL MISMO JWT reenviado</li>
<li><strong>API Workers ‚Üí MySQL:</strong> Extrae claims del JWT para filtrar datos</li>
</ul>
<p>Claims del JWT:</p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"usuarioId"</span>: <span class="hljs-number">12</span>,
  <span class="hljs-attr">"academiaId"</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">"role"</span>: <span class="hljs-string">"Profesor_academia"</span>,
  <span class="hljs-attr">"email"</span>: <span class="hljs-string">"maria@academia.com"</span>,
  <span class="hljs-attr">"iat"</span>: <span class="hljs-number">1698073000</span>,
  <span class="hljs-attr">"exp"</span>: <span class="hljs-number">1698073900</span>
}
</div></code></pre>
<p><strong>Capa 3: Autorizaci√≥n a Nivel de Negocio</strong></p>
<ul>
<li>Validaci√≥n de permisos seg√∫n rol (Admin_plataforma, Admin_academia, Profesor_academia)</li>
<li>Filtrado de datos por academiaId (multi-tenancy)</li>
<li>Solo acceso a recursos propios (profesor solo ve sus clases)</li>
</ul>
<p><strong>Capa 4: Base de Datos</strong></p>
<ul>
<li>Prepared Statements para prevenir SQL Injection</li>
<li>Usuario de BD con permisos limitados (no DROP, no ALTER)</li>
<li>Conexiones cifradas (SSL/TLS)</li>
<li>Auditor√≠a con timestamps (fecha_alta, fecha_ultima_modificacion)</li>
</ul>
<p><strong>Capa 5: Rate Limiting y Anti-Abuse</strong></p>
<ul>
<li>L√≠mite de 100 requests/minuto por usuario en Backend Chat</li>
<li>L√≠mite de 1000 requests/minuto por IP en API Workers</li>
<li>Bloqueo temporal tras 5 intentos fallidos de login (locked_until en Usuario)</li>
<li>Captcha tras 3 intentos fallidos (futuro)</li>
</ul>
<hr>
<h2 id="4-modelo-de-datos---base-de-datos-mysql">4. Modelo de Datos - Base de Datos MySQL</h2>
<h3 id="cadenas-de-conexi%C3%B3n">Cadenas de Conexi√≥n</h3>
<p><strong>Desarrollo (Local):</strong></p>
<pre class="hljs"><code><div>mysql://root:password@localhost:3307/api_workers
Charset: utf8mb4
Collation: utf8mb4_unicode_ci
</div></code></pre>
<p><strong>Producci√≥n (AWS RDS):</strong></p>
<pre class="hljs"><code><div>mysql://admin:${RDS_PASSWORD}@academia-db.abc123.us-east-1.rds.amazonaws.com:3306/api_workers
SSL: Required (TLS 1.3)
Multi-AZ: Enabled
Backups: Daily automated (retention 7 days)
</div></code></pre>
<h3 id="tablas-de-la-base-de-datos">Tablas de la Base de Datos</h3>
<div class="update-note">
<strong>üîÑ Actualizado en v2.1.0:</strong> A√±adidos nuevos campos a Academia e Inscripcion, triggers de validaci√≥n.
</div>

<p>La base de datos contiene <strong>20 tablas</strong> organizadas en m√≥dulos funcionales. Fuente: <code>create_database.sql</code></p>
<h4 id="m%C3%B3dulo-core-academia-y-configuraci%C3%B3n">M√≥dulo Core (Academia y Configuraci√≥n)</h4>
<table>
<thead>
<tr>
<th>Tabla</th>
<th>Descripci√≥n</th>
<th>Campos Clave</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Academia</code> ‚≠ê</td>
<td>Entidades/empresas del sistema (multi-tenancy)</td>
<td>id, nombre, <strong>direccion, telefono, nombre_contacto, email_contacto, descripcion</strong>, fecha_alta, fecha_baja</td>
</tr>
<tr>
<td><code>Tarifa</code></td>
<td>Planes de precios por academia</td>
<td>id, academia_id, precio_base, descripcion</td>
</tr>
<tr>
<td><code>Descuentos_tarifa</code></td>
<td>Descuentos aplicables (familiar, prorrateado)</td>
<td>id, tarifa_id, motivo_descuento, tipo_descuento, porcentaje</td>
</tr>
<tr>
<td><code>Aula</code></td>
<td>Espacios f√≠sicos para impartir clases</td>
<td>id, academia_id, nombre, capacidad_maxima</td>
</tr>
</tbody>
</table>

<p><strong>‚≠ê Campos a√±adidos en v2.1.0:</strong></p>
<ul>
<li><code>direccion</code> VARCHAR(255) NULL - Direcci√≥n f√≠sica de la academia</li>
<li><code>telefono</code> VARCHAR(20) NULL - Tel√©fono de contacto</li>
<li><code>nombre_contacto</code> VARCHAR(100) NULL - Persona de contacto principal</li>
<li><code>email_contacto</code> VARCHAR(100) NULL - Email de contacto</li>
<li><code>descripcion</code> TEXT NULL - Descripci√≥n de la academia y servicios ofrecidos</li>
</ul>

<h4 id="m%C3%B3dulo-de-usuarios-y-seguridad">M√≥dulo de Usuarios y Seguridad</h4>
<table>
<thead>
<tr>
<th>Tabla</th>
<th>Descripci√≥n</th>
<th>Campos Clave</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Rol_Usuario</code></td>
<td>Roles del sistema (3 roles)</td>
<td>id, nombre (Admin_plataforma, Admin_academia, Profesor_academia)</td>
</tr>
<tr>
<td><code>Usuario</code></td>
<td>Usuarios del sistema (profesores, admins)</td>
<td>id, academia_id, email, password (Argon2), rol_id, estado, token_version</td>
</tr>
<tr>
<td><code>UserLoginLog</code></td>
<td>Historial de logins/logouts</td>
<td>id, usuario_id, login_at, logout_at, success, ip, user_agent</td>
</tr>
<tr>
<td><code>RefreshToken</code></td>
<td>Tokens de refresco (rotaci√≥n)</td>
<td>id, usuario_id, token_hash, expires_at, revoked_at, replaced_by_id</td>
</tr>
<tr>
<td><code>PasswordResetToken</code></td>
<td>Tokens para recuperaci√≥n de contrase√±a</td>
<td>id, usuario_id, token_hash, expires_at, used_at</td>
</tr>
</tbody>
</table>
<h4 id="m%C3%B3dulo-acad%C3%A9mico-cursos-y-horarios">M√≥dulo Acad√©mico (Cursos y Horarios)</h4>
<table>
<thead>
<tr>
<th>Tabla</th>
<th>Descripci√≥n</th>
<th>Campos Clave</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Curso</code></td>
<td>Cursos acad√©micos</td>
<td>id, academia_id, nombre, anio_academico, fecha_inicio, fecha_fin, capacidad_maxima, tarifa_id, tipo_alumno, estado</td>
</tr>
<tr>
<td><code>HorarioCurso</code></td>
<td>Horarios semanales de cada curso</td>
<td>id, curso_id, aula_id, dia_semana, hora_inicio, hora_fin</td>
</tr>
<tr>
<td><code>Curso_Profesores</code></td>
<td>Asignaci√≥n de profesores a cursos</td>
<td>id, curso_id, usuario_id, fecha_alta, fecha_baja</td>
</tr>
<tr>
<td><code>Sesion</code></td>
<td>Clases concretas (instancias de horarios)</td>
<td>id, horario_curso_id, aula_id, curso_profesor_id, timestamp_alta, timestamp_baja, notas_sesion, notas_materia</td>
</tr>
</tbody>
</table>
<h4 id="m%C3%B3dulo-de-alumnos">M√≥dulo de Alumnos</h4>
<table>
<thead>
<tr>
<th>Tabla</th>
<th>Descripci√≥n</th>
<th>Campos Clave</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Alumno</code></td>
<td>Datos personales de alumnos</td>
<td>id, academia_id, nombre, email, dni, telefono, fecha_nacimiento, direccion, nombre_tutor, telefono_tutor</td>
</tr>
<tr>
<td><code>Inscripcion</code> ‚≠ê</td>
<td>Matr√≠culas de alumnos en cursos</td>
<td>id, <strong>academia_id</strong>, alumno_id, curso_id, fecha_inicio, fecha_fin, motivo_baja</td>
</tr>
<tr>
<td><code>familias_alumnos</code></td>
<td>Relaciones familiares entre alumnos</td>
<td>id_familia_alumno, id_alumno1, id_alumno2, relacion_familiar</td>
</tr>
<tr>
<td><code>AnotacionesAlumnoSesion</code></td>
<td>Registro de asistencia, evaluaciones y comportamiento</td>
<td>id, sesion_id, inscripcion_id, alumno_id, tipo_anotacion (Ausencia, Evaluacion, Comportamiento), texto</td>
</tr>
</tbody>
</table>

<p><strong>‚≠ê Optimizaci√≥n de Performance a√±adida en v2.1.0:</strong></p>
<p>Se agreg√≥ el campo <code>academia_id</code> INT NOT NULL a la tabla <code>Inscripcion</code> con:</p>
<ul>
<li><strong>Prop√≥sito:</strong> Evitar JOINs al filtrar inscripciones por academia (mejora 50%+ en queries)</li>
<li><strong>√çndice:</strong> <code>idx_inscripcion_academia</code> para b√∫squedas r√°pidas</li>
<li><strong>Foreign Key:</strong> <code>fk_inscripcion_academia</code> ‚Üí <code>Academia(id)</code></li>
<li><strong>Validaci√≥n:</strong> 2 triggers MySQL garantizan consistencia:
<ul>
<li><code>trg_inscripcion_academia_check_insert</code> - Valida que alumno y curso pertenecen a la misma academia</li>
<li><code>trg_inscripcion_academia_check_update</code> - Valida cambios en academia_id, alumno_id o curso_id</li>
</ul>
</li>
<li><strong>Auto-poblaci√≥n:</strong> El campo se calcula autom√°ticamente desde <code>alumno.academia_id</code></li>
</ul>

<p><strong>Nota de Arquitectura:</strong> Esta denormalizaci√≥n controlada prioriza performance sobre normalizaci√≥n estricta, cr√≠tica en aplicaciones multi-academia con alto volumen de queries de filtrado.</p>

<h4 id="m%C3%B3dulo-financiero">M√≥dulo Financiero</h4>
<table>
<thead>
<tr>
<th>Tabla</th>
<th>Descripci√≥n</th>
<th>Campos Clave</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Extractos</code></td>
<td>Estados de cuenta mensuales por alumno</td>
<td>id, inscripcion_id, numero_extracto, fecha_ini_periodo, fecha_fin_periodo, importe_cuota, total_descuentos, total_importe_a_cobrar, estado_liquidacion_extracto</td>
</tr>
<tr>
<td><code>Movimientos_Extracto</code></td>
<td>Ingresos y anulaciones de pago</td>
<td>id, extracto_id, fecha_movimiento, tipo_movimiento (Ingreso, Anulacion_Ingreso), importe, metodo_pago, estado_liquidacion_movimiento</td>
</tr>
</tbody>
</table>
<h4 id="m%C3%B3dulo-de-automatizaci%C3%B3n-futuro">M√≥dulo de Automatizaci√≥n (Futuro)</h4>
<table>
<thead>
<tr>
<th>Tabla</th>
<th>Descripci√≥n</th>
<th>Campos Clave</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TrabajadorVirtual</code></td>
<td>Agentes IA para automatizaci√≥n</td>
<td>id, academia_id, nombre, foto, descripcion, apikey, es_administrativo_virtual</td>
</tr>
</tbody>
</table>
<h3 id="diagrama-erd-simplificado">Diagrama ERD Simplificado (Actualizado v2.1.0)</h3>
<pre class="hljs"><code><div>Academia (1) ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ&gt; (*) Curso
               ‚îú‚îÄ‚îÄ&gt; (*) Aula
               ‚îú‚îÄ‚îÄ&gt; (*) Usuario
               ‚îú‚îÄ‚îÄ&gt; (*) Alumno
               ‚îú‚îÄ‚îÄ&gt; (*) Tarifa
               ‚îî‚îÄ‚îÄ&gt; (*) Inscripcion ‚≠ê [NUEVO: FK directa para performance]

Usuario (1) ‚îÄ‚îÄ&gt; (*) Curso_Profesores ‚îÄ‚îÄ&gt; (1) Curso

Curso (1) ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ&gt; (*) HorarioCurso
            ‚îú‚îÄ‚îÄ&gt; (*) Inscripcion
            ‚îî‚îÄ‚îÄ&gt; (1) Tarifa

Inscripcion ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ&gt; (1) Academia ‚≠ê [NUEVO]
              ‚îú‚îÄ‚îÄ&gt; (1) Alumno
              ‚îî‚îÄ‚îÄ&gt; (1) Curso

HorarioCurso (1) ‚îÄ‚îÄ&gt; (*) Sesion

Inscripcion (1) ‚îÄ‚îÄ&gt; (*) AnotacionesAlumnoSesion
                ‚îî‚îÄ‚îÄ&gt; (*) Extractos

Extractos (1) ‚îÄ‚îÄ&gt; (*) Movimientos_Extracto
</div></code></pre>

<p><strong>‚≠ê Cambios en ERD v2.1.0:</strong></p>
<ul>
<li>Inscripcion ahora tiene FK directa a Academia (campo <code>academia_id</code>) para optimizaci√≥n de queries</li>
<li>Curso mantiene FK a Tarifa (precio base del curso)</li>
<li><strong>Simplificaci√≥n:</strong> Se elimin√≥ <code>tarifa_id</code> de Inscripcion - la tarifa se obtiene del Curso</li>
<li>Descuentos personalizados (becas, prorrateados) se manejan en la tabla Extractos mediante campos de descuento</li>
</ul>

<hr>
<h2 id="5-contrato-de-respuesta-del-chat">5. Contrato de Respuesta del Chat</h2>
<h3 id="estructura-del-envelope">Estructura del Envelope</h3>
<p>Todas las respuestas del Backend Chat siguen un contrato estandarizado llamado <strong>Envelope</strong>, que permite renderizar cualquier tipo de informaci√≥n de manera consistente en la UI.</p>
<pre><code class="language-mermaid"><div class="mermaid">classDiagram
    class Envelope {
        +String message
        +Data data
        +List~Suggestion~ uiSuggestions
        +Pagination pagination
        +Metadata metadata
    }

    class Data {
        +String type
        +List~GenericItem~ items
        +Map~String,Any~ summary
    }

    class GenericItem {
        +String id
        +String type
        +String titulo
        +Map~String,Any~ campos
        +List~Action~ actions
    }

    class Suggestion {
        +String id
        +String label
        +String message
        +SuggestionType type
        +Map~String,Any~ context
    }

    class Action {
        +String id
        +String label
        +String endpoint
        +String method
        +Map~String,Any~ params
    }

    class Pagination {
        +Int currentPage
        +Int totalPages
        +Int totalItems
        +Int itemsPerPage
        +String nextPageToken
        +Boolean hasNextPage
        +Boolean hasPreviousPage
    }

    class Metadata {
        +String conversationId
        +String timestamp
        +String model
        +Int tokensUsed
        +Float responseTime
        +String version
    }

    Envelope "1" --> "1" Data : contains
    Envelope "1" --> "*" Suggestion : contains
    Envelope "1" --> "0..1" Pagination : contains
    Envelope "1" --> "1" Metadata : contains
    Data "1" --> "*" GenericItem : contains
    GenericItem "1" --> "*" Action : contains
</div></code></pre>
<h3 id="tipos-de-datos-soportados">Tipos de Datos Soportados</h3>
<table>
<thead>
<tr>
<th>Tipo</th>
<th>Descripci√≥n</th>
<th>Ejemplo de Uso</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sesiones_dia</code></td>
<td>Lista de sesiones/clases de un d√≠a espec√≠fico</td>
<td>&quot;Mis clases de hoy&quot;</td>
</tr>
<tr>
<td><code>sesiones_semana</code></td>
<td>Vista semanal de sesiones</td>
<td>&quot;Ver toda la semana&quot;</td>
</tr>
<tr>
<td><code>alumnos</code></td>
<td>Lista de alumnos</td>
<td>&quot;Alumnos del curso Matem√°ticas 1¬∫ ESO&quot;</td>
</tr>
<tr>
<td><code>alumnos_lista</code></td>
<td>Lista de asistencia con checkboxes</td>
<td>&quot;Ver alumnos de la clase de 11:00&quot;</td>
</tr>
<tr>
<td><code>cursos</code></td>
<td>Lista de cursos</td>
<td>&quot;Mis cursos activos&quot;</td>
</tr>
<tr>
<td><code>anotaciones</code></td>
<td>Lista de anotaciones</td>
<td>&quot;√öltimas anotaciones&quot;</td>
</tr>
<tr>
<td><code>detalle_sesion</code></td>
<td>Detalle completo de una sesi√≥n</td>
<td>&quot;Ver detalle de la clase de las 08:00&quot;</td>
</tr>
<tr>
<td><code>detalle_alumno</code></td>
<td>Ficha completa de un alumno</td>
<td>&quot;Ver expediente de Juan P√©rez&quot;</td>
</tr>
<tr>
<td><code>extractos</code></td>
<td>Estados de cuenta</td>
<td>&quot;Extractos pendientes de pago&quot;</td>
</tr>
<tr>
<td><code>usuarios</code></td>
<td>Lista de usuarios del sistema</td>
<td>&quot;Listar usuarios&quot;</td>
</tr>
<tr>
<td><code>academias</code></td>
<td>Lista de academias (solo Admin_plataforma)</td>
<td>&quot;Ver todas las academias&quot;</td>
</tr>
<tr>
<td><code>generic_table</code></td>
<td>Tabla gen√©rica (fallback)</td>
<td>Cualquier otro dato tabular</td>
</tr>
</tbody>
</table>
<h3 id="ejemplo-de-respuesta-lista-de-alumnos">Ejemplo de Respuesta: Lista de Alumnos</h3>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"message"</span>: <span class="hljs-string">"Aqu√≠ est√°n los alumnos del curso Matem√°ticas 1¬∫ ESO (25 alumnos inscritos)."</span>,
  <span class="hljs-attr">"data"</span>: {
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"alumnos"</span>,
    <span class="hljs-attr">"items"</span>: [
      {
        <span class="hljs-attr">"id"</span>: <span class="hljs-string">"12"</span>,
        <span class="hljs-attr">"type"</span>: <span class="hljs-string">"alumno"</span>,
        <span class="hljs-attr">"titulo"</span>: <span class="hljs-string">"Juan P√©rez Garc√≠a"</span>,
        <span class="hljs-attr">"campos"</span>: {
          <span class="hljs-attr">"email"</span>: <span class="hljs-string">"juan.perez@estudiante.com"</span>,
          <span class="hljs-attr">"telefono"</span>: <span class="hljs-string">"612345678"</span>,
          <span class="hljs-attr">"fecha_nacimiento"</span>: <span class="hljs-string">"2010-05-15"</span>,
          <span class="hljs-attr">"dni"</span>: <span class="hljs-string">"12345678A"</span>,
          <span class="hljs-attr">"estado_inscripcion"</span>: <span class="hljs-string">"Activo"</span>,
          <span class="hljs-attr">"fecha_inicio_curso"</span>: <span class="hljs-string">"2024-09-01"</span>,
          <span class="hljs-attr">"tutor"</span>: <span class="hljs-string">"Mar√≠a Garc√≠a (Madre)"</span>,
          <span class="hljs-attr">"telefono_tutor"</span>: <span class="hljs-string">"687654321"</span>
        },
        <span class="hljs-attr">"actions"</span>: [
          {
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"ver_detalle"</span>,
            <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Ver expediente completo"</span>,
            <span class="hljs-attr">"endpoint"</span>: <span class="hljs-string">"/alumnos/12"</span>,
            <span class="hljs-attr">"method"</span>: <span class="hljs-string">"GET"</span>,
            <span class="hljs-attr">"params"</span>: {}
          },
          {
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"ver_anotaciones"</span>,
            <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Ver anotaciones"</span>,
            <span class="hljs-attr">"endpoint"</span>: <span class="hljs-string">"/anotaciones?alumno_id=12"</span>,
            <span class="hljs-attr">"method"</span>: <span class="hljs-string">"GET"</span>,
            <span class="hljs-attr">"params"</span>: {}
          },
          {
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"ver_extractos"</span>,
            <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Ver pagos"</span>,
            <span class="hljs-attr">"endpoint"</span>: <span class="hljs-string">"/extractos?alumno_id=12"</span>,
            <span class="hljs-attr">"method"</span>: <span class="hljs-string">"GET"</span>,
            <span class="hljs-attr">"params"</span>: {}
          }
        ]
      },
      {
        <span class="hljs-attr">"id"</span>: <span class="hljs-string">"13"</span>,
        <span class="hljs-attr">"type"</span>: <span class="hljs-string">"alumno"</span>,
        <span class="hljs-attr">"titulo"</span>: <span class="hljs-string">"Ana L√≥pez Mart√≠nez"</span>,
        <span class="hljs-attr">"campos"</span>: {
          <span class="hljs-attr">"email"</span>: <span class="hljs-string">"ana.lopez@estudiante.com"</span>,
          <span class="hljs-attr">"telefono"</span>: <span class="hljs-string">"623456789"</span>,
          <span class="hljs-attr">"fecha_nacimiento"</span>: <span class="hljs-string">"2010-08-22"</span>,
          <span class="hljs-attr">"dni"</span>: <span class="hljs-string">"23456789B"</span>,
          <span class="hljs-attr">"estado_inscripcion"</span>: <span class="hljs-string">"Activo"</span>,
          <span class="hljs-attr">"fecha_inicio_curso"</span>: <span class="hljs-string">"2024-09-01"</span>,
          <span class="hljs-attr">"tutor"</span>: <span class="hljs-string">"Pedro L√≥pez (Padre)"</span>,
          <span class="hljs-attr">"telefono_tutor"</span>: <span class="hljs-string">"698765432"</span>
        },
        <span class="hljs-attr">"actions"</span>: [
          {
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"ver_detalle"</span>,
            <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Ver expediente completo"</span>,
            <span class="hljs-attr">"endpoint"</span>: <span class="hljs-string">"/alumnos/13"</span>,
            <span class="hljs-attr">"method"</span>: <span class="hljs-string">"GET"</span>,
            <span class="hljs-attr">"params"</span>: {}
          }
        ]
      }
    ],
    <span class="hljs-attr">"summary"</span>: {
      <span class="hljs-attr">"total_alumnos"</span>: <span class="hljs-number">25</span>,
      <span class="hljs-attr">"activos"</span>: <span class="hljs-number">23</span>,
      <span class="hljs-attr">"baja"</span>: <span class="hljs-number">2</span>
    }
  },
  <span class="hljs-attr">"uiSuggestions"</span>: [
    {
      <span class="hljs-attr">"id"</span>: <span class="hljs-string">"filtrar_activos"</span>,
      <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Solo alumnos activos"</span>,
      <span class="hljs-attr">"message"</span>: <span class="hljs-string">"Mu√©strame solo los alumnos activos"</span>,
      <span class="hljs-attr">"type"</span>: <span class="hljs-string">"filter"</span>,
      <span class="hljs-attr">"context"</span>: {
        <span class="hljs-attr">"filter"</span>: <span class="hljs-string">"estado=Activo"</span>
      }
    },
    {
      <span class="hljs-attr">"id"</span>: <span class="hljs-string">"buscar_alumno"</span>,
      <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Buscar alumno"</span>,
      <span class="hljs-attr">"message"</span>: <span class="hljs-string">"Buscar alumno por nombre"</span>,
      <span class="hljs-attr">"type"</span>: <span class="hljs-string">"search"</span>,
      <span class="hljs-attr">"context"</span>: {}
    }
  ],
  <span class="hljs-attr">"pagination"</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">"metadata"</span>: {
    <span class="hljs-attr">"conversationId"</span>: <span class="hljs-string">"conv_20251024_103045_xyz789"</span>,
    <span class="hljs-attr">"timestamp"</span>: <span class="hljs-string">"2025-10-24T10:30:45.234Z"</span>,
    <span class="hljs-attr">"model"</span>: <span class="hljs-string">"gpt-4o-mini"</span>,
    <span class="hljs-attr">"tokensUsed"</span>: <span class="hljs-number">1523</span>,
    <span class="hljs-attr">"responseTime"</span>: <span class="hljs-number">2.15</span>,
    <span class="hljs-attr">"version"</span>: <span class="hljs-string">"1.0.0"</span>
  }
}
</div></code></pre>
<h3 id="ejemplo-de-respuesta-completa-sesiones-del-d%C3%ADa">Ejemplo de Respuesta Completa: Sesiones del D√≠a</h3>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"message"</span>: <span class="hljs-string">"Tus clases de hoy - Jueves 23 de octubre de 2025\n\nTienes 3 clase(s) programada(s)"</span>,
  <span class="hljs-attr">"data"</span>: {
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"sesiones_dia"</span>,
    <span class="hljs-attr">"items"</span>: [
      {
        <span class="hljs-attr">"id"</span>: <span class="hljs-string">"5"</span>,
        <span class="hljs-attr">"type"</span>: <span class="hljs-string">"sesion"</span>,
        <span class="hljs-attr">"titulo"</span>: <span class="hljs-string">"Matem√°ticas 1¬∫ ESO"</span>,
        <span class="hljs-attr">"campos"</span>: {
          <span class="hljs-attr">"horario"</span>: <span class="hljs-string">"08:00 - 10:00"</span>,
          <span class="hljs-attr">"aula"</span>: <span class="hljs-string">"Aula 3"</span>,
          <span class="hljs-attr">"aula_id"</span>: <span class="hljs-number">3</span>,
          <span class="hljs-attr">"estado"</span>: <span class="hljs-string">"completada"</span>,
          <span class="hljs-attr">"profesor"</span>: <span class="hljs-string">"Mar√≠a Garc√≠a L√≥pez"</span>,
          <span class="hljs-attr">"descripcion_estado"</span>: <span class="hljs-string">"Completada (08:02 - 10:05) | Lista pasada: 23/25 alumnos"</span>,
          <span class="hljs-attr">"alumnos"</span>: <span class="hljs-number">25</span>,
          <span class="hljs-attr">"alumnos_asistieron"</span>: <span class="hljs-number">23</span>,
          <span class="hljs-attr">"curso_id"</span>: <span class="hljs-number">4</span>,
          <span class="hljs-attr">"horario_curso_id"</span>: <span class="hljs-number">5</span>
        },
        <span class="hljs-attr">"actions"</span>: [
          {
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"ver_alumnos"</span>,
            <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Ver alumnos"</span>,
            <span class="hljs-attr">"endpoint"</span>: <span class="hljs-string">"/sesiones/5/alumnos"</span>,
            <span class="hljs-attr">"method"</span>: <span class="hljs-string">"GET"</span>,
            <span class="hljs-attr">"params"</span>: {}
          },
          {
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"ver_anotaciones"</span>,
            <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Ver anotaciones"</span>,
            <span class="hljs-attr">"endpoint"</span>: <span class="hljs-string">"/sesiones/5/anotaciones"</span>,
            <span class="hljs-attr">"method"</span>: <span class="hljs-string">"GET"</span>,
            <span class="hljs-attr">"params"</span>: {}
          }
        ]
      },
      {
        <span class="hljs-attr">"id"</span>: <span class="hljs-string">"6"</span>,
        <span class="hljs-attr">"type"</span>: <span class="hljs-string">"sesion"</span>,
        <span class="hljs-attr">"titulo"</span>: <span class="hljs-string">"F√≠sica 2¬∫ ESO"</span>,
        <span class="hljs-attr">"campos"</span>: {
          <span class="hljs-attr">"horario"</span>: <span class="hljs-string">"11:00 - 13:00"</span>,
          <span class="hljs-attr">"aula"</span>: <span class="hljs-string">"Aula 5"</span>,
          <span class="hljs-attr">"aula_id"</span>: <span class="hljs-number">5</span>,
          <span class="hljs-attr">"estado"</span>: <span class="hljs-string">"en_curso"</span>,
          <span class="hljs-attr">"profesor"</span>: <span class="hljs-string">"Mar√≠a Garc√≠a L√≥pez"</span>,
          <span class="hljs-attr">"descripcion_estado"</span>: <span class="hljs-string">"Iniciada a las 11:02 | Lista pasada: 18/20 alumnos"</span>,
          <span class="hljs-attr">"alumnos"</span>: <span class="hljs-number">20</span>,
          <span class="hljs-attr">"alumnos_asistieron"</span>: <span class="hljs-number">18</span>,
          <span class="hljs-attr">"curso_id"</span>: <span class="hljs-number">5</span>,
          <span class="hljs-attr">"horario_curso_id"</span>: <span class="hljs-number">6</span>
        },
        <span class="hljs-attr">"actions"</span>: [
          {
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"ver_alumnos"</span>,
            <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Ver alumnos"</span>,
            <span class="hljs-attr">"endpoint"</span>: <span class="hljs-string">"/sesiones/6/alumnos"</span>,
            <span class="hljs-attr">"method"</span>: <span class="hljs-string">"GET"</span>,
            <span class="hljs-attr">"params"</span>: {}
          },
          {
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"ver_anotaciones"</span>,
            <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Ver anotaciones"</span>,
            <span class="hljs-attr">"endpoint"</span>: <span class="hljs-string">"/sesiones/6/anotaciones"</span>,
            <span class="hljs-attr">"method"</span>: <span class="hljs-string">"GET"</span>,
            <span class="hljs-attr">"params"</span>: {}
          },
          {
            <span class="hljs-attr">"id"</span>: <span class="hljs-string">"finalizar_sesion"</span>,
            <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Finalizar sesi√≥n"</span>,
            <span class="hljs-attr">"endpoint"</span>: <span class="hljs-string">"/sesiones/6/finalizar"</span>,
            <span class="hljs-attr">"method"</span>: <span class="hljs-string">"POST"</span>,
            <span class="hljs-attr">"params"</span>: {}
          }
        ]
      },
      {
        <span class="hljs-attr">"id"</span>: <span class="hljs-string">"7"</span>,
        <span class="hljs-attr">"type"</span>: <span class="hljs-string">"sesion"</span>,
        <span class="hljs-attr">"titulo"</span>: <span class="hljs-string">"Matem√°ticas 1¬∫ ESO"</span>,
        <span class="hljs-attr">"campos"</span>: {
          <span class="hljs-attr">"horario"</span>: <span class="hljs-string">"21:00 - 23:00"</span>,
          <span class="hljs-attr">"aula"</span>: <span class="hljs-string">"Aula 3"</span>,
          <span class="hljs-attr">"aula_id"</span>: <span class="hljs-number">3</span>,
          <span class="hljs-attr">"estado"</span>: <span class="hljs-string">"programada"</span>,
          <span class="hljs-attr">"profesor"</span>: <span class="hljs-string">"Mar√≠a Garc√≠a L√≥pez"</span>,
          <span class="hljs-attr">"descripcion_estado"</span>: <span class="hljs-string">"No iniciada"</span>,
          <span class="hljs-attr">"alumnos"</span>: <span class="hljs-number">25</span>,
          <span class="hljs-attr">"alumnos_asistieron"</span>: <span class="hljs-literal">null</span>,
          <span class="hljs-attr">"curso_id"</span>: <span class="hljs-number">4</span>,
          <span class="hljs-attr">"horario_curso_id"</span>: <span class="hljs-number">11</span>
        },
        <span class="hljs-attr">"actions"</span>: []
      }
    ],
    <span class="hljs-attr">"summary"</span>: {
      <span class="hljs-attr">"total_clases"</span>: <span class="hljs-number">3</span>,
      <span class="hljs-attr">"completadas"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">"en_curso"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">"programadas"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">"total_alumnos"</span>: <span class="hljs-number">70</span>,
      <span class="hljs-attr">"total_asistencias"</span>: <span class="hljs-number">41</span>
    }
  },
  <span class="hljs-attr">"uiSuggestions"</span>: [
    {
      <span class="hljs-attr">"id"</span>: <span class="hljs-string">"ver_ayer"</span>,
      <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Ver clases de ayer"</span>,
      <span class="hljs-attr">"message"</span>: <span class="hljs-string">"Mu√©strame mis clases de ayer"</span>,
      <span class="hljs-attr">"type"</span>: <span class="hljs-string">"generic"</span>,
      <span class="hljs-attr">"context"</span>: {
        <span class="hljs-attr">"fecha"</span>: <span class="hljs-string">"2025-10-22"</span>,
        <span class="hljs-attr">"screen"</span>: <span class="hljs-string">"sesiones"</span>,
        <span class="hljs-attr">"filter"</span>: <span class="hljs-string">"ayer"</span>
      }
    },
    {
      <span class="hljs-attr">"id"</span>: <span class="hljs-string">"ver_manana"</span>,
      <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Ver clases de ma√±ana"</span>,
      <span class="hljs-attr">"message"</span>: <span class="hljs-string">"Mu√©strame mis clases de ma√±ana"</span>,
      <span class="hljs-attr">"type"</span>: <span class="hljs-string">"generic"</span>,
      <span class="hljs-attr">"context"</span>: {
        <span class="hljs-attr">"fecha"</span>: <span class="hljs-string">"2025-10-24"</span>,
        <span class="hljs-attr">"screen"</span>: <span class="hljs-string">"sesiones"</span>,
        <span class="hljs-attr">"filter"</span>: <span class="hljs-string">"manana"</span>
      }
    },
    {
      <span class="hljs-attr">"id"</span>: <span class="hljs-string">"ver_semana"</span>,
      <span class="hljs-attr">"label"</span>: <span class="hljs-string">"Ver toda la semana"</span>,
      <span class="hljs-attr">"message"</span>: <span class="hljs-string">"Mu√©strame todas mis clases de la semana"</span>,
      <span class="hljs-attr">"type"</span>: <span class="hljs-string">"generic"</span>,
      <span class="hljs-attr">"context"</span>: {
        <span class="hljs-attr">"screen"</span>: <span class="hljs-string">"sesiones"</span>,
        <span class="hljs-attr">"filter"</span>: <span class="hljs-string">"semana"</span>
      }
    }
  ],
  <span class="hljs-attr">"pagination"</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">"metadata"</span>: {
    <span class="hljs-attr">"conversationId"</span>: <span class="hljs-string">"conv_20251023_091530_abc123"</span>,
    <span class="hljs-attr">"timestamp"</span>: <span class="hljs-string">"2025-10-23T09:15:30.125Z"</span>,
    <span class="hljs-attr">"model"</span>: <span class="hljs-string">"gpt-4-turbo"</span>,
    <span class="hljs-attr">"tokensUsed"</span>: <span class="hljs-number">1847</span>,
    <span class="hljs-attr">"responseTime"</span>: <span class="hljs-number">2.34</span>,
    <span class="hljs-attr">"version"</span>: <span class="hljs-string">"1.0.0"</span>
  }
}
</div></code></pre>
<h3 id="ventajas-del-contrato-envelope">Ventajas del Contrato Envelope</h3>
<p><strong>Consistencia</strong></p>
<ul>
<li>Todas las respuestas siguen la misma estructura</li>
<li>UI puede renderizar cualquier tipo de dato sin cambios</li>
</ul>
<p><strong>Flexibilidad</strong></p>
<ul>
<li>Nuevos tipos de datos solo requieren agregar un nuevo <code>type</code></li>
<li>No rompe compatibilidad con versiones anteriores</li>
</ul>
<p><strong>Riqueza de Metadata</strong></p>
<ul>
<li>Informaci√≥n de debugging (tokensUsed, responseTime)</li>
<li>Trazabilidad (conversationId, timestamp)</li>
<li>Versionado para deprecaci√≥n de campos</li>
</ul>
<p><strong>Navegaci√≥n Intuitiva</strong></p>
<ul>
<li><code>uiSuggestions</code> gu√≠a al usuario a la siguiente acci√≥n</li>
<li>Context map permite navegaci√≥n profunda sin perder estado</li>
</ul>
<p><strong>Paginaci√≥n Autom√°tica</strong></p>
<ul>
<li>El backend decide si paginar seg√∫n cantidad de items</li>
<li>UI renderiza botones &quot;Ver m√°s&quot; autom√°ticamente</li>
</ul>
<hr>
<h2 id="6-tabla-de-endpoints-y-seguridad">6. Tabla de Endpoints y Seguridad</h2>

<div class="update-note">
<strong>üîÑ Actualizado en v2.1.0:</strong> Nuevos par√°metros de query, endpoint pasar-lista, restricci√≥n en POST /anotaciones.
</div>

<h3 id="api-workers---endpoints-actualizados-v21">API Workers - Endpoints Actualizados (v2.1.0)</h3>

<h4 id="academias-nuevos-campos">Academias (Nuevos Campos)</h4>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>M√©todo</th>
<th>Cambios v2.1.0</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/academias</code></td>
<td>POST</td>
<td>Ahora acepta: <code>direccion</code>, <code>telefono</code>, <code>nombre_contacto</code>, <code>email_contacto</code>, <code>descripcion</code></td>
</tr>
<tr>
<td><code>/academias/:id</code></td>
<td>PUT</td>
<td>Puede actualizar los 5 campos nuevos</td>
</tr>
<tr>
<td><code>/academias/:id</code></td>
<td>GET</td>
<td>Respuesta incluye los nuevos campos</td>
</tr>
</tbody>
</table>

<h4 id="inscripciones-query-parameters-avanzados">Inscripciones (Query Parameters Avanzados)</h4>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>M√©todo</th>
<th>Query Parameters (v2.1.0)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/inscripciones</code></td>
<td>GET</td>
<td><strong>12 par√°metros:</strong><br/><code>academia_id</code>, <code>alumno_id</code>, <code>curso_id</code>, <code>activas</code> (bool),<br/><code>fecha_inicio_desde</code>, <code>fecha_inicio_hasta</code> (filtros de rango),<br/><code>page</code>, <code>size</code>, <code>with_total</code> (paginaci√≥n),<br/><code>order_by</code> (id, fecha_inicio, fecha_fin), <code>order_dir</code> (asc/desc),<br/><code>expand</code> (curso, alumno)</td>
</tr>
<tr>
<td><code>/inscripciones/:id</code></td>
<td>GET</td>
<td>Respuesta incluye <code>academia_id</code> (campo nuevo)</td>
</tr>
</tbody>
</table>

<p><strong>Ejemplos de uso de GET /inscripciones:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Caso 1: Todas las inscripciones activas de una academia</span>
GET /inscripciones?academia_id=<span class="hljs-number">5</span>&amp;activas=<span class="hljs-literal">true</span>

<span class="hljs-comment"># Caso 2: Inscripciones de un alumno con paginaci√≥n</span>
GET /inscripciones?alumno_id=<span class="hljs-number">12</span>&amp;page=<span class="hljs-number">1</span>&amp;size=<span class="hljs-number">20</span>&amp;with_total=<span class="hljs-literal">true</span>

<span class="hljs-comment"># Caso 3: Inscripciones de un curso ordenadas por fecha</span>
GET /inscripciones?curso_id=<span class="hljs-number">8</span>&amp;order_by=fecha_inicio&amp;order_dir=desc

<span class="hljs-comment"># Caso 4: Inscripciones en rango de fechas con datos expandidos</span>
GET /inscripciones?fecha_inicio_desde=<span class="hljs-number">2024</span>-<span class="hljs-number">09</span>-<span class="hljs-number">01</span>&amp;fecha_inicio_hasta=<span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">31</span>&amp;expand=curso,alumno
</div></code></pre>

<h4 id="anotaciones-restricci√≥n-de-tipo-ausencia">Anotaciones (Restricci√≥n de tipo 'Ausencia')</h4>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>M√©todo</th>
<th>Cambio v2.1.0</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/anotaciones</code></td>
<td>POST</td>
<td><strong>Ya NO permite tipo 'Ausencia'</strong><br/>Solo acepta: <code>Evaluacion</code>, <code>Comportamiento</code>, <code>Observacion</code>, <code>Otros</code><br/>Para registrar ausencias usar ‚Üí <code>POST /sesiones/:id/pasar-lista</code></td>
</tr>
</tbody>
</table>

<p><strong>Justificaci√≥n:</strong> Las ausencias se registran mediante el proceso de "pasar lista" que valida reglas de negocio espec√≠ficas (sesi√≥n activa, inscripci√≥n v√°lida, no duplicados). Crear ausencias directamente v√≠a POST /anotaciones podr√≠a generar inconsistencias.</p>

<h4 id="sesiones-nuevo-endpoint-pasar-lista">Sesiones (Nuevo Endpoint pasar-lista)</h4>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>M√©todo</th>
<th>Descripci√≥n</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/sesiones/:id/pasar-lista</code> ‚≠ê</td>
<td>POST</td>
<td><strong>NUEVO en v2.1.0:</strong> Registra asistencia masiva de alumnos en una sesi√≥n.<br/>Body: <code>{ ausencias: [alumno_id1, alumno_id2, ...] }</code><br/>Crea anotaciones tipo 'Ausencia' autom√°ticamente<br/>Valida sesi√≥n activa, inscripciones v√°lidas, evita duplicados</td>
</tr>
</tbody>
</table>

<p><strong>Ejemplo de uso:</strong></p>
<pre class="hljs"><code><div>POST /sesiones/<span class="hljs-number">123</span>/pasar-lista
Content-Type: application/json
Authorization: Bearer JWT_TOKEN

{
  <span class="hljs-string">"ausencias"</span>: [<span class="hljs-number">45</span>, <span class="hljs-number">67</span>, <span class="hljs-number">89</span>]  <span class="hljs-comment">// IDs de alumnos ausentes</span>
}

<span class="hljs-comment"># Respuesta:</span>
{
  <span class="hljs-string">"ok"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"ausencias_registradas"</span>: <span class="hljs-number">3</span>,
  <span class="hljs-string">"presentes"</span>: <span class="hljs-number">22</span>,
  <span class="hljs-string">"total_alumnos"</span>: <span class="hljs-number">25</span>
}
</div></code></pre>

<h3 id="api-workers---endpoints-de-autenticaci√≥n">API Workers - Endpoints de Autenticaci√≥n</h3>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>M√©todo</th>
<th>Autenticaci√≥n</th>
<th>Request Body</th>
<th>Response</th>
<th>Descripci√≥n</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/auth/login</code></td>
<td>POST</td>
<td>P√∫blica</td>
<td><code>{ email, password }</code></td>
<td><code>{ jwt, refreshToken, user }</code></td>
<td>Login inicial del usuario</td>
</tr>
<tr>
<td><code>/auth/refresh</code></td>
<td>POST</td>
<td>RefreshToken</td>
<td><code>{ refreshToken }</code></td>
<td><code>{ jwt, refreshToken }</code></td>
<td>Renovaci√≥n de JWT expirado (rotaci√≥n autom√°tica)</td>
</tr>
<tr>
<td><code>/auth/logout</code></td>
<td>POST</td>
<td>JWT</td>
<td><code>{}</code></td>
<td><code>{ success: true }</code></td>
<td>Invalidar sesi√≥n (revoca refresh token)</td>
</tr>
<tr>
<td><code>/auth/verify</code></td>
<td>GET</td>
<td>JWT</td>
<td>-</td>
<td><code>{ valid: true, user }</code></td>
<td>Verificar si JWT es v√°lido</td>
</tr>
</tbody>
</table>
<h3 id="api-workers---endpoints-de-recursos-completo">API Workers - Endpoints de Recursos (Completo)</h3>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>M√©todo</th>
<th>Autenticaci√≥n</th>
<th>Permisos</th>
<th>Descripci√≥n</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Alumnos</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>/alumnos</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Listar alumnos (filtros: curso_id, estado, b√∫squeda)</td>
</tr>
<tr>
<td><code>/alumnos/:id</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Detalle completo de un alumno</td>
</tr>
<tr>
<td><code>/alumnos</code></td>
<td>POST</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Alta de nuevo alumno</td>
</tr>
<tr>
<td><code>/alumnos/:id</code></td>
<td>PUT</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Modificaci√≥n de datos de alumno</td>
</tr>
<tr>
<td><code>/alumnos/:id/baja</code></td>
<td>POST</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Baja l√≥gica de alumno</td>
</tr>
<tr>
<td><strong>Inscripciones</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>/inscripciones</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Listar inscripciones (12 par√°metros de query: academia_id, alumno_id, curso_id, activas, fechas, paginaci√≥n, ordenamiento, expand)</td>
</tr>
<tr>
<td><code>/inscripciones/:id</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Detalle de una inscripci√≥n</td>
</tr>
<tr>
<td><code>/inscripciones</code></td>
<td>POST</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Crear nueva inscripci√≥n (matricular alumno en curso). La tarifa se obtiene autom√°ticamente del curso.</td>
</tr>
<tr>
<td><code>/inscripciones/:id</code></td>
<td>PATCH</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Actualizar inscripci√≥n (dar de baja, modificar fechas). Campos mutables: fecha_inicio, fecha_fin, motivo_baja</td>
</tr>
<tr>
<td><code>/inscripciones/:id</code></td>
<td>DELETE</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Baja l√≥gica de inscripci√≥n (establece fecha_fin = hoy)</td>
</tr>
<tr>
<td><strong>Cursos</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>/cursos</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Listar cursos (filtros: academia_id, a√±o_academico)</td>
</tr>
<tr>
<td><code>/cursos/:id</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Detalle de un curso</td>
</tr>
<tr>
<td><code>/cursos/:id/alumnos</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Alumnos inscritos en un curso</td>
</tr>
<tr>
<td><code>/cursos</code></td>
<td>POST</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Crear nuevo curso</td>
</tr>
<tr>
<td><code>/cursos/:id</code></td>
<td>PUT</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Modificar curso existente</td>
</tr>
<tr>
<td><strong>Sesiones</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>/sesiones</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Listar sesiones (filtros: fecha, profesor_id, estado)</td>
</tr>
<tr>
<td><code>/sesiones/:id</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Detalle de una sesi√≥n</td>
</tr>
<tr>
<td><code>/sesiones/iniciar</code></td>
<td>POST</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Crear nueva sesi√≥n (abrir clase)</td>
</tr>
<tr>
<td><code>/sesiones/:id/finalizar</code></td>
<td>POST</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Cerrar sesi√≥n (marca timestamp_baja)</td>
</tr>
<tr>
<td><code>/sesiones/:id/alumnos</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Lista de asistencia de una sesi√≥n</td>
</tr>
<tr>
<td><strong>Anotaciones</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>/anotaciones</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Listar anotaciones (filtros: alumno_id, sesion_id, tipo)</td>
</tr>
<tr>
<td><code>/anotaciones</code></td>
<td>POST</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Crear nueva anotaci√≥n (asistencia, evaluaci√≥n, comportamiento)</td>
</tr>
<tr>
<td><code>/anotaciones/:id</code></td>
<td>PUT</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Modificar anotaci√≥n existente</td>
</tr>
<tr>
<td><code>/anotaciones/:id</code></td>
<td>DELETE</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Eliminar anotaci√≥n (baja l√≥gica)</td>
</tr>
<tr>
<td><strong>Profesores</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>/profesores</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Listar profesores de la academia</td>
</tr>
<tr>
<td><code>/profesores/:id</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Detalle de un profesor</td>
</tr>
<tr>
<td><code>/profesores/:id/cursos</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Cursos asignados a un profesor</td>
</tr>
<tr>
<td><strong>Horarios</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>/horarios</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia, Profesor_academia</td>
<td>Obtener horarios de un curso</td>
</tr>
<tr>
<td><code>/horarios</code></td>
<td>POST</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Crear nuevo horario</td>
</tr>
<tr>
<td><code>/horarios/:id</code></td>
<td>PUT</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Modificar horario existente</td>
</tr>
<tr>
<td><strong>Usuarios</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>/usuarios</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Listar usuarios (filtros: academia_id, rol, estado)</td>
</tr>
<tr>
<td><code>/usuarios/:id</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Detalle de un usuario</td>
</tr>
<tr>
<td><code>/usuarios</code></td>
<td>POST</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Crear nuevo usuario</td>
</tr>
<tr>
<td><code>/usuarios/:id</code></td>
<td>PUT</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Modificar usuario existente</td>
</tr>
<tr>
<td><code>/usuarios/:id/bloquear</code></td>
<td>POST</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Bloquear usuario temporalmente</td>
</tr>
<tr>
<td><strong>Academias</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>/academias</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma</td>
<td>Listar todas las academias</td>
</tr>
<tr>
<td><code>/academias/:id</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Detalle de una academia</td>
</tr>
<tr>
<td><code>/academias</code></td>
<td>POST</td>
<td>JWT</td>
<td>Admin_plataforma</td>
<td>Crear nueva academia</td>
</tr>
<tr>
<td><code>/academias/:id</code></td>
<td>PUT</td>
<td>JWT</td>
<td>Admin_plataforma</td>
<td>Modificar academia existente</td>
</tr>
<tr>
<td><strong>Extractos y Pagos</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>/extractos</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Listar extractos (filtros: alumno_id, estado)</td>
</tr>
<tr>
<td><code>/extractos/:id</code></td>
<td>GET</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Detalle de extracto con movimientos</td>
</tr>
<tr>
<td><code>/movimientos</code></td>
<td>POST</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Registrar ingreso de pago</td>
</tr>
<tr>
<td><code>/movimientos/:id/anular</code></td>
<td>POST</td>
<td>JWT</td>
<td>Admin_plataforma, Admin_academia</td>
<td>Anular movimiento existente</td>
</tr>
</tbody>
</table>
<h3 id="backend-chat---endpoints">Backend Chat - Endpoints</h3>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>M√©todo</th>
<th>Autenticaci√≥n</th>
<th>Request Body</th>
<th>Response</th>
<th>Descripci√≥n</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/chat</code></td>
<td>POST</td>
<td>JWT</td>
<td><code>{ messages, context }</code></td>
<td><code>Envelope&lt;GenericItem&gt;</code></td>
<td>Enviar mensaje al chat (modo est√°ndar)</td>
</tr>
<tr>
<td><code>/chat/stream</code></td>
<td>POST</td>
<td>JWT</td>
<td><code>{ messages, context }</code></td>
<td>SSE Stream</td>
<td><strong>Chat en tiempo real con Server-Sent Events (SSE)</strong>. Devuelve respuesta incremental palabra por palabra para mejor UX. Endpoint experimental.</td>
</tr>
<tr>
<td><code>/chat/history</code></td>
<td>GET</td>
<td>JWT</td>
<td>-</td>
<td><code>{ messages: [...] }</code></td>
<td>Historial de conversaci√≥n (futuro)</td>
</tr>
<tr>
<td><code>/chat/context</code></td>
<td>POST</td>
<td>JWT</td>
<td><code>{ contextUpdate }</code></td>
<td><code>{ success: true }</code></td>
<td>Actualizar contexto conversacional (futuro)</td>
</tr>
</tbody>
</table>
<p><strong>Nota sobre /chat/stream:</strong></p>
<ul>
<li>Utiliza Server-Sent Events (SSE) para streaming</li>
<li>La respuesta se env√≠a token por token (palabra por palabra) conforme OpenAI la genera</li>
<li>Mejor experiencia de usuario (similar a ChatGPT web)</li>
<li>Requiere cliente compatible con EventSource API</li>
<li>Android: usar OkHttp SSE o biblioteca espec√≠fica</li>
</ul>
<h3 id="matriz-de-permisos-por-rol">Matriz de Permisos por Rol (Actualizada v2.1.0)</h3>
<p>Basado en la l√≥gica de negocio de API Workers:</p>
<table>
<thead>
<tr>
<th>Recurso / Acci√≥n</th>
<th>Admin_plataforma</th>
<th>Admin_academia</th>
<th>Profesor_academia</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Academias</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ver todas las academias</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No (solo la propia)</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>Crear/modificar academia</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>Ver datos de su academia</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
</tr>
<tr>
<td><strong>Usuarios</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ver todos los usuarios</td>
<td>‚úÖ S√≠ (todas las academias)</td>
<td>‚úÖ S√≠ (solo su academia)</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>Crear usuarios</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠ (solo en su academia)</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>Modificar/bloquear usuarios</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠ (solo de su academia)</td>
<td>‚ùå No</td>
</tr>
<tr>
<td><strong>Alumnos</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ver alumnos</td>
<td>‚úÖ S√≠ (todas las academias)</td>
<td>‚úÖ S√≠ (solo su academia)</td>
<td>‚úÖ S√≠ (solo de sus cursos)</td>
</tr>
<tr>
<td>Alta de alumno</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>Modificar alumno</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>Baja de alumno</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No</td>
</tr>
<tr>
<td><strong>Cursos</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ver cursos</td>
<td>‚úÖ S√≠ (todas las academias)</td>
<td>‚úÖ S√≠ (solo su academia)</td>
<td>‚úÖ S√≠ (solo los asignados)</td>
</tr>
<tr>
<td>Crear curso</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>Modificar curso</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>Asignar profesor a curso</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No</td>
</tr>
<tr>
<td><strong>Inscripciones</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ver inscripciones</td>
<td>‚úÖ S√≠ (todas las academias)</td>
<td>‚úÖ S√≠ (solo su academia)</td>
<td>‚úÖ S√≠ (solo de sus cursos)</td>
</tr>
<tr>
<td>Filtrar por fecha, ordenar, paginar ‚≠ê</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
</tr>
<tr>
<td>Crear inscripci√≥n</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>Modificar inscripci√≥n</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No</td>
</tr>
<tr>
<td><strong>Sesiones (Clases)</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ver sesiones</td>
<td>‚úÖ S√≠ (todas)</td>
<td>‚úÖ S√≠ (de su academia)</td>
<td>‚úÖ S√≠ (solo las propias)</td>
</tr>
<tr>
<td>Iniciar sesi√≥n</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
</tr>
<tr>
<td>Finalizar sesi√≥n</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
</tr>
<tr>
<td>Ver lista de asistencia</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠ (solo sus sesiones)</td>
</tr>
<tr>
<td>Pasar lista (registrar ausencias masivas) ‚≠ê</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠ (solo sus sesiones)</td>
</tr>
<tr>
<td><strong>Anotaciones</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ver anotaciones</td>
<td>‚úÖ S√≠ (todas)</td>
<td>‚úÖ S√≠ (de su academia)</td>
<td>‚úÖ S√≠ (de sus cursos)</td>
</tr>
<tr>
<td>Crear anotaciones</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠ (solo en sus sesiones)</td>
</tr>
<tr>
<td>Crear anotaci√≥n tipo 'Ausencia' ‚≠ê</td>
<td>‚ùå No (usar pasar-lista)</td>
<td>‚ùå No (usar pasar-lista)</td>
<td>‚ùå No (usar pasar-lista)</td>
</tr>
<tr>
<td>Modificar anotaciones</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠ (solo las propias)</td>
</tr>
<tr>
<td>Eliminar anotaciones</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No</td>
</tr>
<tr>
<td><strong>Extractos y Pagos</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ver extractos</td>
<td>‚úÖ S√≠ (todos)</td>
<td>‚úÖ S√≠ (de su academia)</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>Registrar pagos</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>Anular pagos</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No</td>
</tr>
<tr>
<td><strong>Horarios</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ver horarios</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠ (de sus cursos)</td>
</tr>
<tr>
<td>Crear/modificar horarios</td>
<td>‚úÖ S√≠</td>
<td>‚úÖ S√≠</td>
<td>‚ùå No</td>
</tr>
</tbody>
</table>
<p><strong>Filtrado Autom√°tico por Multi-tenancy:</strong></p>
<ul>
<li>Todos los endpoints filtran autom√°ticamente por <code>academiaId</code> del JWT</li>
<li><code>Admin_plataforma</code> puede especificar <code>?academia_id=X</code> para ver otras academias</li>
<li><code>Admin_academia</code> y <code>Profesor_academia</code> solo ven datos de su academia (forzado en backend)</li>
</ul>
<hr>
<h2 id="7-flujo-completo-caso-de-uso-real">7. Flujo Completo: Caso de Uso Real</h2>

<div class="update-note">
<strong>üîÑ Actualizado en v2.1.0:</strong> Arquitectura de Tool Calling iterativo explicada en detalle.
</div>

<h3 id="arquitectura-de-tool-calling-iterativo">Arquitectura de Tool Calling Iterativo</h3>

<p><strong>Concepto Clave:</strong> El Backend Chat usa un sistema de <strong>bucle iterativo</strong> que permite a OpenAI realizar m√∫ltiples llamadas a la API hasta obtener toda la informaci√≥n necesaria.</p>

<pre class="hljs"><code><div><span class="hljs-comment">// OpenAICallApiService.java - Bucle principal</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> iter = <span class="hljs-number">0</span>; iter &lt; maxIterations; iter++) {
    <span class="hljs-comment">// 1. Llamar OpenAI con tool "call_api"</span>
    JsonNode response = openai.createResponse(currentMessages, [call_api_tool]);
    
    <span class="hljs-comment">// 2. Si OpenAI responde con tool_calls:</span>
    <span class="hljs-keyword">if</span> (response.has(<span class="hljs-string">"tool_calls"</span>)) {
        <span class="hljs-comment">// 3. Ejecutar TODAS las tool_calls solicitadas</span>
        <span class="hljs-keyword">for</span> (toolCall : tool_calls) {
            String result = apiProxyService.call(toolCall);
            toolResults.add(result);
        }
        
        <span class="hljs-comment">// 4. Agregar resultados como mensajes tipo "tool"</span>
        currentMessages.add(assistantMessage);  <span class="hljs-comment">// con tool_calls</span>
        currentMessages.addAll(toolResults);     <span class="hljs-comment">// resultados</span>
        
        <span class="hljs-comment">// 5. Volver a llamar OpenAI en siguiente iteraci√≥n</span>
        <span class="hljs-keyword">continue</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 6. No hay tool_calls ‚Üí respuesta final</span>
        <span class="hljs-keyword">return</span> response;
    }
}
</div></code></pre>

<p><strong>Caracter√≠sticas del Sistema:</strong></p>
<ul>
<li>‚úÖ <strong>M√°ximo 10 iteraciones</strong> para evitar bucles infinitos</li>
<li>‚úÖ <strong>UN SOLO tool gen√©rico:</strong> <code>call_api</code> (puede llamar a cualquier endpoint de la whitelist)</li>
<li>‚úÖ <strong>OpenAI puede pedir m√∫ltiples tools en una sola respuesta</strong> (se procesan todas antes de siguiente iteraci√≥n)</li>
<li>‚úÖ <strong>Whitelist de endpoints:</strong> Solo se permiten llamadas a endpoints pre-autorizados</li>
<li>‚úÖ <strong>Validaci√≥n JWT en cada llamada:</strong> El mismo JWT del usuario se reenv√≠a a API Workers</li>
</ul>

<p><strong>Ejemplo de Flujo Iterativo Real:</strong></p>

<pre class="hljs"><code><div><span class="hljs-comment">// Iteraci√≥n 1:</span>
Usuario: <span class="hljs-string">"Mu√©strame los alumnos del curso de Matem√°ticas 1¬∫ ESO"</span>
OpenAI: tool_call ‚Üí GET /cursos?nombre=Matem√°ticas%<span class="hljs-number">201</span>¬∫%<span class="hljs-number">20</span>ESO
API Workers: [{ <span class="hljs-string">"id"</span>: <span class="hljs-number">8</span>, <span class="hljs-string">"nombre"</span>: <span class="hljs-string">"Matem√°ticas 1¬∫ ESO"</span> }]

<span class="hljs-comment">// Iteraci√≥n 2:</span>
OpenAI: tool_call ‚Üí GET /inscripciones?curso_id=<span class="hljs-number">8</span>&amp;activas=<span class="hljs-literal">true</span>&amp;expand=alumno
API Workers: [{ inscripciones con datos de alumnos }]

<span class="hljs-comment">// Iteraci√≥n 3:</span>
OpenAI: <span class="hljs-string">"El curso Matem√°ticas 1¬∫ ESO tiene 25 alumnos inscritos..."</span> (respuesta final)
</div></code></pre>

<p><strong>Telemetr√≠a del Sistema Iterativo:</strong></p>
<table>
<thead>
<tr>
<th>M√©trica</th>
<th>Valor T√≠pico</th>
<th>Descripci√≥n</th>
</tr>
</thead>
<tbody>
<tr>
<td>Iteraciones por request</td>
<td>1-3 (promedio: 2)</td>
<td>Mayor√≠a de casos se resuelven en 2 ciclos</td>
</tr>
<tr>
<td>Tiempo por iteraci√≥n</td>
<td>0.5-2 segundos</td>
<td>Incluye llamada OpenAI + API Workers</td>
</tr>
<tr>
<td><strong>Tiempo total</strong></td>
<td><strong>1-6 segundos</strong></td>
<td>Depende de complejidad de la consulta</td>
</tr>
<tr>
<td>Casos extremos</td>
<td>Hasta 15 segundos</td>
<td>Queries complejas con m√∫ltiples tool_calls</td>
</tr>
<tr>
<td>Tokens consumidos</td>
<td>500-3000</td>
<td>Aumenta con cada iteraci√≥n</td>
</tr>
</tbody>
</table>

<p><strong>Ventajas del Sistema Iterativo:</strong></p>
<ol>
<li><strong>Flexibilidad Total:</strong> OpenAI decide qu√© informaci√≥n necesita en cada paso</li>
<li><strong>Optimizaci√≥n de Llamadas:</strong> Solo se hacen las consultas necesarias</li>
<li><strong>Resiliencia:</strong> Si una tool falla, OpenAI puede intentar otra aproximaci√≥n</li>
<li><strong>Contexto Acumulativo:</strong> Cada iteraci√≥n enriquece el contexto para mejores respuestas</li>
</ol>

<p><strong>Desventajas y Mitigaciones:</strong></p>
<ul>
<li>‚ùå <strong>Mayor latencia:</strong> M√∫ltiples round-trips a OpenAI
<ul>
<li>‚úÖ <strong>Mitigaci√≥n:</strong> Usar modelo r√°pido (gpt-4o-mini) y cach√© de respuestas frecuentes</li>
</ul>
</li>
<li>‚ùå <strong>Mayor consumo de tokens:</strong> Cada iteraci√≥n suma tokens
<ul>
<li>‚úÖ <strong>Mitigaci√≥n:</strong> L√≠mite de 10 iteraciones, prompts optimizados</li>
</ul>
</li>
<li>‚ùå <strong>Posibles bucles infinitos:</strong> OpenAI podr√≠a pedir informaci√≥n repetidamente
<ul>
<li>‚úÖ <strong>Mitigaci√≥n:</strong> L√≠mite de iteraciones + logs de detecci√≥n de patrones</li>
</ul>
</li>
</ul>

<h3 id="caso-profesor-inicia-sesi√≥n-ve-sus-clases-del-d√≠a-pasa-lista-y-agrega-anotaci√≥n">Caso: Profesor inicia sesi√≥n, ve sus clases del d√≠a, pasa lista y agrega anotaci√≥n</h3>
<p><strong>Descripci√≥n del Flujo:</strong></p>
<p>Este flujo demuestra c√≥mo un profesor interact√∫a con el sistema a trav√©s de una interfaz conversacional para:</p>
<ol>
<li>Ver sus clases del d√≠a</li>
<li>Acceder a la lista de alumnos</li>
<li>Registrar anotaciones sobre el desempe√±o de los estudiantes</li>
</ol>
<p><strong>Arquitectura del Flujo:</strong></p>
<pre class="hljs"><code><div>Usuario (Android) ‚Üí Backend Chat ‚Üí OpenAI GPT-4 ‚Üí API Workers ‚Üí MySQL
                         ‚Üë                              ‚Üë
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Token Delegado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              (mismo JWT de punta a punta)
</div></code></pre>
<p><strong>Pasos Detallados:</strong></p>
<p><strong>PASO 1: Ver Clases del D√≠a</strong></p>
<ol>
<li>Usuario toca &quot;Mis Clases de Hoy&quot; en el men√∫</li>
<li>Android env√≠a mensaje + JWT a Backend Chat</li>
<li>Backend Chat valida JWT y extrae claims (usuarioId, academiaId, role)</li>
<li>Backend Chat consulta OpenAI con el mensaje y la especificaci√≥n de API</li>
<li>OpenAI decide llamar a GET /sesiones con filtros de fecha y profesor</li>
<li>Backend Chat reenv√≠a el MISMO JWT a API Workers</li>
<li>API Workers valida JWT, filtra por academiaId y ejecuta query SQL</li>
<li>MySQL devuelve las 3 sesiones del d√≠a</li>
<li>Backend Chat pasa los resultados a OpenAI</li>
<li>OpenAI genera respuesta en lenguaje natural</li>
<li>Backend Chat estructura respuesta como Envelope</li>
<li>Android renderiza 3 tarjetas de sesiones con estados</li>
</ol>
<p><strong>PASO 2: Ver Lista de Alumnos</strong></p>
<ol>
<li>Usuario toca &quot;Ver alumnos&quot; en una sesi√≥n</li>
<li>Flujo similar: Android ‚Üí Backend Chat ‚Üí OpenAI</li>
<li>OpenAI decide llamar a GET /sesiones/6/alumnos</li>
<li>Backend Chat reenv√≠a JWT a API Workers</li>
<li>API Workers ejecuta query con JOINs para obtener asistencia</li>
<li>Devuelve 20 alumnos con su estado (presente/ausente)</li>
<li>Backend Chat estructura respuesta con actions (marcar asistencia)</li>
<li>Android renderiza lista interactiva</li>
</ol>
<p><strong>PASO 3: Agregar Anotaci√≥n</strong></p>
<ol>
<li>Usuario escribe: &quot;A√±adir anotaci√≥n a Juan P√©rez: Excelente participaci√≥n&quot;</li>
<li>OpenAI interpreta la intenci√≥n y extrae par√°metros</li>
<li>OpenAI decide llamar a POST /anotaciones</li>
<li>Backend Chat construye body con datos extra√≠dos</li>
<li>Backend Chat env√≠a POST con JWT a API Workers</li>
<li>API Workers valida, inserta en tabla AnotacionesAlumnoSesion</li>
<li>MySQL confirma inserci√≥n (id: 123)</li>
<li>OpenAI genera mensaje de confirmaci√≥n</li>
<li>Android muestra: &quot;Anotaci√≥n registrada correctamente para Juan P√©rez&quot;</li>
</ol>
<p><strong>Telemetr√≠a del Flujo Completo (Actualizada v2.1.0):</strong></p>
<table>
<thead>
<tr>
<th>Etapa</th>
<th>Tiempo Estimado</th>
<th>Descripci√≥n</th>
</tr>
</thead>
<tbody>
<tr>
<td>Paso 1: Cargar clases</td>
<td>1-3 segundos</td>
<td>1-2 iteraciones OpenAI + 1 query MySQL</td>
</tr>
<tr>
<td>Paso 2: Cargar alumnos</td>
<td>1.5-4 segundos</td>
<td>2-3 iteraciones OpenAI + 1-2 queries</td>
</tr>
<tr>
<td>Paso 3: Guardar anotaci√≥n</td>
<td>1-2 segundos</td>
<td>1-2 iteraciones OpenAI + 1 INSERT</td>
</tr>
<tr>
<td><strong>TOTAL</strong></td>
<td><strong>3.5-9 segundos</strong></td>
<td>Para flujo completo de 3 pasos (promedio: 6s)</td>
</tr>
</tbody>
</table>
<p><strong>Ventajas de esta Arquitectura:</strong></p>
<ul>
<li><strong>Trazabilidad:</strong> El mismo usuarioId aparece en logs de todas las capas</li>
<li><strong>Seguridad:</strong> JWT validado en cada punto, filtrado autom√°tico por academiaId</li>
<li><strong>Flexibilidad:</strong> OpenAI interpreta lenguaje natural y decide qu√© API llamar</li>
<li><strong>UX Natural:</strong> Usuario no necesita conocer la estructura de datos</li>
</ul>
<hr>
<h2 id="8-ventajas-de-la-arquitectura">8. Ventajas de la Arquitectura</h2>
<h3 id="separaci%C3%B3n-de-responsabilidades-soc">Separaci√≥n de Responsabilidades (SoC)</h3>
<p><strong>Android App</strong></p>
<ul>
<li>Responsabilidad √∫nica: Renderizar UI y gestionar estado local</li>
<li>No contiene l√≥gica de negocio</li>
<li>No conoce la estructura de la BD</li>
<li>F√°cil de testear (UI tests con Compose)</li>
</ul>
<p><strong>Backend Chat (Orquestador)</strong></p>
<ul>
<li>Responsabilidad: Seguridad, orquestaci√≥n y traducci√≥n</li>
<li>Valida autenticaci√≥n (JWT)</li>
<li>Coordina LLM ‚Üî API Workers</li>
<li>Estructura respuestas en formato Envelope</li>
<li>Gestiona conversaciones (futuro: historial)</li>
<li><strong>Reenv√≠a JWT sin modificar</strong> (trazabilidad completa)</li>
</ul>
<p><strong>OpenAI GPT-4</strong></p>
<ul>
<li>Responsabilidad: Interpretaci√≥n de lenguaje natural</li>
<li>Decide qu√© herramientas llamar (function calling)</li>
<li>Genera respuestas en lenguaje natural</li>
<li>No tiene acceso directo a datos (seguridad)</li>
</ul>
<p><strong>API Workers</strong></p>
<ul>
<li>Responsabilidad: L√≥gica de negocio y acceso a datos</li>
<li>CRUD completo de todos los recursos</li>
<li>Validaciones de negocio (ej: capacidad m√°xima de aulas)</li>
<li>No conoce el contexto conversacional</li>
<li>API REST est√°ndar (puede ser usada por otros clientes)</li>
</ul>
<h3 id="seguridad-en-capas-defense-in-depth">Seguridad en Capas (Defense in Depth)</h3>
<ol>
<li><strong>Capa 1 - Transporte</strong>: HTTPS/TLS</li>
<li><strong>Capa 2 - Autenticaci√≥n</strong>: JWT √∫nico de punta a punta</li>
<li><strong>Capa 3 - Autorizaci√≥n</strong>: Permisos por rol</li>
<li><strong>Capa 4 - Validaci√≥n</strong>: Input sanitization</li>
<li><strong>Capa 5 - BD</strong>: Prepared statements, permisos limitados</li>
</ol>
<p><strong>Ventaja:</strong> Si una capa falla, las otras siguen protegiendo el sistema.</p>
<h3 id="trazabilidad-completa">Trazabilidad Completa</h3>
<p><strong>Un √∫nico JWT viaja por todo el sistema:</strong></p>
<pre class="hljs"><code><div>Usuario login (JWT generado) 
  ‚Üí Android guarda JWT
    ‚Üí Backend Chat valida JWT
      ‚Üí Backend Chat reenv√≠a MISMO JWT a API Workers
        ‚Üí API Workers valida MISMO JWT
          ‚Üí MySQL registra usuarioId del JWT
</div></code></pre>
<p><strong>Beneficios:</strong></p>
<ul>
<li>Logs distribuidos pueden correlacionarse por usuarioId</li>
<li>Auditor√≠a completa: sabemos qu√© usuario hizo cada acci√≥n en cada capa</li>
<li>No hay &quot;conversi√≥n&quot; de credenciales (menos superficie de ataque)</li>
</ul>
<h3 id="escalabilidad-horizontal">Escalabilidad Horizontal</h3>
<p><strong>Android App</strong></p>
<ul>
<li>Escala autom√°ticamente (cada dispositivo es una instancia)</li>
</ul>
<p><strong>Backend Chat</strong></p>
<ul>
<li>Stateless (excepto conversationId futuro)</li>
<li>Puede escalar horizontalmente con load balancer</li>
<li>Cachear respuestas frecuentes (Redis)</li>
</ul>
<p><strong>API Workers</strong></p>
<ul>
<li>Cloudflare edge network (global)</li>
<li>Escalado autom√°tico seg√∫n tr√°fico</li>
<li>CDN para assets est√°ticos</li>
</ul>
<p><strong>MySQL</strong></p>
<ul>
<li>Read replicas para consultas frecuentes</li>
<li>Sharding por academiaId (multi-tenancy)</li>
<li>√çndices optimizados para queries comunes</li>
</ul>
<h3 id="flexibilidad-y-mantenibilidad">Flexibilidad y Mantenibilidad</h3>
<p><strong>Cambiar LLM sin romper nada</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// Solo cambiar en Backend Chat</span>
<span class="hljs-keyword">const</span> openai = <span class="hljs-keyword">new</span> OpenAI({ <span class="hljs-attr">apiKey</span>: process.env.OPENAI_API_KEY });
<span class="hljs-comment">// Por:</span>
<span class="hljs-keyword">const</span> anthropic = <span class="hljs-keyword">new</span> Anthropic({ <span class="hljs-attr">apiKey</span>: process.env.ANTHROPIC_API_KEY });
</div></code></pre>
<p><strong>A√±adir nuevas funcionalidades</strong></p>
<ul>
<li>Android: Solo renderizar nuevo tipo en <code>when (data.type)</code></li>
<li>Backend: Agregar caso al served-openapi.json</li>
<li>API: Crear nuevo endpoint</li>
</ul>
<p><strong>A/B Testing de Prompts</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> promptVersion = user.id % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? <span class="hljs-string">'prompt_v1'</span> : <span class="hljs-string">'prompt_v2'</span>;
<span class="hljs-keyword">const</span> systemMessage = PROMPTS[promptVersion];
</div></code></pre>
<h3 id="desarrollo-paralelo">Desarrollo Paralelo</h3>
<p><strong>Frontend Team</strong> puede trabajar con mocks mientras <strong>Backend Team</strong> implementa endpoints reales.</p>
<p><strong>QA Team</strong> puede testear UI sin consumir quota de OpenAI.</p>
<p><strong>Product Team</strong> puede validar UX sin necesidad de backend funcional.</p>
<h3 id="auditabilidad-y-debugging">Auditabilidad y Debugging</h3>
<p><strong>Logs Distribuidos:</strong></p>
<ul>
<li>Android: Logcat con tags por componente</li>
<li>Backend Chat: Winston con niveles (info, warn, error)</li>
<li>API Workers: Cloudflare Analytics</li>
<li>MySQL: Slow query log</li>
</ul>
<p><strong>Trazabilidad:</strong></p>
<ul>
<li>Cada mensaje tiene <code>conversationId</code> √∫nico</li>
<li>Timestamps en cada capa</li>
<li>Metadata de modelo y tokens usados</li>
<li><strong>usuarioId del JWT en todos los logs</strong></li>
</ul>
<p><strong>M√©tricas:</strong></p>
<ul>
<li>Latencia por endpoint</li>
<li>Tasa de √©xito/fallo</li>
<li>Uso de tokens (costos)</li>
<li>Endpoints m√°s usados</li>
</ul>
<h3 id="reusabilidad-del-backend-chat-para-otros-proyectos">Reusabilidad del Backend Chat para Otros Proyectos</h3>
<p><strong>Ventaja Clave de la Arquitectura:</strong> El Backend Chat es un <strong>orquestador gen√©rico</strong> que no contiene l√≥gica de negocio espec√≠fica del dominio acad√©mico. Esto significa que puede ser <strong>reutilizado √≠ntegramente</strong> para otros proyectos SaaS con m√≠nimas modificaciones.</p>

<p><strong>Componentes 100% Reutilizables:</strong></p>
<ul>
<li>‚úÖ <strong>Sistema de autenticaci√≥n JWT</strong> - Validaci√≥n y delegaci√≥n de tokens</li>
<li>‚úÖ <strong>Integraci√≥n con OpenAI</strong> - Cliente y gesti√≥n de API calls</li>
<li>‚úÖ <strong>Sistema de tool calling iterativo</strong> - Bucle de hasta 10 iteraciones</li>
<li>‚úÖ <strong>Estructura Envelope</strong> - Contrato de respuesta estandarizado</li>
<li>‚úÖ <strong>Logs y telemetr√≠a E2E</strong> - Reportes HTML autom√°ticos</li>
<li>‚úÖ <strong>Gesti√≥n de errores y retry logic</strong></li>
<li>‚úÖ <strong>Rate limiting y seguridad</strong></li>
<li>‚úÖ <strong>Infraestructura Spring Boot completa</strong></li>
</ul>

<p><strong>¬øQu√© hay que cambiar para usar el Backend Chat en otro proyecto?</strong></p>
<p>Solo <strong>2 archivos de configuraci√≥n</strong> (5-15 horas de trabajo):</p>

<p><strong>1. Whitelist de endpoints</strong> (<code>served-openapi.json</code>):</p>
<pre class="hljs"><code><div><span class="hljs-comment">// Ejemplo: Cambiar de Academia a Cl√≠nica M√©dica</span>
{
  <span class="hljs-string">"allowed_endpoints"</span>: [
    { <span class="hljs-string">"name"</span>: <span class="hljs-string">"pacientes.listar"</span>, <span class="hljs-string">"path"</span>: <span class="hljs-string">"/pacientes"</span>, <span class="hljs-string">"method"</span>: <span class="hljs-string">"GET"</span> },
    { <span class="hljs-string">"name"</span>: <span class="hljs-string">"citas.crear"</span>, <span class="hljs-string">"path"</span>: <span class="hljs-string">"/citas"</span>, <span class="hljs-string">"method"</span>: <span class="hljs-string">"POST"</span> },
    { <span class="hljs-string">"name"</span>: <span class="hljs-string">"historiales.consultar"</span>, <span class="hljs-string">"path"</span>: <span class="hljs-string">"/historiales/:id"</span>, <span class="hljs-string">"method"</span>: <span class="hljs-string">"GET"</span> }
  ]
}
</div></code></pre>

<p><strong>2. System Prompt</strong> (descripci√≥n del dominio):</p>
<pre class="hljs"><code><div><span class="hljs-comment"># application.properties</span>
<span class="hljs-meta">openai.system.prompt</span>=<span class="hljs-string">Eres un asistente de gesti√≥n de cl√≠nica m√©dica. 
Ayudas a m√©dicos y recepcionistas a gestionar pacientes, citas, 
historiales cl√≠nicos y facturaci√≥n. Usa un tono profesional y emp√°tico.</span>
</div></code></pre>

<p><strong>3. Variables de entorno</strong> (apuntar a nueva API):</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Cambiar URL de API Workers</span>
<span class="hljs-meta">API_WORKERS_URL</span>=<span class="hljs-string">https://api-clinica.tudominio.com</span>
<span class="hljs-meta">JWT_DELEGATION_SECRET</span>=<span class="hljs-string">${SHARED_SECRET}</span>  <span class="hljs-comment"># Mismo secret compartido</span>
</div></code></pre>

<p><strong>Ejemplos de Proyectos Compatibles:</strong></p>
<table>
<thead>
<tr>
<th>Dominio</th>
<th>API Workers Necesaria</th>
<th>Cambios en Backend Chat</th>
<th>Tiempo Estimado</th>
</tr>
</thead>
<tbody>
<tr>
<td>üè• <strong>Cl√≠nica M√©dica</strong></td>
<td>Pacientes, Citas, Historiales, Facturaci√≥n</td>
<td>Whitelist + Prompt</td>
<td>10-15h</td>
</tr>
<tr>
<td>üè® <strong>Hotel/Hostal</strong></td>
<td>Habitaciones, Reservas, Check-in/out, Servicios</td>
<td>Whitelist + Prompt</td>
<td>10-15h</td>
</tr>
<tr>
<td>üèãÔ∏è <strong>Gimnasio</strong></td>
<td>Socios, Clases, Entrenamientos, Membres√≠as</td>
<td>Whitelist + Prompt</td>
<td>10-15h</td>
</tr>
<tr>
<td>üçï <strong>Restaurante</strong></td>
<td>Mesas, Pedidos, Reservas, Inventario</td>
<td>Whitelist + Prompt</td>
<td>10-15h</td>
</tr>
<tr>
<td>üöó <strong>Taller Mec√°nico</strong></td>
<td>Veh√≠culos, Reparaciones, Presupuestos, Stock</td>
<td>Whitelist + Prompt</td>
<td>10-15h</td>
</tr>
</tbody>
</table>

<p><strong>Ventaja Competitiva:</strong></p>
<ul>
<li>üí∞ <strong>Ahorro de ‚Ç¨6,400 - ‚Ç¨8,000</strong> por cada nuevo proyecto</li>
<li>‚ö° <strong>Time-to-market reducido en 25-30%</strong></li>
<li>üîí <strong>Sistema de seguridad ya probado</strong></li>
<li>üìä <strong>Telemetr√≠a y logs ya implementados</strong></li>
<li>üß™ <strong>Testing y CI/CD reutilizables</strong></li>
</ul>

<p><strong>Arquitectura Multi-Proyecto:</strong></p>
<pre class="hljs"><code><div>Backend Chat (√önico - Compartido)
       ‚Üì
   ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚Üì       ‚Üì       ‚Üì          ‚Üì
API       API     API        API
Academias Cl√≠nicas Gimnasios Hoteles
   ‚Üì       ‚Üì       ‚Üì          ‚Üì
 MySQL   MySQL   MySQL      MySQL
(BD 1)  (BD 2)  (BD 3)    (BD 4)
</div></code></pre>

<p><strong>Nota Importante:</strong> El JWT debe incluir un claim que identifique el proyecto/dominio para que el Backend Chat sepa a qu√© API Workers dirigir las peticiones. Esto se puede implementar con un campo <code>projectId</code> o <code>domain</code> en el token.</p>
<hr>
<h2 id="9-tecnolog%C3%ADas-utilizadas">9. Tecnolog√≠as Utilizadas</h2>
<h3 id="frontend-android">Frontend (Android)</h3>
<table>
<thead>
<tr>
<th>Tecnolog√≠a</th>
<th>Versi√≥n</th>
<th>Uso</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kotlin</td>
<td>1.9.x</td>
<td>Lenguaje principal</td>
</tr>
<tr>
<td>Jetpack Compose</td>
<td>1.5.x</td>
<td>UI declarativa</td>
</tr>
<tr>
<td>Material 3</td>
<td>1.1.x</td>
<td>Design system</td>
</tr>
<tr>
<td>Retrofit</td>
<td>2.9.x</td>
<td>Cliente HTTP</td>
</tr>
<tr>
<td>OkHttp</td>
<td>4.11.x</td>
<td>HTTP client (interceptors para JWT)</td>
</tr>
<tr>
<td>Kotlinx Serialization</td>
<td>1.6.x</td>
<td>JSON parsing</td>
</tr>
<tr>
<td>DataStore</td>
<td>1.0.x</td>
<td>Almacenamiento de preferencias (JWT)</td>
</tr>
<tr>
<td>ViewModel</td>
<td>2.6.x</td>
<td>Gesti√≥n de estado</td>
</tr>
<tr>
<td>Navigation Compose</td>
<td>2.7.x</td>
<td>Navegaci√≥n declarativa</td>
</tr>
<tr>
<td>Coroutines</td>
<td>1.7.x</td>
<td>Programaci√≥n as√≠ncrona</td>
</tr>
<tr>
<td>StateFlow</td>
<td>1.7.x</td>
<td>Reactive state management</td>
</tr>
</tbody>
</table>
<h3 id="backend-chat-spring-boot">Backend Chat (Spring Boot)</h3>
<table>
<thead>
<tr>
<th>Tecnolog√≠a</th>
<th>Versi√≥n</th>
<th>Uso</th>
</tr>
</thead>
<tbody>
<tr>
<td>Java</td>
<td>21 LTS</td>
<td>Lenguaje principal</td>
</tr>
<tr>
<td>Spring Boot</td>
<td>3.5.5</td>
<td>Framework web</td>
</tr>
<tr>
<td>OpenAI Java SDK</td>
<td>Custom</td>
<td>Cliente de OpenAI</td>
</tr>
<tr>
<td>OpenAI Model</td>
<td><strong>gpt-4o</strong></td>
<td>Modelo de lenguaje (configurable v√≠a property)</td>
</tr>
<tr>
<td>jjwt (Java JWT)</td>
<td>0.11.x</td>
<td>Validaci√≥n JWT</td>
</tr>
<tr>
<td>Jackson</td>
<td>2.15.x</td>
<td>JSON parsing</td>
</tr>
<tr>
<td>Spring Security</td>
<td>6.x</td>
<td>Security headers</td>
</tr>
<tr>
<td>Logback</td>
<td>1.4.x</td>
<td>Logging</td>
</tr>
<tr>
<td>Maven</td>
<td>3.9.x</td>
<td>Build tool</td>
</tr>
</tbody>
</table>
<h3 id="api-workers-pythonflask">API Workers (Python/Flask)</h3>
<table>
<thead>
<tr>
<th>Tecnolog√≠a</th>
<th>Versi√≥n</th>
<th>Uso</th>
</tr>
</thead>
<tbody>
<tr>
<td>Python</td>
<td>3.11.x</td>
<td>Lenguaje principal</td>
</tr>
<tr>
<td>Flask</td>
<td>3.0.x</td>
<td>Framework web</td>
</tr>
<tr>
<td>mysql-connector-python</td>
<td>8.x</td>
<td>Cliente MySQL (con prepared statements)</td>
</tr>
<tr>
<td>PyJWT</td>
<td>2.8.x</td>
<td>Generaci√≥n y validaci√≥n JWT</td>
</tr>
<tr>
<td>Argon2-cffi</td>
<td>23.x</td>
<td>Hashing de passwords (superior a bcrypt)</td>
</tr>
<tr>
<td>Marshmallow</td>
<td>3.20.x</td>
<td>Validaci√≥n de schemas</td>
</tr>
<tr>
<td>Flask-CORS</td>
<td>4.0.x</td>
<td>CORS middleware</td>
</tr>
<tr>
<td>python-dotenv</td>
<td>1.0.x</td>
<td>Variables de entorno</td>
</tr>
<tr>
<td>Alembic</td>
<td>1.13.x</td>
<td>Migraciones de BD</td>
</tr>
</tbody>
</table>
<h3 id="base-de-datos">Base de Datos</h3>
<table>
<thead>
<tr>
<th>Tecnolog√≠a</th>
<th>Versi√≥n</th>
<th>Uso</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySQL</td>
<td>8.0.x</td>
<td>Base de datos relacional</td>
</tr>
<tr>
<td>InnoDB</td>
<td>Default</td>
<td>Motor de almacenamiento</td>
</tr>
<tr>
<td>AWS RDS</td>
<td>-</td>
<td>Servicio de base de datos gestionado</td>
</tr>
</tbody>
</table>
<h3 id="devops-y-despliegue">DevOps y Despliegue</h3>
<table>
<thead>
<tr>
<th>Tecnolog√≠a</th>
<th>Versi√≥n</th>
<th>Uso</th>
</tr>
</thead>
<tbody>
<tr>
<td>AWS Elastic Beanstalk</td>
<td>-</td>
<td>Hosting de Backend Chat y API Workers</td>
</tr>
<tr>
<td>AWS RDS</td>
<td>MySQL 8.0</td>
<td>Base de datos en producci√≥n</td>
</tr>
<tr>
<td>Let's Encrypt</td>
<td>-</td>
<td>Certificados SSL/TLS gratuitos</td>
</tr>
<tr>
<td>GitHub Actions</td>
<td>-</td>
<td>CI/CD</td>
</tr>
<tr>
<td>Docker</td>
<td>24.x</td>
<td>Containerizaci√≥n (local development)</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="10-testing-y-calidad">10. Testing y Calidad</h2>
<h3 id="tipos-de-testing-implementados">Tipos de Testing Implementados</h3>
<p>El proyecto incluye testing a m√∫ltiples niveles para garantizar calidad y fiabilidad:</p>
<h4 id="1-tests-unitarios-android">1. Tests Unitarios (Android)</h4>
<p><strong>Ubicaci√≥n:</strong> <code>app/src/test/</code></p>
<pre class="hljs"><code><div><span class="hljs-comment">// Ejemplo: MockDataTest.kt</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataTest</span> </span>{
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> `generarSesionesDinamicas genera estados correctos segun hora`<span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> fecha = LocalDate.now()
        <span class="hljs-keyword">val</span> sesiones = MockData.generarSesionesDinamicas(fecha, <span class="hljs-string">"Test Profesor"</span>)
        
        <span class="hljs-comment">// Verificar que sesiones pasadas est√°n completadas</span>
        <span class="hljs-keyword">val</span> ahora = LocalTime.now()
        sesiones.forEach { sesion -&gt;
            <span class="hljs-keyword">if</span> (sesion.horaFin &lt; ahora) {
                assertEquals(<span class="hljs-string">"completada"</span>, sesion.estado)
            }
        }
    }
}
</div></code></pre>
<p><strong>Ejecutar tests unitarios:</strong></p>
<pre class="hljs"><code><div>./gradlew <span class="hljs-built_in">test</span>
</div></code></pre>
<h4 id="2-tests-de-integraci%C3%B3n-backend-chat">2. Tests de Integraci√≥n (Backend Chat)</h4>
<p><strong>Ubicaci√≥n:</strong> <code>src/test/java/com/workers/profesores/</code></p>
<pre class="hljs"><code><div><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChatControllerIntegrationTest</span> </span>{
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testChatEndpointWithValidJWT</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// Simula request completo con JWT v√°lido</span>
        <span class="hljs-comment">// Verifica respuesta Envelope correcta</span>
    }
}
</div></code></pre>
<p><strong>Ejecutar tests de integraci√≥n:</strong></p>
<pre class="hljs"><code><div>./mvnw <span class="hljs-built_in">test</span>
</div></code></pre>
<h4 id="3-tests-e2e-con-trazabilidad-html">3. Tests E2E con Trazabilidad HTML</h4>
<p><strong>El sistema m√°s avanzado:</strong> Backend Chat genera reportes HTML autom√°ticos de cada flujo E2E completo.</p>
<p><strong>Activaci√≥n:</strong></p>
<p>La generaci√≥n de reportes HTML se controla mediante la cabecera HTTP <code>X-Flow-Diagram</code>:</p>
<pre class="hljs"><code><div>curl -X POST http://localhost:8080/chat \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -H <span class="hljs-string">"Authorization: Bearer YOUR_JWT_TOKEN"</span> \
  -H <span class="hljs-string">"X-Flow-Diagram: true"</span> \
  -d <span class="hljs-string">'{
    "messages": [
      {"role": "user", "content": "Listar usuarios"}
    ]
  }'</span>
</div></code></pre>
<p><strong>Configuraci√≥n:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># application.properties</span>
<span class="hljs-comment"># Controla si el modo debug est√° activo (afecta logging detallado)</span>
<span class="hljs-meta">backend.debug.dev</span>=<span class="hljs-string">true   # Desarrollo: verbose logging</span>
<span class="hljs-meta">backend.debug.prod</span>=<span class="hljs-string">false # Producci√≥n: logging m√≠nimo</span>
</div></code></pre>
<p><strong>Ubicaci√≥n de reportes:</strong></p>
<pre class="hljs"><code><div>backend-chat-openai-worker-profesores/documentacion/
  ‚îú‚îÄ‚îÄ prueba-20251023-211011-121.html
  ‚îú‚îÄ‚îÄ prueba-20251024-103045-234.html
  ‚îî‚îÄ‚îÄ ...
</div></code></pre>
<p><strong>Contenido del reporte HTML:</strong></p>
<p>El HTML generado incluye una tabla cronol√≥gica con cada paso del flujo:</p>
<table>
<thead>
<tr>
<th>Paso</th>
<th>Descripci√≥n</th>
<th>Timestamp</th>
</tr>
</thead>
<tbody>
<tr>
<td>1. ChatController</td>
<td>Recibida petici√≥n POST /chat</td>
<td>2025-10-23 21:10:11.122</td>
</tr>
<tr>
<td>2. ChatController</td>
<td>JWT v√°lido: usuarioId=10, roles=[Admin_academia]</td>
<td>2025-10-23 21:10:11.125</td>
</tr>
<tr>
<td>3. ChatService</td>
<td>Inicio de runChat</td>
<td>2025-10-23 21:10:11.126</td>
</tr>
<tr>
<td>4. ChatService</td>
<td>Delegated token creado: preview=Bearer e...</td>
<td>2025-10-23 21:10:11.136</td>
</tr>
<tr>
<td>5. OpenAI</td>
<td>Llamada a OpenAI (iteraci√≥n 0)</td>
<td>2025-10-23 21:10:11.147</td>
</tr>
<tr>
<td>6. OpenAIClient</td>
<td>Procesando tool_call: call_api</td>
<td>2025-10-23 21:10:15.206</td>
</tr>
<tr>
<td>7. ApiProxyService</td>
<td>Llamada a API: usuarios.listar_usuarios (GET)</td>
<td>2025-10-23 21:10:15.226</td>
</tr>
<tr>
<td>8. Telemetry</td>
<td>api_call_ms=311 (single)</td>
<td>2025-10-23 21:10:15.538</td>
</tr>
<tr>
<td>9. OpenAI</td>
<td>Segunda llamada a OpenAI (sin herramientas)</td>
<td>2025-10-23 21:10:15.587</td>
</tr>
<tr>
<td>10. ChatController</td>
<td>Respuesta generada (JSON completo)</td>
<td>2025-10-23 21:10:19.473</td>
</tr>
</tbody>
</table>
<p><strong>M√©tricas autom√°ticas incluidas:</strong></p>
<ul>
<li><code>seed_ms</code>: Tiempo de preparaci√≥n de contexto</li>
<li><code>parse_ms</code>: Tiempo de parseo de respuesta OpenAI</li>
<li><code>api_call_ms</code>: Tiempo de llamada a API Workers</li>
<li><code>second_ms</code>: Tiempo del segundo turno con OpenAI</li>
<li><code>decision_ms</code>: Tiempo total de decisi√≥n (ambos turnos)</li>
<li><code>render_ms</code>: Tiempo de renderizado de respuesta</li>
<li><code>controller_ms_desde_inicio</code>: Tiempo total desde request hasta response</li>
</ul>
<p><strong>Ejemplo de salida HTML:</strong></p>
<p>Ver archivo real: <code>documentacion/prueba-20251023-211011-121.html</code></p>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Flujo de la prueba: prueba-20251023-211011-121<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>30. ChatController<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>Respuesta generada por ChatService (pretty)={
      "status": "success",
      "message": "Te muestro el resultado de la b√∫squeda de usuarios: 15 usuarios encontrados (p√°gina 1 de 2).",
      "data": { ... }
    }<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>2025-10-23 21:10:19.473<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
</div></code></pre>
<p><strong>Cu√°ndo usar reportes HTML:</strong></p>
<p>‚úÖ <strong>Activar (X-Flow-Diagram: true):</strong></p>
<ul>
<li>Testing manual con Postman/curl</li>
<li>Debugging de flujos complejos</li>
<li>Demos para stakeholders</li>
<li>Auditor√≠as de performance</li>
<li>An√°lisis de prompts de OpenAI</li>
</ul>
<p>‚ùå <strong>Desactivar (omitir cabecera):</strong></p>
<ul>
<li>Producci√≥n (overhead de I/O)</li>
<li>Tests automatizados masivos</li>
<li>Requests de usuarios reales</li>
</ul>
<p><strong>Ventajas del sistema de reportes:</strong></p>
<ol>
<li><strong>Trazabilidad Completa:</strong> Ve cada paso del flujo OpenAI ‚Üí API Workers ‚Üí MySQL</li>
<li><strong>Debugging Visual:</strong> HTML legible con timestamps precisos</li>
<li><strong>Performance Profiling:</strong> Identifica cuellos de botella por paso</li>
<li><strong>Auditor√≠a:</strong> Registro permanente de decisiones del LLM</li>
<li><strong>Documentaci√≥n Viva:</strong> Los HTMLs sirven como ejemplos reales</li>
</ol>
<h4 id="4-tests-de-api-postmanthunder-client">4. Tests de API (Postman/Thunder Client)</h4>
<p><strong>Colecciones disponibles:</strong></p>
<ul>
<li><code>postman/Academia_Chat_API.json</code> (todas las rutas)</li>
<li>Incluye tests automatizados de cada endpoint</li>
<li>Variables de entorno para dev/prod</li>
</ul>
<p><strong>Ejecutar colecci√≥n:</strong></p>
<pre class="hljs"><code><div>newman run postman/Academia_Chat_API.json --environment dev.json
</div></code></pre>
<h4 id="5-tests-de-ui-android---espresso">5. Tests de UI (Android - Espresso)</h4>
<p><strong>Ubicaci√≥n:</strong> <code>app/src/androidTest/</code></p>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testChatScreenRendersMessages</span><span class="hljs-params">()</span></span> {
    composeTestRule.setContent {
        ChatScreen(...)
    }
    
    composeTestRule.onNodeWithText(<span class="hljs-string">"Mis Clases de Hoy"</span>).assertIsDisplayed()
}
</div></code></pre>
<h3 id="estrategia-de-testing-por-entorno">Estrategia de Testing por Entorno</h3>
<table>
<thead>
<tr>
<th>Entorno</th>
<th>Tests Ejecutados</th>
<th>Frecuencia</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Local (Dev)</strong></td>
<td>Unitarios + Mocks</td>
<td>En cada cambio</td>
</tr>
<tr>
<td><strong>CI/CD (GitHub Actions)</strong></td>
<td>Unitarios + Integraci√≥n</td>
<td>En cada push</td>
</tr>
<tr>
<td><strong>Staging</strong></td>
<td>E2E con HTML + Postman</td>
<td>Antes de cada release</td>
</tr>
<tr>
<td><strong>Producci√≥n</strong></td>
<td>Smoke tests + Monitoreo</td>
<td>Post-deployment</td>
</tr>
</tbody>
</table>
<h3 id="cobertura-de-c%C3%B3digo">Cobertura de C√≥digo</h3>
<p><strong>Objetivos:</strong></p>
<ul>
<li>Android: &gt;80% cobertura en ViewModels y Repositories</li>
<li>Backend Chat: &gt;70% cobertura en Services</li>
<li>API Workers: &gt;75% cobertura en Routes y Logic</li>
</ul>
<p><strong>Generar reporte de cobertura:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Android</span>
./gradlew testDebugUnitTestCoverage

<span class="hljs-comment"># Backend Chat</span>
./mvnw jacoco:report

<span class="hljs-comment"># API Workers</span>
pytest --cov=src --cov-report=html
</div></code></pre>
<hr>
<h2 id="11-plan-de-despliegue-en-producci%C3%B3n">11. Plan de Despliegue en Producci√≥n</h2>
<h3 id="estado-actual-del-proyecto">Estado Actual del Proyecto</h3>
<p><strong>Fase 1: MVP (‚úÖ COMPLETADO) - Listo para Demo</strong></p>
<p><strong>Android App:</strong></p>
<ul>
<li>‚úÖ ChatScreen completamente funcional</li>
<li>‚úÖ NavigationDrawer con men√∫ din√°mico por rol</li>
<li>‚úÖ MockChatRepository con casos de uso completos</li>
<li>‚úÖ RealChatRepository implementado y testeado</li>
<li>‚úÖ SessionStore con gesti√≥n de tokens JWT</li>
<li>‚úÖ LoginScreen con validaci√≥n y manejo de errores</li>
<li>‚úÖ Integraci√≥n completa con Backend Chat en producci√≥n</li>
</ul>
<p><strong>Backend Chat (Spring Boot):</strong></p>
<ul>
<li>‚úÖ Servidor funcional con middleware JWT</li>
<li>‚úÖ Integraci√≥n OpenAI GPT-4 con function calling</li>
<li>‚úÖ Endpoint POST /chat con validaci√≥n completa</li>
<li>‚úÖ Sistema de prompts (served-openapi.json)</li>
<li>‚úÖ Manejo de errores y retry logic</li>
<li>‚úÖ Logging con telemetr√≠a detallada</li>
<li>‚úÖ Rate limiting configurado</li>
<li>‚úÖ Middleware de reenv√≠o de JWT (token delegado)</li>
<li>‚úÖ Reportes HTML E2E para debugging</li>
</ul>
<p><strong>API Workers (Python/Flask):</strong></p>
<ul>
<li>‚úÖ Endpoints de autenticaci√≥n (login, refresh, logout)</li>
<li>‚úÖ Generaci√≥n y validaci√≥n de JWT</li>
<li>‚úÖ Endpoints completos de alumnos, cursos, sesiones, anotaciones</li>
<li>‚úÖ Middleware de validaci√≥n JWT</li>
<li>‚úÖ Conexi√≥n a MySQL con pool de conexiones</li>
<li>‚úÖ Migraciones de BD (create_database.sql)</li>
<li>‚úÖ Seeds de datos de prueba</li>
<li>‚úÖ Tests de integraci√≥n funcionales</li>
</ul>
<p><strong>Base de Datos:</strong></p>
<ul>
<li>‚úÖ MySQL 8.0 en AWS RDS</li>
<li>‚úÖ 26 tablas con relaciones completas</li>
<li>‚úÖ √çndices optimizados</li>
<li>‚úÖ Backups autom√°ticos configurados</li>
</ul>
<h3 id="arquitectura-de-despliegue-en-aws">Arquitectura de Despliegue en AWS</h3>
<pre class="hljs"><code><div>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ USUARIOS M√ìVILES (Android App)                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ HTTPS/TLS 1.3
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ AWS ELASTIC BEANSTALK - Backend Chat                        ‚îÇ
‚îÇ - Entorno: Java 21 (Corretto)                              ‚îÇ
‚îÇ - Tipo: Single Instance t2.micro (Free Tier)               ‚îÇ
‚îÇ - HTTPS: Let's Encrypt (certbot autom√°tico)                ‚îÇ
‚îÇ - URL: backend-chat.elasticbeanstalk.com                   ‚îÇ
‚îÇ - Health check: /health                                     ‚îÇ
‚îÇ - Auto-scaling: Disabled (costo $0 primer a√±o)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ HTTPS (token delegado - JWT)
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ AWS ELASTIC BEANSTALK - API Workers                         ‚îÇ
‚îÇ - Entorno: Python 3.11                                      ‚îÇ
‚îÇ - Tipo: Single Instance t2.micro (Free Tier)               ‚îÇ
‚îÇ - HTTPS: Let's Encrypt                                      ‚îÇ
‚îÇ - URL: api-workers.elasticbeanstalk.com                    ‚îÇ
‚îÇ - Health check: /health                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ MySQL Protocol over TLS
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ AWS RDS - MySQL 8.0                                          ‚îÇ
‚îÇ - Instancia: db.t3.micro (Free Tier)                       ‚îÇ
‚îÇ - Almacenamiento: 20 GB SSD                                 ‚îÇ
‚îÇ - Multi-AZ: No (para reducir costos)                       ‚îÇ
‚îÇ - Backups: Automated (7 d√≠as retention)                    ‚îÇ
‚îÇ - Conexi√≥n: SSL/TLS obligatorio                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</div></code></pre>
<h3 id="costos-mensuales-estimados">Costos Mensuales Estimados</h3>
<p><strong>Opci√≥n 1: Free Tier (Primer A√±o) - $0/mes</strong></p>
<ul>
<li>Elastic Beanstalk Backend Chat: $0 (t2.micro Free Tier)</li>
<li>Elastic Beanstalk API Workers: $0 (t2.micro Free Tier)</li>
<li>RDS MySQL: $0 (db.t3.micro Free Tier 750h/mes)</li>
<li><strong>Total: $0/mes</strong> ‚úÖ</li>
</ul>
<p><strong>Opci√≥n 2: Post Free Tier - ~$11-13/mes</strong></p>
<ul>
<li>EC2 t2.micro (Backend Chat): ~$8.50/mes</li>
<li>EC2 t2.micro (API Workers): Incluido en t2.micro de Backend</li>
<li>RDS db.t3.micro: ~$15/mes</li>
<li>Elastic IP: $0 (mientras est√© asignado)</li>
<li><strong>Total: ~$11-13/mes</strong> (acad√©mico sostenible)</li>
</ul>
<p><strong>Opci√≥n 3: Producci√≥n Escalada - ~$65-85/mes</strong></p>
<ul>
<li>Application Load Balancer: ~$16/mes</li>
<li>EC2 t3.small x2 (Auto-scaling): ~$30/mes</li>
<li>RDS db.t3.small (Multi-AZ): ~$30/mes</li>
<li>CloudWatch + S3: ~$5/mes</li>
<li><strong>Total: ~$65-85/mes</strong> (50-100 usuarios concurrentes)</li>
</ul>
<p>Ver documento completo: <code>docs/ESCALADO_A_PRODUCCION_COMERCIAL.md</code></p>
<h3 id="pasos-de-despliegue">Pasos de Despliegue</h3>
<p><strong>Fase 2: Despliegue Inicial (1-2 semanas)</strong></p>
<ol>
<li>
<p><strong>Preparar Backend Chat para AWS:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Crear archivo .ebextensions/01-app-config.config</span>
<span class="hljs-comment"># Configurar variables de entorno en EB</span>
<span class="hljs-comment"># Probar localmente con perfil prod</span>
</div></code></pre>
</li>
<li>
<p><strong>Desplegar Backend Chat:</strong></p>
<pre class="hljs"><code><div>eb init backend-chat --region us-east-1 --platform java-21
eb create backend-chat-env --single --instance-type t2.micro
eb setenv OPENAI_API_KEY=sk-xxx JWT_DELEGATION_SECRET=xxx
eb deploy
</div></code></pre>
</li>
<li>
<p><strong>Configurar HTTPS con Let's Encrypt:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># SSH a la instancia</span>
sudo certbot --nginx -d backend-chat.tu-dominio.com
<span class="hljs-comment"># Configurar renovaci√≥n autom√°tica</span>
sudo crontab -e
<span class="hljs-comment"># 0 0 1 * * certbot renew --quiet</span>
</div></code></pre>
</li>
<li>
<p><strong>Desplegar API Workers:</strong></p>
<pre class="hljs"><code><div>eb init api-workers --region us-east-1 --platform python-3.11
eb create api-workers-env --single --instance-type t2.micro
eb setenv DATABASE_URL=mysql://... JWT_SECRET_KEY=xxx
eb deploy
</div></code></pre>
</li>
<li>
<p><strong>Configurar RDS MySQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Crear instancia RDS desde consola AWS</span>
<span class="hljs-comment"># Aplicar create_database.sql</span>
mysql -h academia-db.xxx.rds.amazonaws.com -u admin -p &lt; docs/create_database.sql

<span class="hljs-comment"># Ejecutar seeds</span>
python init_db_pruebas_test.py
</div></code></pre>
</li>
<li>
<p><strong>Actualizar Android App:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// build.gradle.kts</span>
buildConfigField(<span class="hljs-string">"String"</span>, <span class="hljs-string">"BACKEND_CHAT_URL"</span>, 
  <span class="hljs-string">"\"https://backend-chat.elasticbeanstalk.com\""</span>)
buildConfigField(<span class="hljs-string">"boolean"</span>, <span class="hljs-string">"USE_MOCK"</span>, <span class="hljs-string">"false"</span>)
</div></code></pre>
</li>
<li>
<p><strong>Testing E2E Completo:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Activar X-Flow-Diagram en Postman</span>
<span class="hljs-comment"># Verificar generaci√≥n de HTMLs</span>
<span class="hljs-comment"># Validar tiempos de respuesta</span>
<span class="hljs-comment"># Verificar trazabilidad JWT end-to-end</span>
</div></code></pre>
</li>
</ol>
<p><strong>Fase 3: Optimizaci√≥n y Monitoreo (Continuo)</strong></p>
<ol>
<li>
<p><strong>CloudWatch Alarms:</strong></p>
<ul>
<li>CPU &gt; 80% durante 5 minutos</li>
<li>Disco &gt; 90%</li>
<li>Health check failures</li>
</ul>
</li>
<li>
<p><strong>Logs Centralizados:</strong></p>
<ul>
<li>CloudWatch Logs para Backend Chat</li>
<li>CloudWatch Logs para API Workers</li>
<li>Query Insights en RDS</li>
</ul>
</li>
<li>
<p><strong>Performance:</strong></p>
<ul>
<li>Cach√© de respuestas frecuentes (Redis futuro)</li>
<li>CDN para assets est√°ticos (CloudFront futuro)</li>
<li>Optimizaci√≥n de queries MySQL (√≠ndices)</li>
</ul>
</li>
</ol>
<h3 id="checklist-de-pre-producci%C3%B3n">Checklist de Pre-Producci√≥n</h3>
<ul>
<li><input type="checkbox" id="checkbox0"><label for="checkbox0">Todos los secrets en variables de entorno (NO en c√≥digo)</label></li>
<li><input type="checkbox" id="checkbox1"><label for="checkbox1">HTTPS configurado con certificados v√°lidos</label></li>
<li><input type="checkbox" id="checkbox2"><label for="checkbox2">Backups autom√°ticos de RDS activados</label></li>
<li><input type="checkbox" id="checkbox3"><label for="checkbox3">Health checks respondiendo correctamente</label></li>
<li><input type="checkbox" id="checkbox4"><label for="checkbox4">Logs de error capturando excepciones</label></li>
<li><input type="checkbox" id="checkbox5"><label for="checkbox5">Rate limiting configurado en ambos backends</label></li>
<li><input type="checkbox" id="checkbox6"><label for="checkbox6">CORS restrictivo (solo dominios autorizados)</label></li>
<li><input type="checkbox" id="checkbox7"><label for="checkbox7">SQL Injection prevenci√≥n (prepared statements)</label></li>
<li><input type="checkbox" id="checkbox8"><label for="checkbox8">JWT secrets largos y aleatorios (&gt;32 caracteres)</label></li>
<li><input type="checkbox" id="checkbox9"><label for="checkbox9">Tests E2E pasando con reportes HTML</label></li>
<li><input type="checkbox" id="checkbox10"><label for="checkbox10">Documentaci√≥n actualizada (este documento)</label></li>
<li><input type="checkbox" id="checkbox11"><label for="checkbox11">Plan de rollback preparado</label></li>
<li><input type="checkbox" id="checkbox12"><label for="checkbox12">Monitoreo configurado (CloudWatch/Datadog)</label></li>
</ul>
<h3 id="estrategia-de-rollback">Estrategia de Rollback</h3>
<p>En caso de problemas en producci√≥n:</p>
<ol>
<li>
<p><strong>Rollback de Backend:</strong></p>
<pre class="hljs"><code><div>eb deploy --version &lt;version-anterior&gt;
</div></code></pre>
</li>
<li>
<p><strong>Rollback de BD (si aplica):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Restaurar desde snapshot m√°s reciente</span>
aws rds restore-db-instance-from-db-snapshot --db-instance-identifier ...
</div></code></pre>
</li>
<li>
<p><strong>Rollback de Android:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Compilar versi√≥n anterior</span>
git checkout &lt;tag-anterior&gt;
./gradlew assembleRelease
<span class="hljs-comment"># Subir a Google Play como hotfix</span>
</div></code></pre>
</li>
</ol>
<h3 id="documentaci%C3%B3n-de-referencia">Documentaci√≥n de Referencia</h3>
<ul>
<li><strong>Despliegue Backend Chat:</strong> <code>docs/DEPLOY_AWS_HTTPS.md</code></li>
<li><strong>Despliegue API Workers:</strong> <code>docs/DEPLOY_AWS_API_WORKERS.md</code></li>
<li><strong>Escalado Comercial:</strong> <code>docs/ESCALADO_A_PRODUCCION_COMERCIAL.md</code></li>
<li><strong>Seguridad Android:</strong> <code>documentacion/SEGURIDAD_ENCRIPTACION.md</code></li>
<li><strong>Testing E2E:</strong> <code>documentacion/prueba-20251023-211011-121.html</code> (ejemplo)</li>
</ul>
<hr>
<h2 id="12-an%C3%A1lisis-econ%C3%B3mico-del-proyecto">12. An√°lisis Econ√≥mico del Proyecto</h2>

<p>Esta secci√≥n analiza la viabilidad econ√≥mica del proyecto desde una perspectiva de producto SaaS (Software as a Service), incluyendo estimaciones de desarrollo, costes operativos y proyecciones de rentabilidad.</p>

<h3 id="121-estimaci%C3%B3n-de-horas-de-desarrollo">12.1 - Estimaci√≥n de Horas de Desarrollo</h3>

<p>El desarrollo completo del sistema Academia Chat-Driven requiere trabajo en m√∫ltiples capas tecnol√≥gicas. A continuaci√≥n se detallan las horas estimadas por componente:</p>

<table>
<thead>
<tr>
<th>Componente</th>
<th>Horas Estimadas</th>
<th>Coste/Hora</th>
<th>Coste Total</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Android App (Kotlin/Compose)</strong></td>
<td>240-300h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨9,600 - ‚Ç¨12,000</td>
</tr>
<tr>
<td>- UI/UX con Jetpack Compose</td>
<td>80-100h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨3,200 - ‚Ç¨4,000</td>
</tr>
<tr>
<td>- ViewModels y l√≥gica de presentaci√≥n</td>
<td>60-80h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨2,400 - ‚Ç¨3,200</td>
</tr>
<tr>
<td>- Integraci√≥n Retrofit + gesti√≥n de estado</td>
<td>50-60h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨2,000 - ‚Ç¨2,400</td>
</tr>
<tr>
<td>- Sistema de navegaci√≥n y permisos</td>
<td>30-40h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨1,200 - ‚Ç¨1,600</td>
</tr>
<tr>
<td>- Testing UI (Espresso/Compose)</td>
<td>20-20h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨800 - ‚Ç¨800</td>
</tr>
<tr>
<td><strong>Backend Chat (Spring Boot/OpenAI)</strong></td>
<td>160-200h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨6,400 - ‚Ç¨8,000</td>
</tr>
<tr>
<td>- Integraci√≥n OpenAI + tool calling</td>
<td>60-80h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨2,400 - ‚Ç¨3,200</td>
</tr>
<tr>
<td>- Sistema de autenticaci√≥n JWT</td>
<td>30-40h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨1,200 - ‚Ç¨1,600</td>
</tr>
<tr>
<td>- Proxy a API Workers + whitelist</td>
<td>40-50h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨1,600 - ‚Ç¨2,000</td>
</tr>
<tr>
<td>- Logs, telemetr√≠a y reportes HTML</td>
<td>20-30h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨800 - ‚Ç¨1,200</td>
</tr>
<tr>
<td>- Testing de integraci√≥n</td>
<td>10-0h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨400 - ‚Ç¨0</td>
</tr>
<tr>
<td><strong>API Workers (Python/Flask)</strong></td>
<td>200-240h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨8,000 - ‚Ç¨9,600</td>
</tr>
<tr>
<td>- Endpoints CRUD (20 recursos)</td>
<td>80-100h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨3,200 - ‚Ç¨4,000</td>
</tr>
<tr>
<td>- L√≥gica de negocio y validaciones</td>
<td>50-60h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨2,000 - ‚Ç¨2,400</td>
</tr>
<tr>
<td>- Sistema de autenticaci√≥n (login/refresh)</td>
<td>30-40h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨1,200 - ‚Ç¨1,600</td>
</tr>
<tr>
<td>- Schemas Marshmallow + OpenAPI</td>
<td>25-30h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨1,000 - ‚Ç¨1,200</td>
</tr>
<tr>
<td>- Testing unitario y de integraci√≥n</td>
<td>15-10h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨600 - ‚Ç¨400</td>
</tr>
<tr>
<td><strong>Base de Datos (Modelo + Migraciones)</strong></td>
<td>60-80h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨2,400 - ‚Ç¨3,200</td>
</tr>
<tr>
<td>- Dise√±o del modelo de datos (20 tablas)</td>
<td>25-30h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨1,000 - ‚Ç¨1,200</td>
</tr>
<tr>
<td>- Scripts SQL + triggers + √≠ndices</td>
<td>20-30h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨800 - ‚Ç¨1,200</td>
</tr>
<tr>
<td>- Migraciones con Alembic</td>
<td>10-15h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨400 - ‚Ç¨600</td>
</tr>
<tr>
<td>- Seeds de datos de prueba</td>
<td>5-5h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨200 - ‚Ç¨200</td>
</tr>
<tr>
<td><strong>Testing + Documentaci√≥n</strong></td>
<td>80-100h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨3,200 - ‚Ç¨4,000</td>
</tr>
<tr>
<td>- Documentaci√≥n t√©cnica (este documento)</td>
<td>30-40h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨1,200 - ‚Ç¨1,600</td>
</tr>
<tr>
<td>- Tests E2E y casos de uso</td>
<td>25-30h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨1,000 - ‚Ç¨1,200</td>
</tr>
<tr>
<td>- Colecciones Postman/Thunder Client</td>
<td>10-15h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨400 - ‚Ç¨600</td>
</tr>
<tr>
<td>- Documentaci√≥n de usuario final</td>
<td>15-15h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨600 - ‚Ç¨600</td>
</tr>
<tr>
<td><strong>DevOps + Despliegue</strong></td>
<td>40-60h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨1,600 - ‚Ç¨2,400</td>
</tr>
<tr>
<td>- Configuraci√≥n AWS Elastic Beanstalk</td>
<td>15-20h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨600 - ‚Ç¨800</td>
</tr>
<tr>
<td>- Setup RDS MySQL + backups</td>
<td>10-15h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨400 - ‚Ç¨600</td>
</tr>
<tr>
<td>- CI/CD con GitHub Actions</td>
<td>10-15h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨400 - ‚Ç¨600</td>
</tr>
<tr>
<td>- Certificados SSL/TLS (Let's Encrypt)</td>
<td>5-10h</td>
<td>‚Ç¨40/h</td>
<td>‚Ç¨200 - ‚Ç¨400</td>
</tr>
<tr>
<td><strong>TOTAL PROYECTO</strong></td>
<td><strong>780-980h</strong></td>
<td><strong>‚Ç¨40/h</strong></td>
<td><strong>‚Ç¨31,200 - ‚Ç¨39,200</strong></td>
</tr>
</tbody>
</table>

<p><strong>Inversi√≥n promedio estimada:</strong> <strong>‚Ç¨35,200</strong> (aproximadamente <strong>880 horas</strong> de desarrollo)</p>

<p><strong>Nota:</strong> Las estimaciones se basan en tarifas de desarrollador mid-senior en Espa√±a (2025) y asumen un equipo con experiencia en las tecnolog√≠as utilizadas.</p>

<h3 id="122-modelo-de-negocio-saas">12.2 - Modelo de Negocio SaaS</h3>

<p><strong>Precio de Suscripci√≥n:</strong></p>
<ul>
<li><strong>‚Ç¨50/mes</strong> por academia</li>
<li>Incluye: Acceso completo, actualizaciones, soporte t√©cnico, hosting</li>
<li>Sin l√≠mite de usuarios por academia</li>
<li>Sin l√≠mite de alumnos/cursos</li>
</ul>

<p><strong>Costes Operativos Mensuales (AWS):</strong></p>
<table>
<thead>
<tr>
<th>Escenario</th>
<th>Configuraci√≥n</th>
<th>Coste Mensual</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>A√±o 1 (Free Tier)</strong></td>
<td>EC2 t2.micro + RDS db.t3.micro</td>
<td>‚Ç¨0/mes</td>
</tr>
<tr>
<td><strong>Post Free Tier (B√°sico)</strong></td>
<td>EC2 t2.micro + RDS db.t3.micro</td>
<td>‚Ç¨12/mes</td>
</tr>
<tr>
<td><strong>Escalado (50-100 academias)</strong></td>
<td>ALB + EC2 t3.small x2 + RDS db.t3.small Multi-AZ</td>
<td>‚Ç¨75/mes</td>
</tr>
</tbody>
</table>

<p><strong>Costes Adicionales:</strong></p>
<ul>
<li><strong>OpenAI API:</strong> ‚Ç¨0.50 - ‚Ç¨1.50 por academia/mes (estimado seg√∫n uso)</li>
<li><strong>Dominio:</strong> ‚Ç¨12/a√±o (‚Ç¨1/mes)</li>
<li><strong>Soporte y mantenimiento:</strong> 10h/mes √ó ‚Ç¨40/h = ‚Ç¨400/mes</li>
</ul>

<h3 id="123-punto-de-equilibrio-break-even">12.3 - Punto de Equilibrio (Break-even)</h3>

<p><strong>Escenario 1: Primer A√±o (Free Tier de AWS)</strong></p>
<pre class="hljs"><code><div>Inversi√≥n inicial: ‚Ç¨35,200
Costes operativos: ‚Ç¨0/mes (AWS) + ‚Ç¨1/mes (dominio) + ‚Ç¨50/mes (OpenAI) ‚âà ‚Ç¨51/mes
Ingresos por academia: ‚Ç¨50/mes
Ingresos netos por academia: ‚Ç¨50 - ‚Ç¨51/N academias

<span class="hljs-comment"># Punto de equilibrio (sin contar costes de soporte):</span>
Academias necesarias = ‚Ç¨35,200 / (‚Ç¨50/mes) = <span class="hljs-number">704</span> meses-academia
= <span class="hljs-number">704</span> / <span class="hljs-number">12</span> = <strong><span class="hljs-number">59</span> academias durante <span class="hljs-number">1</span> a√±o</strong>
= <span class="hljs-number">704</span> / <span class="hljs-number">24</span> = <strong><span class="hljs-number">30</span> academias durante <span class="hljs-number">2</span> a√±os</strong>
</div></code></pre>

<p><strong>Escenario 2: Post Free Tier (‚Ç¨12/mes de AWS)</strong></p>
<pre class="hljs"><code><div>Inversi√≥n inicial: ‚Ç¨35,200
Costes operativos: ‚Ç¨12/mes (AWS) + ‚Ç¨1/mes (dominio) + ‚Ç¨50/mes (OpenAI) ‚âà ‚Ç¨63/mes
Ingresos por academia: ‚Ç¨50/mes

<span class="hljs-comment"># Con 1 academia:</span>
Ingresos netos: ‚Ç¨50 - ‚Ç¨63 = <strong>-‚Ç¨13/mes</strong> (p√©rdida)

<span class="hljs-comment"># Con 10 academias:</span>
Ingresos netos: ‚Ç¨500 - ‚Ç¨63 = <strong>‚Ç¨437/mes</strong>
Tiempo para recuperar inversi√≥n: ‚Ç¨35,200 / ‚Ç¨437 ‚âà <span class="hljs-number">81</span> meses (<span class="hljs-number">6.7</span> a√±os)

<span class="hljs-comment"># Punto de equilibrio √≥ptimo:</span>
Academias necesarias ‚âà <strong><span class="hljs-number">77</span> academias durante <span class="hljs-number">1</span> a√±o</strong>
= <strong><span class="hljs-number">39</span> academias durante <span class="hljs-number">2</span> a√±os</strong>
</div></code></pre>

<h3 id="124-proyecci%C3%B3n-de-rentabilidad">12.4 - Proyecci√≥n de Rentabilidad</h3>

<p>An√°lisis de diferentes escenarios seg√∫n n√∫mero de academias suscritas:</p>

<table>
<thead>
<tr>
<th>Academias</th>
<th>Ingresos/mes</th>
<th>Costes/mes</th>
<th>Beneficio/mes</th>
<th>ROI en 24 meses</th>
<th>Estado</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>‚Ç¨500</td>
<td>‚Ç¨12 (AWS) + ‚Ç¨51 (otros)</td>
<td>‚Ç¨437</td>
<td>-‚Ç¨24,712</td>
<td>‚ùå No rentable</td>
</tr>
<tr>
<td>25</td>
<td>‚Ç¨1,250</td>
<td>‚Ç¨12 + ‚Ç¨51</td>
<td>‚Ç¨1,187</td>
<td>-‚Ç¨6,712</td>
<td>‚ùå No rentable</td>
</tr>
<tr>
<td>40</td>
<td>‚Ç¨2,000</td>
<td>‚Ç¨75 + ‚Ç¨51</td>
<td>‚Ç¨1,874</td>
<td>‚Ç¨9,776</td>
<td>‚úÖ Rentable</td>
</tr>
<tr>
<td>60</td>
<td>‚Ç¨3,000</td>
<td>‚Ç¨75 + ‚Ç¨51</td>
<td>‚Ç¨2,874</td>
<td>‚Ç¨33,776</td>
<td>‚úÖ‚úÖ Muy rentable</td>
</tr>
<tr>
<td>100</td>
<td>‚Ç¨5,000</td>
<td>‚Ç¨75 + ‚Ç¨51</td>
<td>‚Ç¨4,874</td>
<td>‚Ç¨81,776</td>
<td>‚úÖ‚úÖ‚úÖ Altamente rentable</td>
</tr>
</tbody>
</table>

<p><strong>Conclusi√≥n:</strong> Con <strong>40 academias</strong> suscritas, el proyecto se vuelve rentable en aproximadamente <strong>20-22 meses</strong>.</p>

<h3 id="125-valor-a%C3%B1adido-reutilizaci%C3%B3n-del-backend-chat">12.5 - Valor A√±adido: Reutilizaci√≥n del Backend Chat</h3>

<p>Como se explic√≥ en la Secci√≥n 8.7, el Backend Chat es completamente reutilizable para otros dominios de negocio.</p>

<p><strong>Ahorro en Proyectos Futuros:</strong></p>
<ul>
<li>Backend Chat ya desarrollado: <strong>-‚Ç¨6,400 - ‚Ç¨8,000</strong> por proyecto</li>
<li>Solo adaptar whitelist + prompts: <strong>10-15 horas</strong> (‚Ç¨400-‚Ç¨600)</li>
<li><strong>Ahorro neto: 20-25%</strong> en desarrollo de nuevos proyectos SaaS</li>
</ul>

<p><strong>Ejemplo: Desarrollo de Sistema de Cl√≠nica M√©dica</strong></p>
<table>
<thead>
<tr>
<th>Componente</th>
<th>Horas (desde cero)</th>
<th>Horas (con Backend Chat)</th>
<th>Ahorro</th>
</tr>
</thead>
<tbody>
<tr>
<td>Android App</td>
<td>240-300h</td>
<td>240-300h</td>
<td>‚Ç¨0</td>
</tr>
<tr>
<td><strong>Backend Chat</strong></td>
<td><strong>160-200h</strong></td>
<td><strong>10-15h</strong></td>
<td><strong>‚Ç¨6,000 - ‚Ç¨7,400</strong></td>
</tr>
<tr>
<td>API Workers</td>
<td>200-240h</td>
<td>200-240h</td>
<td>‚Ç¨0</td>
</tr>
<tr>
<td>Base de Datos</td>
<td>60-80h</td>
<td>60-80h</td>
<td>‚Ç¨0</td>
</tr>
<tr>
<td>Testing + Docs</td>
<td>80-100h</td>
<td>60-80h</td>
<td>‚Ç¨800 - ‚Ç¨800</td>
</tr>
<tr>
<td>DevOps</td>
<td>40-60h</td>
<td>30-40h</td>
<td>‚Ç¨400 - ‚Ç¨800</td>
</tr>
<tr>
<td><strong>TOTAL</strong></td>
<td><strong>780-980h</strong></td>
<td><strong>600-755h</strong></td>
<td><strong>‚Ç¨7,200 - ‚Ç¨9,000</strong></td>
</tr>
</tbody>
</table>

<p><strong>Proyecci√≥n Multi-Vertical (3 proyectos SaaS):</strong></p>
<table>
<thead>
<tr>
<th>Proyecto</th>
<th>Inversi√≥n Desarrollo</th>
<th>Clientes Objetivo</th>
<th>Ingresos/mes (40 clientes)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Academia (original)</td>
<td>‚Ç¨35,200</td>
<td>40 academias</td>
<td>‚Ç¨2,000</td>
</tr>
<tr>
<td>Cl√≠nica M√©dica</td>
<td>‚Ç¨28,000 (con ahorro)</td>
<td>40 cl√≠nicas</td>
<td>‚Ç¨2,000</td>
</tr>
<tr>
<td>Gimnasio</td>
<td>‚Ç¨28,000 (con ahorro)</td>
<td>30 gimnasios</td>
<td>‚Ç¨1,500</td>
</tr>
<tr>
<td><strong>TOTAL</strong></td>
<td><strong>‚Ç¨91,200</strong></td>
<td><strong>110 clientes</strong></td>
<td><strong>‚Ç¨5,500/mes</strong></td>
</tr>
</tbody>
</table>

<p><strong>ROI Multi-Vertical:</strong></p>
<pre class="hljs"><code><div>Inversi√≥n total: ‚Ç¨91,200
Ingresos mensuales: ‚Ç¨5,500
Costes operativos: ‚Ç¨200/mes (AWS escalado + OpenAI √ó <span class="hljs-number">3</span> proyectos)
Beneficio neto mensual: ‚Ç¨5,300

Tiempo para recuperar inversi√≥n: ‚Ç¨91,200 / ‚Ç¨5,300 ‚âà <strong><span class="hljs-number">17</span>-<span class="hljs-number">18</span> meses</strong> ‚úÖ‚úÖ‚úÖ
</div></code></pre>

<p><strong>Ventaja Estrat√©gica:</strong> Al diversificar en 3 verticales diferentes, se reduce el riesgo y se acelera significativamente el retorno de inversi√≥n.</p>

<h3 id="126-conclusiones-econ%C3%B3micas">12.6 - Conclusiones Econ√≥micas</h3>

<p><strong>Viabilidad del Proyecto:</strong></p>
<ul>
<li>‚úÖ <strong>Proyecto mono-vertical (solo Academias):</strong> Rentable con 40 clientes en 20-22 meses</li>
<li>‚úÖ‚úÖ <strong>Proyecto multi-vertical (3 dominios):</strong> Rentable con 110 clientes en 17-18 meses</li>
<li>‚úÖ‚úÖ‚úÖ <strong>Escalabilidad:</strong> Cada nuevo dominio reduce tiempo de desarrollo en 20-25%</li>
</ul>

<p><strong>Factores Cr√≠ticos de √âxito:</strong></p>
<ol>
<li><strong>Captaci√≥n de clientes:</strong> Conseguir 3-5 academias/mes durante el primer a√±o</li>
<li><strong>Retenci√≥n:</strong> Mantener tasa de churn (cancelaci√≥n) &lt; 5% mensual</li>
<li><strong>Costes contenidos:</strong> Aprovechar Free Tier de AWS el m√°ximo tiempo posible</li>
<li><strong>Optimizaci√≥n de OpenAI:</strong> Cachear respuestas frecuentes para reducir costes de API</li>
</ol>

<p><strong>Riesgos Identificados:</strong></p>
<ul>
<li>‚ö†Ô∏è <strong>Competencia:</strong> Otras soluciones SaaS de gesti√≥n acad√©mica</li>
<li>‚ö†Ô∏è <strong>Costes de OpenAI:</strong> Incremento de precios de la API</li>
<li>‚ö†Ô∏è <strong>Adopci√≥n lenta:</strong> Resistencia al cambio (interfaz conversacional vs. tradicional)</li>
<li>‚ö†Ô∏è <strong>Estacionalidad:</strong> Picos de uso en septiembre-junio, bajo en verano</li>
</ul>

<p><strong>Mitigaciones:</strong></p>
<ul>
<li>‚úÖ Diferenciaci√≥n por IA conversacional (UX √∫nica)</li>
<li>‚úÖ Posibilidad de cambiar a modelos open-source (Llama, Mistral) si costes de OpenAI suben</li>
<li>‚úÖ Plan de onboarding con demos en vivo y per√≠odo de prueba gratuito</li>
<li>‚úÖ Pricing anual con descuento para garantizar ingresos estables</li>
</ul>

<hr>
<p><strong>Versi√≥n del Documento:</strong> 2.1.0<br>
<strong>Fecha de √öltima Actualizaci√≥n:</strong> 17 de noviembre de 2025<br>
<strong>Autor:</strong> Angel Fern√°ndez Vidal<br>
<strong>Estado:</strong> Documento Vivo (se actualiza con cada fase)<br>
<strong>Cambios en v2.1.0 (respecto a v2.0.0):</strong></p>
<ul>
<li>‚úÖ Actualizada tecnolog√≠a Backend Chat: Spring Boot 3.5.5, Java 21, OpenAI GPT-4o</li>
<li>‚úÖ Documentada arquitectura de Tool Calling iterativo (hasta 10 llamadas)</li>
<li>‚úÖ A√±adidos 5 campos nuevos a tabla Academia (direccion, telefono, nombre_contacto, email_contacto, descripcion)</li>
<li>‚úÖ A√±adido campo academia_id a Inscripcion con optimizaci√≥n de performance (√≠ndice + triggers)</li>
<li>‚úÖ Documentados 13 par√°metros de query en GET /inscripciones (paginaci√≥n, filtros, ordenamiento)</li>
<li>‚úÖ A√±adido endpoint POST /sesiones/:id/pasar-lista para registro de ausencias masivas</li>
<li>‚úÖ Restricci√≥n en POST /anotaciones: ya no permite tipo 'Ausencia' (usar pasar-lista)</li>
<li>‚úÖ Actualizado diagrama ERD con FK directa Inscripcion ‚Üí Academia</li>
<li>‚úÖ Corregido n√∫mero de tablas: 20 (no 26)</li>
<li>‚úÖ Actualizada telemetr√≠a: 1-6 segundos (casos extremos hasta 15s) seg√∫n iteraciones</li>
<li>‚úÖ Expandida matriz de permisos con nuevas capacidades de filtrado y pasar-lista</li>
<li>‚úÖ A√±adida Secci√≥n 8.7: Reusabilidad del Backend Chat para otros proyectos</li>
<li>‚úÖ A√±adida Secci√≥n 12: An√°lisis Econ√≥mico del Proyecto (estimaci√≥n de horas, costes, ROI, proyecciones)</li>
</ul>

<hr>
<h2 id="anexos">Anexos</h2>
<h3 id="a-glosario-de-t%C3%A9rminos">A. Glosario de T√©rminos</h3>
<p><strong>Envelope</strong>: Estructura de datos est√°ndar que envuelve todas las respuestas del chat.</p>
<p><strong>GenericItem</strong>: Objeto polim√≥rfico que representa cualquier entidad (alumno, curso, sesi√≥n, etc.).</p>
<p><strong>Tool Calling</strong>: Mecanismo de OpenAI para que el LLM solicite ejecutar funciones externas.</p>
<p><strong>served-openapi.json</strong>: Especificaci√≥n de la API en formato OpenAPI que se env√≠a a GPT-4.</p>
<p><strong>SessionStore</strong>: Almac√©n local (DataStore) de tokens y datos del usuario.</p>
<p><strong>Context Map</strong>: Mapa de datos que viaja con cada mensaje para mantener estado conversacional.</p>
<p><strong>Mock</strong>: Implementaci√≥n simulada de un repositorio para desarrollo sin backend.</p>
<p><strong>JWT</strong>: JSON Web Token, est√°ndar para autenticaci√≥n basada en tokens. En nuestro sistema viaja sin modificarse desde Android hasta MySQL.</p>
<p><strong>Claims</strong>: Datos incluidos en el JWT (usuarioId, academiaId, role, email, exp, iat).</p>
<h3 id="b-referencias">B. Referencias</h3>
<p><strong>Documentaci√≥n Oficial:</strong></p>
<ul>
<li><a href="https://platform.openai.com/docs/guides/function-calling">OpenAI Function Calling Guide</a></li>
<li><a href="https://developer.android.com/jetpack/compose">Jetpack Compose Documentation</a></li>
<li><a href="https://developers.cloudflare.com/workers/">Cloudflare Workers Docs</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/">MySQL 8.0 Reference Manual</a></li>
</ul>
<p><strong>Est√°ndares:</strong></p>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7519">JWT RFC 7519</a></li>
<li><a href="https://swagger.io/specification/">OpenAPI Specification</a></li>
<li><a href="https://restfulapi.net/">RESTful API Guidelines</a></li>
</ul>
<p><strong>Arquitectura:</strong></p>
<ul>
<li><a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">Clean Architecture (Robert C. Martin)</a></li>
<li><a href="https://developer.android.com/topic/architecture">MVVM Pattern</a></li>
</ul>

</body>
</html>
