<!DOCTYPE html>
<html>
<head>
<title>Arquitectura AcademiaAPP Android - TFG FP DAM</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<meta name="version" content="1.0.0">
<meta name="last-updated" content="2025-11-24">
<meta name="author" content="√Ångel Fern√°ndez Vidal">
<meta name="project" content="TFG FP DAM - AcademiaAPP Cliente Android">

<style>
body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Ubuntu", "Droid Sans", sans-serif;
	font-size: 14px;
	padding: 0 26px;
	line-height: 22px;
	word-wrap: break-word;
	max-width: 1200px;
	margin: 0 auto;
}

.version-badge {
	background-color: #4CAF50;
	color: white;
	padding: 4px 12px;
	border-radius: 12px;
	font-size: 12px;
	font-weight: bold;
	display: inline-block;
	margin-left: 10px;
}

.architecture-badge {
	background-color: #2196F3;
	color: white;
	padding: 6px 16px;
	border-radius: 16px;
	font-size: 13px;
	font-weight: bold;
	display: inline-block;
	margin: 8px 4px;
}

.tech-stack {
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	color: white;
	padding: 20px;
	border-radius: 8px;
	margin: 20px 0;
}

.tech-stack h3 {
	margin-top: 0;
	color: white;
}

.tech-item {
	background-color: rgba(255, 255, 255, 0.2);
	padding: 8px 16px;
	border-radius: 20px;
	display: inline-block;
	margin: 4px;
	font-size: 13px;
}

.layer-card {
	border: 2px solid #e0e0e0;
	border-radius: 8px;
	padding: 20px;
	margin: 16px 0;
	background-color: #fafafa;
}

.layer-card h3 {
	margin-top: 0;
	color: #1976D2;
	border-bottom: 2px solid #1976D2;
	padding-bottom: 8px;
}

.mvvm-section {
	background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
	color: white;
	padding: 24px;
	border-radius: 12px;
	margin: 24px 0;
}

.mvvm-section h2 {
	margin-top: 0;
	color: white;
}

.stats-box {
	background-color: #E3F2FD;
	border-left: 4px solid #2196F3;
	padding: 16px;
	margin: 16px 0;
	border-radius: 4px;
}

.stats-number {
	font-size: 32px;
	font-weight: bold;
	color: #1976D2;
}

.code-snippet {
	background-color: #263238;
	color: #aed581;
	padding: 16px;
	border-radius: 8px;
	overflow-x: auto;
	margin: 16px 0;
	font-family: 'Courier New', monospace;
	font-size: 13px;
	line-height: 1.6;
}

.code-snippet .keyword {
	color: #c792ea;
}

.code-snippet .string {
	color: #c3e88d;
}

.code-snippet .comment {
	color: #546e7a;
}

.code-snippet .type {
	color: #ffcb6b;
}

.highlight-box {
	background-color: #FFF3E0;
	border-left: 4px solid #FF9800;
	padding: 16px;
	margin: 16px 0;
	border-radius: 4px;
}

.success-box {
	background-color: #E8F5E9;
	border-left: 4px solid #4CAF50;
	padding: 16px;
	margin: 16px 0;
	border-radius: 4px;
}

.diagram-container {
	background-color: white;
	border: 2px solid #e0e0e0;
	border-radius: 8px;
	padding: 20px;
	margin: 24px 0;
	text-align: center;
}

table {
	border-collapse: collapse;
	width: 100%;
	margin: 16px 0;
}

th {
	background-color: #1976D2;
	color: white;
	padding: 12px;
	text-align: left;
}

td {
	border: 1px solid #e0e0e0;
	padding: 10px;
}

tr:nth-child(even) {
	background-color: #f5f5f5;
}

.toc {
	background-color: #f5f5f5;
	border: 1px solid #ddd;
	border-radius: 8px;
	padding: 20px;
	margin: 20px 0;
}

.toc ul {
	list-style: none;
	padding-left: 20px;
}

.toc a {
	color: #1976D2;
	text-decoration: none;
	line-height: 1.8;
}

.toc a:hover {
	text-decoration: underline;
}

h1 {
	color: #1976D2;
	border-bottom: 3px solid #1976D2;
	padding-bottom: 12px;
}

h2 {
	color: #424242;
	border-bottom: 2px solid #e0e0e0;
	padding-bottom: 8px;
	margin-top: 32px;
}

h3 {
	color: #616161;
}

.mermaid {
	background-color: white;
	padding: 20px;
	border-radius: 8px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
	mermaid.initialize({ 
		startOnLoad: true,
		theme: 'default',
		themeVariables: {
			primaryColor: '#E3F2FD',
			primaryTextColor: '#1976D2',
			primaryBorderColor: '#1976D2',
			lineColor: '#1976D2',
			secondaryColor: '#FFF3E0',
			tertiaryColor: '#E8F5E9',
			fontSize: '14px'
		}
	});
</script>
</head>
<body>

<h1>üèóÔ∏è Arquitectura AcademiaAPP - Cliente Android <span class="version-badge">v1.0.0</span></h1>

<p><strong>Proyecto:</strong> TFG FP DAM - Sistema de Gesti√≥n de Academias<br>
<strong>Autor:</strong> √Ångel Fern√°ndez Vidal<br>
<strong>√öltima actualizaci√≥n:</strong> 24 de noviembre de 2025</p>

<div class="tech-stack">
	<h3>üõ†Ô∏è Stack Tecnol√≥gico</h3>
	<span class="tech-item">Kotlin</span>
	<span class="tech-item">Jetpack Compose</span>
	<span class="tech-item">MVVM</span>
	<span class="tech-item">Coroutines</span>
	<span class="tech-item">StateFlow</span>
	<span class="tech-item">Retrofit</span>
	<span class="tech-item">Material Design 3</span>
	<span class="tech-item">Navigation</span>
	<span class="tech-item">ViewModel</span>
	<span class="tech-item">Repository Pattern</span>
</div>

<div class="toc">
	<h3>üìã √çndice</h3>
	<ul>
		<li><a href="#vision-general">1. Visi√≥n General</a></li>
		<li><a href="#arquitectura-mvvm">2. Arquitectura MVVM</a></li>
		<li><a href="#capas">3. Capas de la Aplicaci√≥n</a></li>
		<li><a href="#chatviewmodel">4. ChatViewModel - N√∫cleo del Sistema</a></li>
		<li><a href="#refactoring">5. Modularizaci√≥n de la UI</a></li>
		<li><a href="#flujo-datos">6. Flujo de Datos</a></li>
		<li><a href="#patrones">7. Patrones de Dise√±o</a></li>
		<li><a href="#decisiones">8. Decisiones Arquitect√≥nicas</a></li>
	</ul>
</div>

<h2 id="vision-general">1. üéØ Visi√≥n General</h2>

<p>AcademiaAPP es un cliente Android nativo desarrollado en <strong>Kotlin</strong> con <strong>Jetpack Compose</strong> que implementa un sistema de gesti√≥n de academias mediante una <strong>interfaz conversacional tipo chat</strong>.</p>

<div class="highlight-box">
	<strong>üé® Paradigma Principal:</strong> Chat-Driven Interface
	<p>Toda la interacci√≥n se realiza a trav√©s de un chat conversacional con IA que gu√≠a al usuario mediante sugerencias contextuales y formularios din√°micos.</p>
</div>

<h3>Caracter√≠sticas Principales</h3>

<ul>
	<li>‚úÖ <strong>Interfaz conversacional</strong> con asistente virtual</li>
	<li>‚úÖ <strong>Sistema de sugerencias inteligentes</strong> contextuales</li>
	<li>‚úÖ <strong>Formularios din√°micos</strong> (Alta/Modificaci√≥n de alumnos)</li>
	<li>‚úÖ <strong>Gesti√≥n de clases y asistencias</strong></li>
	<li>‚úÖ <strong>Navegaci√≥n por roles</strong> (admin_plataforma, profesor)</li>
	<li>‚úÖ <strong>Modo Mock + Backend Real</strong> configurable</li>
	<li>‚úÖ <strong>Material Design 3</strong> con tema din√°mico</li>
</ul>

<h2 id="arquitectura-mvvm">2. üèõÔ∏è Arquitectura MVVM</h2>

<div class="mvvm-section">
	<h2>Implementaci√≥n MVVM Pragm√°tica</h2>
	<p>La aplicaci√≥n sigue el patr√≥n <strong>Model-View-ViewModel</strong> recomendado por Google para aplicaciones Android modernas, con un enfoque pragm√°tico que equilibra pureza arquitect√≥nica con eficiencia en el desarrollo.</p>
</div>

<div class="diagram-container">
	<h3>Diagrama MVVM</h3>
	<div class="mermaid">
graph TB
    subgraph View["üñºÔ∏è VIEW LAYER (Jetpack Compose)"]
        ChatScreen["ChatScreen.kt<br/>üì± UI Composables"]
        LoginScreen["LoginScreen.kt"]
        OtherScreens["Otras Pantallas"]
    end
    
    subgraph ViewModel["‚öôÔ∏è VIEWMODEL LAYER"]
        ChatViewModel["ChatViewModel<br/>üß† L√≥gica de negocio<br/>38 estados gestionados"]
        ChatUiState["ChatUiState<br/>üìä Estado reactivo"]
    end
    
    subgraph Model["üíæ MODEL LAYER"]
        Repository["ChatRepository<br/>üîÑ Abstracci√≥n de datos"]
        SessionStore["SessionStore<br/>üîê Sesi√≥n usuario"]
        MockRepo["MockChatRepository<br/>üé≠ Datos simulados"]
        RealRepo["RemoteChatRepository<br/>üåê API REST"]
    end
    
    subgraph Data["üì° DATA LAYER"]
        DTOs["DTOs (Envelope, ChatMessageDto)<br/>üì¶ Modelos de datos"]
        Retrofit["Retrofit/OkHttp<br/>üîå Cliente HTTP"]
        API["Backend API<br/>üñ•Ô∏è api-workers-profesores"]
    end
    
    ChatScreen -->|"observa ui: StateFlow"| ChatUiState
    ChatScreen -->|"llama funciones vm.*()"| ChatViewModel
    ChatViewModel -->|"actualiza _ui.update"| ChatUiState
    ChatViewModel -->|"usa"| Repository
    Repository -.->|"Mock Mode"| MockRepo
    Repository -.->|"Production"| RealRepo
    RealRepo -->|"usa"| Retrofit
    Retrofit -->|"HTTP"| API
    SessionStore -->|"proporciona token"| Repository
    
    style ChatViewModel fill:#f093fb
    style ChatUiState fill:#f5576c
    style Repository fill:#667eea
    style ChatScreen fill:#764ba2
	</div>
	
	<div class="highlight-box">
		<strong>üìñ Lectura del diagrama:</strong>
		<p>Las flechas s√≥lidas muestran el flujo unidireccional de datos (patr√≥n UDF - Unidirectional Data Flow). La View observa el ViewModel mediante <strong>StateFlow</strong> (patr√≥n Observer reactivo). El ViewModel usa el Repository como abstracci√≥n que puede ser <strong>Mock</strong> o <strong>Real</strong> seg√∫n configuraci√≥n. En producci√≥n, el Repository se conecta al backend v√≠a Retrofit.</p>
	</div>
	
	<h4>Ejemplo de Flujo - Env√≠o de Mensaje:</h4>
	<ol style="background-color: #f5f5f5; padding: 20px; border-radius: 8px; line-height: 1.8;">
		<li><strong>Usuario</strong> escribe "listar alumnos" y presiona enviar</li>
		<li><strong>ChatScreen</strong> captura el evento ‚Üí llama <code>vm.sendMessage("listar alumnos")</code></li>
		<li><strong>ChatViewModel</strong> procesa la petici√≥n ‚Üí actualiza <code>_ui.update { loading = true }</code></li>
		<li><strong>Repository</strong> decide la fuente de datos (Mock o Backend real)</li>
		<li><strong>Retrofit</strong> realiza POST /chat/sendMessage (en producci√≥n)</li>
		<li><strong>Backend API</strong> procesa y devuelve JSON con la respuesta</li>
		<li><strong>ChatViewModel</strong> recibe resultado ‚Üí actualiza <code>_ui.update { messages = [...] }</code></li>
		<li><strong>StateFlow</strong> emite el nuevo estado</li>
		<li><strong>ChatScreen</strong> recompone autom√°ticamente con <code>collectAsState()</code></li>
		<li><strong>Usuario</strong> ve la lista de alumnos en pantalla</li>
	</ol>
</div>

<h3>Separaci√≥n de Responsabilidades</h3>

<table>
	<thead>
		<tr>
			<th>Capa</th>
			<th>Responsabilidad</th>
			<th>Tecnolog√≠a</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><strong>View</strong></td>
			<td>Renderizar UI, capturar eventos de usuario</td>
			<td>Jetpack Compose, Composables</td>
		</tr>
		<tr>
			<td><strong>ViewModel</strong></td>
			<td>L√≥gica de negocio, gesti√≥n de estado, orquestaci√≥n</td>
			<td>ViewModel, StateFlow, Coroutines</td>
		</tr>
		<tr>
			<td><strong>Model</strong></td>
			<td>Acceso a datos, abstracci√≥n de fuentes</td>
			<td>Repository Pattern, interfaces</td>
		</tr>
		<tr>
			<td><strong>Data</strong></td>
			<td>Comunicaci√≥n con backend, DTOs</td>
			<td>Retrofit, OkHttp, JSON parsing</td>
		</tr>
	</tbody>
</table>

<h2 id="capas">3. üì¶ Capas de la Aplicaci√≥n</h2>

<div class="layer-card">
	<h3>üñºÔ∏è Capa de Presentaci√≥n (UI Layer)</h3>
	
	<p><strong>Ubicaci√≥n:</strong> <code>com.example.academiaapp.ui.screens</code></p>
	
	<h4>Estructura Modular:</h4>
	<ul>
		<li><strong>ChatScreen.kt</strong> (1,355 l√≠neas): Orquestador principal del chat
			<ul>
				<li>LazyColumn para mensajes</li>
				<li>Sistema de sugerencias</li>
				<li>Di√°logos modales</li>
				<li>Integraci√≥n de componentes reutilizables</li>
			</ul>
		</li>
		<li><strong>forms/</strong>: Formularios din√°micos modulares
			<ul>
				<li>AlumnoAltaForm.kt (234 l√≠neas)</li>
				<li>AlumnoModificacionForm.kt (252 l√≠neas)</li>
			</ul>
		</li>
		<li><strong>components/</strong>: Componentes reutilizables (767 l√≠neas totales)
			<ul>
				<li>TypingIndicator.kt (82 l√≠neas) - Animaci√≥n de carga</li>
				<li>CompactList.kt (328 l√≠neas) - Tabla gen√©rica con paginaci√≥n</li>
				<li>SesionesDelDiaCards.kt (156 l√≠neas) - Cards de sesiones</li>
				<li>SesionesSemanalesTable.kt (201 l√≠neas) - Tabla semanal expandible</li>
			</ul>
		</li>
		<li><strong>LoginScreen.kt</strong>: Autenticaci√≥n</li>
		<li><strong>AppTopBar.kt</strong>: Barra superior reutilizable</li>
	</ul>
	
	<h4>Principios seguidos:</h4>
	<ul>
		<li>‚úÖ <strong>Modularizaci√≥n</strong>: Separaci√≥n clara de responsabilidades</li>
		<li>‚úÖ <strong>Componentes reutilizables</strong>: 6 m√≥dulos independientes</li>
		<li>‚úÖ <strong>Composables sin estado propio</strong> (hoisting de estado)</li>
		<li>‚úÖ <strong>Observaci√≥n de StateFlow</strong> del ViewModel</li>
		<li>‚úÖ <strong>Sin l√≥gica de negocio</strong> (solo presentaci√≥n)</li>
		<li>‚úÖ <strong>Estados locales justificados</strong> para UI ef√≠mera</li>
	</ul>
	
	<div class="code-snippet">
<span class="keyword">@Composable</span>
<span class="keyword">fun</span> <span class="type">ChatScreen</span>(navController: NavController? = <span class="keyword">null</span>) {
    <span class="keyword">val</span> vm: ChatViewModel = viewModel(...)
    <span class="keyword">val</span> ui <span class="keyword">by</span> vm.ui.<span class="type">collectAsState</span>()  <span class="comment">// ‚úÖ Observaci√≥n reactiva</span>
    
    <span class="comment">// ‚úÖ UI observa, ViewModel gestiona</span>
    LazyColumn {
        items(ui.messages) { message ->
            MessageBubble(message = message)
        }
    }
    
    <span class="comment">// ‚úÖ Componentes modulares reutilizables</span>
    <span class="keyword">when</span> (message.renderMode) {
        <span class="string">"compact_list"</span> -> CompactList(
            items = message.items,
            onOpenDetails = vm::showDetailsItem
        )
        <span class="string">"sesiones_del_dia"</span> -> SesionesDelDiaCards(
            items = message.items,
            onVerAlumnos = vm::verAlumnosSesion
        )
    }
    
    OutlinedTextField(
        value = ui.input,                    <span class="comment">// ‚úÖ Estado del ViewModel</span>
        onValueChange = { vm.setInput(it) }  <span class="comment">// ‚úÖ Acci√≥n al ViewModel</span>
    )
}
	</div>
</div>

<div class="layer-card">
	<h3>‚öôÔ∏è Capa de ViewModel</h3>
	
	<p><strong>Ubicaci√≥n:</strong> <code>com.example.academiaapp.ui.viewmodels</code></p>
	
	<h4>ChatViewModel.kt (636 l√≠neas)</h4>
	
	<div class="stats-box">
		<p><span class="stats-number">38</span> estados gestionados en <code>ChatUiState</code></p>
		<p><span class="stats-number">60+</span> funciones de negocio y actualizaci√≥n de estado</p>
		<p><span class="stats-number">100%</span> l√≥gica de negocio centralizada</p>
	</div>
	
	<h4>Estructura del Estado:</h4>
	
	<div class="code-snippet">
<span class="keyword">data class</span> <span class="type">ChatUiState</span>(
    <span class="comment">// üîÑ Estados de carga</span>
    <span class="keyword">val</span> loading: Boolean = <span class="keyword">false</span>,
    <span class="keyword">val</span> error: String? = <span class="keyword">null</span>,
    <span class="keyword">val</span> messages: List&lt;ChatMessage&gt; = emptyList(),
    
    <span class="comment">// üí¨ Input del chat</span>
    <span class="keyword">val</span> input: String = <span class="string">""</span>,
    
    <span class="comment">// üìã Di√°logos</span>
    <span class="keyword">val</span> showClarificationDialog: Boolean = <span class="keyword">false</span>,
    <span class="keyword">val</span> showBajaAlumnoDialog: Boolean = <span class="keyword">false</span>,
    <span class="keyword">val</span> showConfirmDialogAlta: Boolean = <span class="keyword">false</span>,
    <span class="keyword">val</span> showConfirmDialogModificacion: Boolean = <span class="keyword">false</span>,
    
    <span class="comment">// üìä Visualizaci√≥n de datos</span>
    <span class="keyword">val</span> detailsItem: Map&lt;String, Any?&gt;? = <span class="keyword">null</span>,
    <span class="keyword">val</span> itemsToShow: Int = 5,
    <span class="keyword">val</span> selectedItemId: Int? = <span class="keyword">null</span>,
    
    <span class="comment">// üìù Formularios - 28 estados (14 campos √ó 2 formularios)</span>
    <span class="keyword">val</span> nombreAlta: String = <span class="string">""</span>,
    <span class="keyword">val</span> nombreModificacion: String = <span class="string">""</span>,
    <span class="keyword">val</span> telefonoAlta: String = <span class="string">""</span>,
    <span class="keyword">val</span> telefonoModificacion: String = <span class="string">""</span>,
    <span class="comment">// ... 24 campos m√°s</span>
    
    <span class="comment">// ‚ö†Ô∏è Validaciones</span>
    <span class="keyword">val</span> nombreError: Boolean = <span class="keyword">false</span>,
    <span class="keyword">val</span> telefonoError: Boolean = <span class="keyword">false</span>,
    <span class="keyword">val</span> fechaError: Boolean = <span class="keyword">false</span>,
    
    <span class="comment">// üé® UI/UX</span>
    <span class="keyword">val</span> modificacionAlumnoClickCount: Int = 0
)
	</div>
	
	<h4>Responsabilidades clave:</h4>
	<ul>
		<li>üîÑ <strong>Gesti√≥n de mensajes</strong>: env√≠o, recepci√≥n, paginaci√≥n</li>
		<li>üìù <strong>Validaci√≥n de formularios</strong></li>
		<li>üéØ <strong>Orquestaci√≥n de di√°logos</strong></li>
		<li>üîê <strong>Gesti√≥n de contexto</strong> (navegaci√≥n, sugerencias)</li>
		<li>üß™ <strong>Control de mocks vs backend</strong></li>
	</ul>
</div>

<div class="layer-card">
	<h3>üíæ Capa de Dominio (Domain Layer)</h3>
	
	<p><strong>Ubicaci√≥n:</strong> <code>com.example.academiaapp.domain</code></p>
	
	<h4>Repository Pattern</h4>
	
	<div class="code-snippet">
<span class="keyword">interface</span> <span class="type">ChatRepository</span> {
    <span class="keyword">suspend fun</span> <span class="type">welcome</span>(): Result&lt;Envelope&gt;
    <span class="keyword">suspend fun</span> <span class="type">sendMessage</span>(text: String, context: Map&lt;String, Any&gt;?): Result&lt;Envelope&gt;
    <span class="keyword">suspend fun</span> <span class="type">fetchPage</span>(paginationToken: String): Result&lt;Envelope&gt;
    <span class="keyword">fun</span> <span class="type">clearWelcomeCache</span>()
}
	</div>
	
	<h4>Implementaciones:</h4>
	<ul>
		<li><strong>MockChatRepository</strong>: Datos simulados para desarrollo/demo</li>
		<li><strong>RemoteChatRepository</strong>: Comunicaci√≥n con API real</li>
	</ul>
	
	<div class="highlight-box">
		<strong>üí° Ventaja del Repository Pattern:</strong>
		<p>Permite cambiar entre modo mock y producci√≥n sin modificar el ViewModel. El repositorio act√∫a como abstracci√≥n de la fuente de datos.</p>
	</div>
</div>

<div class="layer-card">
	<h3>üì° Capa de Datos (Data Layer)</h3>
	
	<p><strong>Ubicaci√≥n:</strong> <code>com.example.academiaapp.data</code></p>
	
	<h4>Componentes:</h4>
	<ul>
		<li><strong>DTOs</strong>: Envelope, ChatMessageDto, GenericItem, Suggestion, PaginationInfo</li>
		<li><strong>Retrofit Service</strong>: ChatApiService con endpoints tipados</li>
		<li><strong>SessionStore</strong>: DataStore para persistencia de sesi√≥n</li>
		<li><strong>MockData</strong>: Datos de prueba estructurados</li>
	</ul>
	
	<h4>Envelope - Contrato de Comunicaci√≥n:</h4>
	
	<div class="code-snippet">
<span class="keyword">data class</span> <span class="type">Envelope</span>(
    <span class="keyword">val</span> message: String?,              <span class="comment">// Mensaje del asistente</span>
    <span class="keyword">val</span> items: List&lt;GenericItem&gt;?,    <span class="comment">// Datos (alumnos, clases, etc.)</span>
    <span class="keyword">val</span> suggestions: List&lt;Suggestion&gt;?, <span class="comment">// Sugerencias contextuales</span>
    <span class="keyword">val</span> summary_fields: List&lt;String&gt;?, <span class="comment">// Campos a resumir</span>
    <span class="keyword">val</span> screen: String?,              <span class="comment">// Contexto de pantalla</span>
    <span class="keyword">val</span> pagination: PaginationInfo?   <span class="comment">// Info de paginaci√≥n</span>
)
	</div>
</div>

<h2 id="chatviewmodel">4. üß† ChatViewModel - N√∫cleo del Sistema</h2>

<div class="diagram-container">
	<h3>Flujo de Operaciones en ChatViewModel</h3>
	<div class="mermaid">
sequenceDiagram
    participant U as Usuario
    participant V as ChatScreen
    participant VM as ChatViewModel
    participant R as Repository
    participant API as Backend API
    
    U->>V: Escribe mensaje
    V->>VM: vm.setInput(text)
    VM->>VM: _ui.update { it.copy(input = text) }
    
    U->>V: Presiona enviar
    V->>VM: vm.sendMessage(text)
    
    VM->>VM: A√±ade mensaje usuario
    VM->>VM: _ui.update { loading = true }
    
    alt Modo Mock
        VM->>R: sendMessage(text, context)
        R-->>VM: Result.Success(mockEnvelope)
    else Modo Producci√≥n
        VM->>R: sendMessage(text, context)
        R->>API: POST /chat/sendMessage
        API-->>R: Envelope JSON
        R-->>VM: Result.Success(envelope)
    end
    
    VM->>VM: applyEnvelope(envelope)
    VM->>VM: A√±ade mensaje asistente
    VM->>VM: _ui.update { loading = false }
    VM-->>V: ui StateFlow emite nuevo estado
    V-->>U: Muestra respuesta
	</div>
</div>

<h3>Funciones Principales</h3>

<table>
	<thead>
		<tr>
			<th>Categor√≠a</th>
			<th>Funciones</th>
			<th>Responsabilidad</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><strong>Mensajer√≠a</strong></td>
			<td>sendMessage()<br>sendMessageWithContext()<br>loadWelcome()<br>applyEnvelope()</td>
			<td>Env√≠o/recepci√≥n de mensajes, aplicaci√≥n de respuestas</td>
		</tr>
		<tr>
			<td><strong>Navegaci√≥n</strong></td>
			<td>fetchNextPage()<br>fetchPrevPage()<br>disableSuggestionsForMessage()</td>
			<td>Paginaci√≥n de datos, gesti√≥n de sugerencias</td>
		</tr>
		<tr>
			<td><strong>Di√°logos</strong></td>
			<td>showClarificationDialog()<br>closeClarificationDialog()<br>showBajaAlumnoDialog()<br>showConfirmDialogAlta()</td>
			<td>Control de modals y confirmaciones</td>
		</tr>
		<tr>
			<td><strong>Formularios</strong></td>
			<td>setNombreAlta()<br>setTelefonoModificacion()<br>initDireccionModificacion()<br>convertDateFormat()</td>
			<td>Gesti√≥n de 28 campos de formulario</td>
		</tr>
		<tr>
			<td><strong>Validaci√≥n</strong></td>
			<td>setNombreError()<br>setTelefonoError()<br>setFechaError()</td>
			<td>Control de errores de validaci√≥n</td>
		</tr>
		<tr>
			<td><strong>Visualizaci√≥n</strong></td>
			<td>toggleItemDetails()<br>toggleDayExpanded()<br>setItemsToShow()</td>
			<td>Control de expansi√≥n/colapso de elementos</td>
		</tr>
		<tr>
			<td><strong>UI/UX</strong></td>
			<td>incrementModificacionClickCount()<br>resetModificacionClickCount()</td>
			<td>Interacciones especiales de UI</td>
		</tr>
	</tbody>
</table>

<h2 id="refactoring">5. üèóÔ∏è Modularizaci√≥n de la UI</h2>

<div class="success-box">
	<h3>‚úÖ Arquitectura Modular Implementada</h3>
	<p><strong>Enfoque:</strong> Separaci√≥n de componentes reutilizables</p>
	<p><strong>Estructura:</strong> 7 archivos modulares (1 orquestador + 6 componentes)</p>
	<p><strong>Beneficios:</strong> Mantenibilidad, reutilizaci√≥n, testabilidad</p>
</div>

<h3>Estructura de Componentes</h3>

<table>
	<thead>
		<tr>
			<th>Componente</th>
			<th>L√≠neas</th>
			<th>Responsabilidad</th>
			<th>Reutilizable</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><strong>ChatScreen.kt</strong></td>
			<td>1,355</td>
			<td>Orquestador principal, l√≥gica de chat</td>
			<td>-</td>
		</tr>
		<tr>
			<td><strong>AlumnoAltaForm.kt</strong></td>
			<td>234</td>
			<td>Formulario de alta de alumnos</td>
			<td>‚úÖ</td>
		</tr>
		<tr>
			<td><strong>AlumnoModificacionForm.kt</strong></td>
			<td>252</td>
			<td>Formulario de modificaci√≥n de alumnos</td>
			<td>‚úÖ</td>
		</tr>
		<tr>
			<td><strong>TypingIndicator.kt</strong></td>
			<td>82</td>
			<td>Animaci√≥n de puntos de carga</td>
			<td>‚úÖ</td>
		</tr>
		<tr>
			<td><strong>CompactList.kt</strong></td>
			<td>328</td>
			<td>Tabla gen√©rica con paginaci√≥n</td>
			<td>‚úÖ</td>
		</tr>
		<tr>
			<td><strong>SesionesDelDiaCards.kt</strong></td>
			<td>156</td>
			<td>Visualizaci√≥n de sesiones diarias</td>
			<td>‚úÖ</td>
		</tr>
		<tr>
			<td><strong>SesionesSemanalesTable.kt</strong></td>
			<td>201</td>
			<td>Tabla semanal expandible</td>
			<td>‚úÖ</td>
		</tr>
	</tbody>
</table>

<h3>Beneficios de la Modularizaci√≥n</h3>

<div class="diagram-container">
	<div class="mermaid">
graph TB
    subgraph Orquestador["ChatScreen.kt (1,355 l√≠neas)"]
        A[Gesti√≥n de mensajes]
        B[L√≥gica de chat]
        C[Navegaci√≥n]
    end
    
    subgraph Forms["üìù Formularios"]
        D[AlumnoAltaForm]
        E[AlumnoModificacionForm]
    end
    
    subgraph Components["üß© Componentes"]
        F[TypingIndicator]
        G[CompactList]
        H[SesionesDelDiaCards]
        I[SesionesSemanalesTable]
    end
    
    A --> D
    A --> E
    B --> F
    B --> G
    B --> H
    B --> I
    
    style A fill:#E3F2FD
    style D fill:#C8E6C9
    style E fill:#C8E6C9
    style F fill:#FFF9C4
    style G fill:#FFF9C4
    style H fill:#FFF9C4
    style I fill:#FFF9C4
	</div>
</div>

<ul>
	<li>‚úÖ <strong>Separaci√≥n de responsabilidades</strong>: Cada componente tiene una √∫nica responsabilidad</li>
	<li>‚úÖ <strong>Reutilizaci√≥n</strong>: Componentes pueden usarse en m√∫ltiples contextos</li>
	<li>‚úÖ <strong>Testabilidad</strong>: Componentes peque√±os son m√°s f√°ciles de probar</li>
	<li>‚úÖ <strong>Mantenibilidad</strong>: Cambios localizados, menos riesgo de regresiones</li>
	<li>‚úÖ <strong>Legibilidad</strong>: ChatScreen m√°s limpio y enfocado en orquestaci√≥n</li>
	<li>‚úÖ <strong>Escalabilidad</strong>: F√°cil a√±adir nuevos componentes sin afectar existentes</li>
</ul>

<h3>Ejemplos de Componentes Reutilizables</h3>

<h4>TypingIndicator - Componente de Animaci√≥n</h4>

<div class="code-snippet">
<span class="keyword">@Composable</span>
<span class="keyword">fun</span> <span class="type">TypingIndicator</span>(
    modifier: Modifier = Modifier,
    dotColor: Color = Color(0xFF555555)
) {
    <span class="keyword">val</span> infiniteTransition = rememberInfiniteTransition()
    
    <span class="comment">// Animaci√≥n de ola con tres puntos</span>
    Row(modifier = modifier) {
        <span class="keyword">repeat</span>(3) { index ->
            Box(
                modifier = Modifier
                    .size(8.dp)
                    .offset(y = offsetY[index].dp)
                    .background(dotColor, CircleShape)
            )
        }
    }
}

<span class="comment">// Uso: Reutilizable en cualquier contexto de carga</span>
TypingIndicator(dotColor = MaterialTheme.colorScheme.primary)
	</div>

<h4>CompactList - Tabla Gen√©rica Reutilizable</h4>

<div class="code-snippet">
<span class="keyword">@Composable</span>
<span class="keyword">fun</span> <span class="type">CompactList</span>(
    items: List&lt;Map&lt;String, Any?&gt;&gt;,
    summaryFields: List&lt;String&gt;,
    onOpenDetails: (Map&lt;String, Any?&gt;) -> Unit,
    itemsToShow: Int,
    onSetItemsToShow: (Int) -> Unit
) {
    <span class="comment">// Renderiza tabla gen√©rica con:</span>
    <span class="comment">// - Paginaci√≥n autom√°tica</span>
    <span class="comment">// - Scroll autom√°tico</span>
    <span class="comment">// - Selecci√≥n de items</span>
    <span class="comment">// - Formateo inteligente de campos</span>
    
    LazyColumn {
        itemsIndexed(items.take(itemsToShow)) { index, item ->
            <span class="comment">// Renderizado optimizado...</span>
        }
    }
}

<span class="comment">// Uso: Funciona con alumnos, profesores, cursos, etc.</span>
CompactList(
    items = ui.alumnos,
    summaryFields = listOf(<span class="string">"nombre"</span>, <span class="string">"telefono"</span>),
    onOpenDetails = vm::showAlumnoDetails
)
	</div>

<h2 id="flujo-datos">6. üîÑ Flujo de Datos</h2>

<div class="diagram-container">
	<h3>Flujo Unidireccional de Datos (UDF)</h3>
	<div class="mermaid">
flowchart TD
    subgraph UI["üñºÔ∏è UI Layer"]
        A[Usuario interact√∫a]
        B[ChatScreen observa ui]
        C[Renderiza cambios]
    end
    
    subgraph VM["‚öôÔ∏è ViewModel"]
        D[Funci√≥n vm.*]
        E[_ui.update]
        F[StateFlow emite]
    end
    
    subgraph MODEL["üíæ Model"]
        G[Repository]
        H[API/Mock]
    end
    
    A -->|onClick, onChange| D
    D -->|l√≥gica de negocio| E
    E --> F
    F -->|collectAsState| B
    B --> C
    
    D -.->|suspend fun| G
    G -.->|Result| D
    G <-->|datos| H
    
    style A fill:#E3F2FD
    style F fill:#4CAF50
    style C fill:#764ba2
	</div>
</div>

<h3>Ejemplo: Alta de Alumno</h3>

<div class="code-snippet">
<span class="comment">// 1. Usuario completa formulario</span>
OutlinedTextField(
    value = ui.nombreAlta,
    onValueChange = { vm.setNombreAlta(it) }  <span class="comment">// ‚¨ÜÔ∏è Evento</span>
)

<span class="comment">// 2. ViewModel actualiza estado</span>
<span class="keyword">fun</span> <span class="type">setNombreAlta</span>(nombre: String) {
    _ui.update { it.copy(nombreAlta = nombre) }  <span class="comment">// üîÑ Actualizaci√≥n</span>
}

<span class="comment">// 3. StateFlow emite nuevo estado</span>
<span class="keyword">val</span> ui: StateFlow&lt;ChatUiState&gt; = _ui  <span class="comment">// üì° Emisi√≥n reactiva</span>

<span class="comment">// 4. ChatScreen recibe y renderiza</span>
<span class="keyword">val</span> ui <span class="keyword">by</span> vm.ui.collectAsState()  <span class="comment">// ‚¨áÔ∏è Observaci√≥n</span>
Text(<span class="string">"Nombre: ${ui.nombreAlta}"</span>)  <span class="comment">// üé® Renderizado</span>
	</div>

<h2 id="patrones">7. üé® Patrones de Dise√±o</h2>

<h3>Repository Pattern</h3>

<div class="highlight-box">
	<strong>Objetivo:</strong> Abstraer la fuente de datos del ViewModel
	<p>El ViewModel solo conoce la interfaz <code>ChatRepository</code>, no si los datos vienen de un mock o del backend.</p>
</div>

<div class="code-snippet">
<span class="comment">// Interfaz (abstracci√≥n)</span>
<span class="keyword">interface</span> <span class="type">ChatRepository</span> {
    <span class="keyword">suspend fun</span> <span class="type">sendMessage</span>(text: String): Result&lt;Envelope&gt;
}

<span class="comment">// Implementaci√≥n Mock</span>
<span class="keyword">class</span> <span class="type">MockChatRepository</span> : ChatRepository {
    <span class="keyword">override suspend fun</span> <span class="type">sendMessage</span>(text: String): Result&lt;Envelope&gt; {
        <span class="keyword">return</span> Result.Success(MockData.generateResponse(text))
    }
}

<span class="comment">// Implementaci√≥n Real</span>
<span class="keyword">class</span> <span class="type">RemoteChatRepository</span>(<span class="keyword">private val</span> api: ChatApiService) : ChatRepository {
    <span class="keyword">override suspend fun</span> <span class="type">sendMessage</span>(text: String): Result&lt;Envelope&gt; {
        <span class="keyword">val</span> response = api.sendMessage(MessageRequest(text))
        <span class="keyword">return</span> Result.Success(response)
    }
}
	</div>

<h3>Dependency Injection Manual</h3>

<div class="code-snippet">
<span class="comment">// AppContainer - DI simple sin framework</span>
<span class="keyword">class</span> <span class="type">AppContainer</span>(<span class="keyword">val</span> context: Context) {
    <span class="keyword">val</span> session = SessionStore(context)
    
    <span class="keyword">val</span> chatRepository: ChatRepository = <span class="keyword">if</span> (MockConfig.USE_MOCKS) {
        MockChatRepository()
    } <span class="keyword">else</span> {
        RemoteChatRepository(retrofitService, session)
    }
}

<span class="comment">// Uso en ViewModel</span>
<span class="keyword">val</span> factory = ChatViewModelFactory(
    app.container.chatRepository,
    app.container.session
)
<span class="keyword">val</span> vm: ChatViewModel = viewModel(factory = factory)
	</div>

<h3>State Hoisting</h3>

<div class="highlight-box">
	<strong>Concepto:</strong> El estado se "eleva" al nivel m√°s alto necesario
	<p>Los Composables hijos son "sin estado" (stateless) y reciben datos + callbacks del padre.</p>
</div>

<div class="code-snippet">
<span class="comment">// ‚ùå MAL: Estado local en componente hijo</span>
<span class="keyword">@Composable</span>
<span class="keyword">fun</span> <span class="type">MessageInput</span>() {
    <span class="keyword">var</span> text <span class="keyword">by</span> remember { mutableStateOf(<span class="string">""</span>) }  <span class="comment">// ‚ùå Estado aqu√≠</span>
    TextField(value = text, onValueChange = { text = it })
}

<span class="comment">// ‚úÖ BIEN: Estado en ViewModel</span>
<span class="keyword">@Composable</span>
<span class="keyword">fun</span> <span class="type">MessageInput</span>(value: String, onChange: (String) -> Unit) {
    TextField(value = value, onValueChange = onChange)  <span class="comment">// ‚úÖ Stateless</span>
}

<span class="comment">// Uso:</span>
MessageInput(
    value = ui.input,           <span class="comment">// Del ViewModel</span>
    onChange = { vm.setInput(it) }  <span class="comment">// Al ViewModel</span>
)
	</div>

<h3>Result Wrapper</h3>

<div class="code-snippet">
<span class="keyword">sealed class</span> <span class="type">Result</span>&lt;<span class="keyword">out</span> T&gt; {
    <span class="keyword">data class</span> <span class="type">Success</span>&lt;<span class="keyword">out</span> T&gt;(<span class="keyword">val</span> data: T) : Result&lt;T&gt;()
    <span class="keyword">data class</span> <span class="type">Error</span>(<span class="keyword">val</span> message: String) : Result&lt;Nothing&gt;()
}

<span class="comment">// Uso con when expression</span>
<span class="keyword">when</span> (<span class="keyword">val</span> result = repo.sendMessage(text)) {
    <span class="keyword">is</span> Result.Success -> applyEnvelope(result.data)
    <span class="keyword">is</span> Result.Error -> _ui.update { it.copy(error = result.message) }
}
	</div>

<h2 id="decisiones">8. üéØ Decisiones Arquitect√≥nicas</h2>

<h3>1. Estados Locales Justificados</h3>

<div class="stats-box">
	<p><strong>Decisi√≥n:</strong> Mantener 7 estados locales en ChatScreen</p>
	<p><strong>Raz√≥n:</strong> MVVM pragm√°tico vs dogm√°tico</p>
</div>

<table>
	<thead>
		<tr>
			<th>Estado</th>
			<th>Tipo</th>
			<th>Justificaci√≥n</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>ausenciasMap<br>showVerAnotacionesDialog<br>showNuevaAnotacionDialog<br>selectedAlumnoId<br>selectedAlumnoNombre<br>anotacionesAlumno</td>
			<td><code>remember(index)</code></td>
			<td>
				‚úÖ <strong>Ef√≠meros por mensaje</strong><br>
				‚úÖ Se recrean din√°micamente<br>
				‚úÖ No necesitan persistencia<br>
				‚úÖ L√≥gica de presentaci√≥n espec√≠fica
			</td>
		</tr>
		<tr>
			<td>showScrollToBottom</td>
			<td><code>derivedStateOf</code></td>
			<td>
				‚úÖ <strong>C√°lculo derivado de UI</strong><br>
				‚úÖ Depende de LazyListState (Compose)<br>
				‚úÖ No es l√≥gica de negocio<br>
				‚úÖ Best practice de Google
			</td>
		</tr>
	</tbody>
</table>

<div class="success-box">
	<p><strong>‚úÖ Soporte oficial:</strong></p>
	<p>"States that are scoped to a specific composable and don't need to survive configuration changes should use remember. DerivedStateOf is perfect for calculations based on other state."</p>
	<p style="text-align: right;"><em>‚Äî Android Developers Documentation</em></p>
</div>

<h3>2. Mock vs Backend Real</h3>

<div class="code-snippet">
<span class="comment">// MockConfig.kt - Control centralizado</span>
<span class="keyword">object</span> <span class="type">MockConfig</span> {
    <span class="keyword">const val</span> USE_MOCKS = <span class="keyword">true</span>  <span class="comment">// ‚úÖ Un solo flag</span>
    
    <span class="keyword">fun</span> <span class="type">isMocked</span>(screen: String): Boolean {
        <span class="keyword">return</span> USE_MOCKS && screen <span class="keyword">in</span> listOf(
            <span class="string">"alumnos"</span>, <span class="string">"clases"</span>, <span class="string">"sesiones"</span>
        )
    }
}
	</div>

<p><strong>Ventajas:</strong></p>
<ul>
	<li>‚úÖ Desarrollo sin backend disponible</li>
	<li>‚úÖ Testing de UI aislado</li>
	<li>‚úÖ Demos sin conexi√≥n</li>
	<li>‚úÖ Cambio r√°pido entre modos</li>
</ul>

<h3>3. ViewModelStoreOwner: Activity vs NavBackStackEntry</h3>

<div class="highlight-box">
	<p><strong>Decisi√≥n:</strong> Usar Activity como owner del ChatViewModel</p>
	<p><strong>Raz√≥n:</strong> Preservar mensajes del chat entre navegaciones</p>
</div>

<div class="code-snippet">
<span class="keyword">val</span> activityOwner = LocalActivity.current <span class="keyword">as?</span> ViewModelStoreOwner
<span class="keyword">val</span> owner: ViewModelStoreOwner = activityOwner ?: LocalViewModelStoreOwner.current
<span class="keyword">val</span> vm: ChatViewModel = viewModel(viewModelStoreOwner = owner, factory = factory)
	</div>

<p><strong>Efecto:</strong> El ViewModel sobrevive a navegaci√≥n entre pantallas (Login ‚Üí Chat)</p>

<h3>4. Single Source of Truth</h3>

<div class="diagram-container">
	<div class="mermaid">
graph TD
    A[ChatUiState en ViewModel] -->|"√∫nica fuente"| B[ChatScreen observa]
    A -->|"√∫nica fuente"| C[Otros Composables]
    A -->|"√∫nica fuente"| D[Di√°logos]
    
    E[Usuario modifica] --> F[vm.setX]
    F --> G[_ui.update]
    G --> A
    
    style A fill:#4CAF50
    style G fill:#FF9800
	</div>
</div>

<p><strong>Beneficios:</strong></p>
<ul>
	<li>‚úÖ Estado consistente en toda la UI</li>
	<li>‚úÖ No hay sincronizaci√≥n manual</li>
	<li>‚úÖ Testeable f√°cilmente</li>
	<li>‚úÖ Debug simplificado</li>
</ul>

<h3>5. Coroutines + StateFlow</h3>

<div class="code-snippet">
<span class="comment">// StateFlow para estado reactivo</span>
<span class="keyword">private val</span> _ui = MutableStateFlow(ChatUiState())
<span class="keyword">val</span> ui: StateFlow&lt;ChatUiState&gt; = _ui

<span class="comment">// Coroutines para operaciones as√≠ncronas</span>
<span class="keyword">fun</span> <span class="type">sendMessage</span>(text: String) {
    viewModelScope.launch {  <span class="comment">// ‚úÖ Se cancela con ViewModel</span>
        <span class="keyword">when</span> (<span class="keyword">val</span> result = repo.sendMessage(text)) {
            <span class="keyword">is</span> Result.Success -> applyEnvelope(result.data)
            <span class="keyword">is</span> Result.Error -> _ui.update { it.copy(error = result.message) }
        }
    }
}
	</div>

<p><strong>Por qu√© StateFlow:</strong></p>
<ul>
	<li>‚úÖ Hot stream (siempre tiene valor inicial)</li>
	<li>‚úÖ Conflation (solo √∫ltimo valor importa)</li>
	<li>‚úÖ Integraci√≥n perfecta con Compose</li>
	<li>‚úÖ Lifecycle-aware con collectAsState()</li>
</ul>

<hr>

<h2>üìä M√©tricas Finales</h2>

<div class="stats-box">
	<table>
		<thead>
			<tr>
				<th>M√©trica</th>
				<th>Valor</th>
			</tr>
		</thead>
		<tbody>
			<tr><td>Estados en ChatUiState</td><td><strong>38</strong></td></tr>
			<tr><td>Estados locales justificados</td><td><strong>7</strong></td></tr>
			<tr><td>L√≠neas ChatViewModel</td><td><strong>636</strong></td></tr>
			<tr><td>L√≠neas ChatScreen (orquestador)</td><td><strong>1,355</strong></td></tr>
			<tr><td>Componentes modulares</td><td><strong>6</strong> (forms + components)</td></tr>
			<tr><td>Total l√≠neas modularizadas</td><td><strong>1,253</strong> (en 6 archivos)</td></tr>
			<tr><td>Reducci√≥n vs monolito</td><td><strong>36%</strong></td></tr>
			<tr><td>Commits de desarrollo</td><td><strong>18</strong></td></tr>
			<tr><td>Errores de compilaci√≥n</td><td><strong>0</strong></td></tr>
			<tr><td>Cobertura MVVM</td><td><strong>86%</strong> (pragm√°tico)</td></tr>
			<tr><td>Arquitectura</td><td><strong>‚úÖ MVVM + Modular</strong></td></tr>
		</tbody>
	</table>
</div>

<hr>

<div class="success-box" style="text-align: center; padding: 30px;">
	<h2 style="color: #4CAF50; margin-top: 0;">‚úÖ Arquitectura MVVM Modular Implementada</h2>
	<p style="font-size: 16px;">
		<strong>AcademiaAPP</strong> sigue las mejores pr√°cticas de Android con Jetpack Compose,<br>
		implementando una arquitectura MVVM s√≥lida, modular, testeable y mantenible.
	</p>
	<p style="margin-top: 20px;">
		<span class="architecture-badge">MVVM</span>
		<span class="architecture-badge">Clean Architecture</span>
		<span class="architecture-badge">Repository Pattern</span>
		<span class="architecture-badge">Unidirectional Data Flow</span>
		<span class="architecture-badge">Component Architecture</span>
	</p>
</div>

<hr>

<p style="text-align: center; color: #757575; margin-top: 40px;">
	<strong>Documento generado el 24 de noviembre de 2025</strong><br>
	Parte del TFG FP DAM - Sistema de Gesti√≥n de Academias<br>
	Autor: √Ångel Fern√°ndez Vidal
</p>

</body>
</html>