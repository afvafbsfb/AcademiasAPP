# Modelo de Datos - Sistema Academia

## Diagrama Entidad-Relación (Notación Crow's Foot)

Este diagrama representa el modelo completo de la base de datos del sistema de gestión de academias.

**Leyenda de Cardinalidades:**
- `||--||` : Uno a uno
- `||--o{` : Uno a muchos (opcional del lado "o")
- `||--|{` : Uno a muchos (obligatorio)
- `}o--o{` : Muchos a muchos (opcional)
- `}|--|{` : Muchos a muchos (obligatorio)

```mermaid
erDiagram
    %% ========================================
    %% MÓDULO CORE - ACADEMIA Y CONFIGURACIÓN
    %% ========================================
    
    Academia ||--o{ Tarifa : tiene
    Academia ||--o{ Aula : posee
    Academia ||--o{ Curso : ofrece
    Academia ||--o{ Usuario : emplea
    Academia ||--o{ Alumno : matricula
    Academia ||--o{ TrabajadorVirtual : "utiliza IA"
    
    Tarifa ||--o{ Descuentos_tarifa : aplica
    Tarifa ||--o{ Curso : "define precio"
    Tarifa ||--o{ Inscripcion : "se cobra en"
    
    Academia {
        int id PK
        varchar nombre UK
        datetime fecha_alta
        datetime fecha_baja
        datetime fecha_ultima_modificacion
        int usuario_id_ultima_modificacion FK
    }
    
    Tarifa {
        int id PK
        int academia_id FK
        varchar descripcion
        float precio_base
        datetime fecha_alta
        datetime fecha_baja
        datetime fecha_ultima_modificacion
    }
    
    Descuentos_tarifa {
        int id PK
        int tarifa_id FK
        char motivo_descuento "F=Familiar, M=Mensual"
        char tipo_descuento "P=Porcentaje, F=Fijo"
        float porcentaje_descuento
        float importe_descuento
    }
    
    Aula {
        int id PK
        int academia_id FK
        varchar nombre
        int capacidad_maxima
    }
    
    %% ========================================
    %% MÓDULO USUARIOS Y SEGURIDAD
    %% ========================================
    
    Rol_Usuario ||--o{ Usuario : asigna
    Usuario ||--o{ Curso_Profesores : imparte
    Usuario ||--o{ UserLoginLog : registra
    Usuario ||--o{ RefreshToken : "genera tokens"
    Usuario ||--o{ PasswordResetToken : "solicita reset"
    
    Rol_Usuario {
        int id PK
        varchar nombre UK "Admin_plataforma, Admin_academia, Profesor_academia"
    }
    
    Usuario {
        int id PK
        int academia_id FK
        varchar nombre
        varchar email UK
        varchar password "Hash Argon2"
        int rol_id FK
        enum estado "Activo, Bloqueado, Baja"
        datetime fecha_alta
        datetime fecha_baja
        datetime fecha_ultima_modificacion
        int token_version "Para revocación masiva"
        int failed_login_count
        datetime last_failed_login_at
        datetime locked_until
    }
    
    UserLoginLog {
        bigint id PK
        int usuario_id FK
        datetime login_at
        datetime logout_at
        boolean success
        varchar fail_reason
        varbinary ip "IPv4/IPv6"
        varchar user_agent
        varchar device_id
        varchar client "web, android, ios"
    }
    
    RefreshToken {
        bigint id PK
        int usuario_id FK
        char token_hash "SHA-256"
        datetime issued_at
        datetime expires_at "30 días"
        datetime revoked_at
        bigint replaced_by_id FK "Rotación"
        varbinary ip
        varchar user_agent
        varchar device_id
        varchar scope
    }
    
    RefreshToken }o--|| RefreshToken : "reemplaza a"
    
    PasswordResetToken {
        bigint id PK
        int usuario_id FK
        char token_hash "SHA-256"
        datetime expires_at
        datetime used_at
        varbinary ip
        varchar user_agent
    }
    
    %% ========================================
    %% MÓDULO ACADÉMICO - CURSOS Y HORARIOS
    %% ========================================
    
    Curso ||--o{ HorarioCurso : "tiene horarios"
    Curso ||--o{ Curso_Profesores : asignado
    Curso ||--o{ Inscripcion : matricula
    
    Aula ||--o{ HorarioCurso : "se imparte en"
    HorarioCurso ||--o{ Sesion : "genera clases"
    
    Curso_Profesores ||--o{ Sesion : imparte
    
    Curso {
        int id PK
        int academia_id FK
        varchar nombre
        varchar anio_academico "2024-2025"
        date fecha_inicio
        date fecha_fin
        boolean acepta_nuevos_alumnos
        int capacidad_maxima
        int tarifa_id FK
        enum tipo_alumno "Infantil, Juvenil, Adultos"
        enum estado "Activo, Inactivo, Finalizado"
    }
    
    HorarioCurso {
        int id PK
        int curso_id FK
        int aula_id FK
        varchar dia_semana "Lunes, Martes..."
        time hora_inicio
        time hora_fin
    }
    
    Curso_Profesores {
        int id PK
        int curso_id FK
        int usuario_id FK
        datetime fecha_alta
        datetime fecha_baja
        datetime fecha_ult_modificacion
        varchar motivo_baja
    }
    
    Sesion {
        int id PK
        int horario_curso_id FK
        int aula_id FK
        int curso_profesor_id FK
        datetime timestamp_alta "Hora de inicio real"
        time hora_inicio "Hora planificada"
        time hora_fin "Hora planificada"
        datetime timestamp_baja "Hora de fin real"
        varchar motivo_baja
        text notas_sesion "Observaciones generales"
        text notas_materia "Contenido impartido"
    }
    
    %% ========================================
    %% MÓDULO ALUMNOS
    %% ========================================
    
    Alumno ||--o{ Inscripcion : "se matricula en"
    Alumno ||--o{ AnotacionesAlumnoSesion : recibe
    Alumno }o--o{ Alumno : "familiar de"
    
    Inscripcion ||--o{ AnotacionesAlumnoSesion : "genera anotaciones"
    Inscripcion ||--o{ Extractos : "tiene estados cuenta"
    
    Sesion ||--o{ AnotacionesAlumnoSesion : registra
    
    Alumno {
        int id PK
        int academia_id FK
        varchar nombre
        varchar email UK
        varchar dni
        varchar telefono
        date fecha_nacimiento
        varchar direccion
        varchar nombre_tutor
        varchar relaccion_tutor_alumno
        varchar telefono_tutor
        varchar email_tutor
    }
    
    Inscripcion {
        int id PK
        int alumno_id FK
        int curso_id FK
        int tarifa_id FK
        date fecha_inicio
        date fecha_fin
        varchar motivo_baja
    }
    
    familias_alumnos {
        int id_familia_alumno PK
        int id_alumno1 FK
        int id_alumno2 FK
        varchar relacion_familiar "Hermano, Primo..."
    }
    
    AnotacionesAlumnoSesion {
        int id PK
        int sesion_id FK
        int inscripcion_id FK
        int curso_id FK
        int curso_profesor_id FK
        int alumno_id FK
        enum tipo_anotacion "Ausencia, Evaluacion, Comportamiento"
        varchar texto
        datetime timestamp_alta
        datetime timestamp_baja
        varchar motivo_baja
    }
    
    %% ========================================
    %% MÓDULO FINANCIERO
    %% ========================================
    
    Extractos ||--o{ Movimientos_Extracto : contiene
    
    Extractos {
        int id PK
        int inscripcion_id FK
        int curso_id FK
        int alumno_id FK
        int numero_extracto
        float saldo_ingreso_cuenta_anterior
        enum estado_liquidacion_extracto "1=Pendiente, 2=Liquidado"
        datetime fecha_alta
        date fecha_ini_periodo
        date fecha_fin_periodo
        int id_dcto_tarifa_1 FK
        varchar motivo_dcto1
        char tipo_dcto_1
        float porcentaje_dcto_1
        float importe_descuento_1
        int id_dcto_tarifa_2 FK
        varchar motivo_dcto2
        char tipo_dcto_2
        float porcentaje_dcto_2
        float importe_descuento_2
        int id_dcto_tarifa_3 FK
        varchar motivo_dcto3
        char tipo_dcto_3
        float porcentaje_dcto_3
        float importe_descuento_3
        float importe_cuota
        float total_descuentos
        float importe_cuota_mensual_sin_descuentos
        float importe_cuota_mensual_con_descuentos
        float importe_exceso_ingresos
        float total_importe_a_cobrar
    }
    
    Movimientos_Extracto {
        int id PK
        int inscripcion_id FK
        int curso_id FK
        int alumno_id FK
        int extracto_id FK
        date fecha_movimiento
        enum tipo_movimiento "Ingreso, Anulacion_Ingreso"
        enum estado_liquidacion_movimiento "1=Pendiente, 2=Cobrado"
        float importe
        varchar descripcion_movimiento
        varchar metodo_pago "Efectivo, Tarjeta, Transferencia"
        enum indicador_movimiento_anulado "S=Anulado, N=No Anulado"
    }
    
    %% ========================================
    %% MÓDULO AUTOMATIZACIÓN (FUTURO)
    %% ========================================
    
    TrabajadorVirtual {
        int id PK
        int academia_id FK
        varchar nombre
        varchar foto "URL imagen"
        text descripcion
        varchar apikey
        boolean es_administrativo_virtual
    }
```

---

## Resumen de Relaciones Principales

### Multi-tenancy (Aislamiento por Academia)
- Todas las entidades principales están vinculadas a `Academia`
- Filtrado automático por `academia_id` en todas las consultas
- Permite múltiples academias en una misma base de datos

### Seguridad y Autenticación
- `Usuario` → `Rol_Usuario`: Define permisos (Admin_plataforma, Admin_academia, Profesor_academia)
- `Usuario` → `RefreshToken`: Gestión de sesiones con rotación automática
- `Usuario` → `UserLoginLog`: Auditoría completa de accesos
- `token_version` en Usuario: Permite revocación masiva de tokens

### Flujo Académico Principal
```
Academia → Curso → HorarioCurso → Sesion → AnotacionesAlumnoSesion
                ↓                    ↓
            Inscripcion          Asistencia
                ↓
            Alumno
```

### Flujo Financiero
```
Alumno → Inscripcion → Extractos → Movimientos_Extracto
           ↓              ↓
        Tarifa      Descuentos aplicados
```

### Relaciones Familiares
- Tabla `familias_alumnos` permite registrar relaciones entre alumnos (hermanos, primos)
- Útil para aplicar descuentos familiares automáticos

---

## Índices y Constraints Importantes

### Claves Únicas (UK)
- `Academia.nombre`: Un nombre único por academia
- `Usuario.email`: Email único en todo el sistema
- `Alumno.email`: Email único de alumno
- `Rol_Usuario.nombre`: Roles únicos

### Claves Foráneas (FK)
- Todas las relaciones están respaldadas por constraints FK
- `ON DELETE` y `ON UPDATE` configurados según lógica de negocio
- Integridad referencial garantizada

### Campos de Auditoría
- `fecha_alta`: Timestamp de creación (DEFAULT CURRENT_TIMESTAMP)
- `fecha_baja`: Soft delete (NULL = activo)
- `fecha_ultima_modificacion`: Actualización automática (ON UPDATE CURRENT_TIMESTAMP)
- `usuario_id_ultima_modificacion`: Trazabilidad de cambios

---

## Características Avanzadas

### Soft Delete
Tablas con baja lógica (no se eliminan físicamente):
- Academia
- Usuario
- Inscripcion
- Sesion
- AnotacionesAlumnoSesion

### Rotación de Tokens
- `RefreshToken.replaced_by_id` → Auto-referencia para cadena de rotación
- Previene reutilización de tokens antiguos

### Anti-Fuerza Bruta
- `Usuario.failed_login_count`: Contador de intentos fallidos
- `Usuario.locked_until`: Bloqueo temporal tras N intentos

### Descuentos Múltiples
- Cada extracto puede tener hasta 3 descuentos simultáneos
- Cálculo automático de cuota con descuentos aplicados

---

**Versión del Modelo:** 1.0.0  
**Fecha:** 24 de octubre de 2025  
**Fuente:** `create_database.sql`  
**Total de Tablas:** 26  
**Motor:** MySQL 8.0 / InnoDB  
**Charset:** utf8mb4 / utf8mb4_unicode_ci
